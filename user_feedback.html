<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TeamGalaxy — Share Praise</title>
  <style>
    :root{--bg:#0f1724;--card:#0b1220;--accent:#7c3aed;--muted:#94a3b8;--glass:rgba(255,255,255,0.03)}
    html,body{height:100%;margin:0;font-family:Inter, ui-sans-serif, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial}
    body{display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg,#021226 0%, #071331 100%);color:#e6eef8;padding:24px}
    .card{width:100%;max-width:760px;background:var(--card);border-radius:12px;padding:28px;box-shadow:0 8px 30px rgba(2,6,23,0.6);}.card a{color:inherit}
    h1{margin:0 0 6px;font-size:20px}
    p.small{margin:0 0 18px;color:var(--muted)}
    label{display:block;font-size:13px;margin-bottom:6px;color:var(--muted)}
    input[type=number],textarea{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:var(--glass);color:inherit;outline:none}
    textarea{min-height:120px;resize:vertical}
    .controls{display:flex;gap:8px;align-items:center;margin-top:12px}
    button{background:var(--accent);border:none;color:white;padding:10px 14px;border-radius:10px;cursor:pointer}
    button[disabled]{opacity:0.5;cursor:not-allowed}
    .meta{font-size:13px;color:var(--muted);margin-top:10px}
    .success{background:linear-gradient(90deg,#047857,#059669);padding:10px;border-radius:8px;margin-top:10px;color:white}
    .error{background:linear-gradient(90deg,#b91c1c,#ef4444);padding:10px;border-radius:8px;margin-top:10px;color:white}
    .small-muted{font-size:12px;color:var(--muted)}
    .rating-stars{display:inline-flex;gap:6px}
    .star{cursor:pointer;font-size:20px;opacity:0.7}
    .star.active{color:gold;opacity:1}
    .signed {font-size:13px;color:#cfe9ff;margin-top:8px}
    .anon-encourage{font-size:12px;color:var(--muted);margin-left:8px}
    footer.note{margin-top:14px;font-size:13px;color:var(--muted)}
  </style>
</head>
<body>
  <div class="card" role="main">
    <h1>Share some praise ✨</h1>
    <p class="small">Got something you liked? Leave a short praise — anonymous or signed. Note: this is not a support channel; the team won't reply from here.</p>

    <div id="signedInfo" class="signed" style="display:none">
      Signed in as <strong id="signedName">—</strong>
      <span class="anon-encourage" id="anonHint" style="display:none">• You can choose to submit anonymously, but we encourage leaving your name so the team knows who sent it.</span>
    </div>

    <form id="praiseForm" autocomplete="off">
      <div style="margin-top:8px">
        <label>Category</label>
        <div style="padding:10px;border-radius:8px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.02);">
          <strong>Praise</strong>
        </div>
      </div>

      <div style="margin-top:12px">
        <label for="rating">Rating</label>
        <div id="rating" style="display:flex;gap:6px;align-items:center">
          <div class="rating-stars" id="stars" aria-hidden="true"></div>
          <input type="number" id="ratingValue" min="1" max="5" value="5" style="width:56px;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:var(--glass);color:inherit"/>
        </div>
      </div>

      <div style="margin-top:12px">
        <label for="message">Message</label>
        <textarea id="message" placeholder="Write your praise (min 20 characters) — keep it positive!" required minlength="20"></textarea>
      </div>

      <div style="margin-top:10px;display:flex;align-items:center;gap:10px">
        <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
          <input type="checkbox" id="isAnon" /> <span class="small-muted" id="isAnonLabel">Submit anonymously</span>
        </label>
        <div id="anonInfo" class="small-muted" style="margin-left:auto">Default: <span id="defaultMode">Anonymous</span></div>
      </div>

      <div class="controls">
        <button id="submitBtn" type="submit">Send Praise</button>
        <div class="meta">Ref: <span id="refPreview">—</span></div>
      </div>

      <div id="messageBox" aria-live="polite"></div>
    </form>

    <footer class="note">We collect only minimal data to improve the product (no screenshots). Praise is anonymous by default for guests; signed users are encouraged to attach identity but can still opt to hide it.</footer>
  </div>

  <script type="module">
    // ----------------- YOUR FIREBASE CONFIG (from your message) -----------------
    const firebaseConfig = {
      apiKey: "AIzaSyD0Yv_bQjxi2_kjzPR4XHOlaB7Sb6NRVUc",
      authDomain: "teamgalaxy-77344.firebaseapp.com",
      projectId: "teamgalaxy-77344",
      storageBucket: "teamgalaxy-77344.firebasestorage.app",
      messagingSenderId: "770256225320",
      appId: "1:770256225320:web:5a363ebd757de6cde3a11d",
      measurementId: "G-6C2W9NSNCH"
    };
    // --------------------------------------------------------------------------

    // Firebase SDK v11.9.0 (modular)
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.9.0/firebase-app.js';
    import { getFirestore, collection, addDoc, serverTimestamp, updateDoc } from 'https://www.gstatic.com/firebasejs/11.9.0/firebase-firestore.js';
    import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/11.9.0/firebase-auth.js';

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // persistent clientId (localStorage)
    function getClientId() {
      const key = 'teamgalaxy:clientId:v1';
      let id = localStorage.getItem(key);
      if (!id) {
        if (crypto && typeof crypto.randomUUID === 'function') id = crypto.randomUUID();
        else id = 'cid-' + Math.floor(Math.random()*1e9).toString(36) + '-' + Date.now().toString(36);
        localStorage.setItem(key, id);
      }
      return id;
    }

    // SHA-256 digest helper (returns hex)
    async function digestUTF8(message) {
      const enc = new TextEncoder();
      const data = enc.encode(message);
      const hash = await crypto.subtle.digest('SHA-256', data);
      return Array.from(new Uint8Array(hash)).map(b => b.toString(16).padStart(2,'0')).join('');
    }

    // fingerprint: userAgent + platform + timezone + clientId (hashed)
    async function getFingerprint() {
      try {
        const clientId = getClientId();
        const f = [
          navigator.userAgent || '',
          navigator.platform || '',
          Intl.DateTimeFormat().resolvedOptions().timeZone || '',
          clientId
        ].join('||');
        return await digestUTF8(f);
      } catch (e) {
        return null;
      }
    }

    function shortRefFromId(id) {
      return `FB-${(new Date()).toISOString().slice(0,10).replace(/-/g,'')}-${id.slice(0,6).toUpperCase()}`;
    }

    // Stars UI
    const starsWrap = document.getElementById('stars');
    const ratingValue = document.getElementById('ratingValue');
    function renderStars(n){
      starsWrap.innerHTML = '';
      for(let i=1;i<=5;i++){
        const s = document.createElement('span');
        s.className = 'star' + (i<=n ? ' active' : '');
        s.textContent = '★';
        s.dataset.value = i;
        s.addEventListener('click', ()=>{ ratingValue.value = i; renderStars(i); });
        starsWrap.appendChild(s);
      }
    }
    renderStars(parseInt(ratingValue.value,10) || 5);
    ratingValue.addEventListener('input', ()=>{
      let v = parseInt(ratingValue.value,10);
      if (isNaN(v) || v<1) v=1; if (v>5) v=5; ratingValue.value = v; renderStars(v);
    });

    // Form wiring
    const form = document.getElementById('praiseForm');
    const submitBtn = document.getElementById('submitBtn');
    const messageBox = document.getElementById('messageBox');
    const refPreview = document.getElementById('refPreview');
    const isAnonCheckbox = document.getElementById('isAnon');
    const signedInfo = document.getElementById('signedInfo');
    const signedName = document.getElementById('signedName');
    const anonHint = document.getElementById('anonHint');
    const defaultModeLabel = document.getElementById('defaultMode');

    let currentUser = null;
    let signedDefaultAnon = true; // will be updated on auth change

    onAuthStateChanged(auth, (u) => {
      currentUser = u;
      if (u) {
        // user signed in -> default to NOT anonymous (encourage identity)
        signedDefaultAnon = false;
        signedInfo.style.display = 'block';
        signedName.textContent = u.displayName || (u.email ? u.email.split('@')[0] : u.uid.slice(0,6));
        anonHint.style.display = 'inline';
        isAnonCheckbox.checked = false; // default: not anonymous
        defaultModeLabel.textContent = 'Signed (recommended)';
      } else {
        // guest -> default anonymous
        signedDefaultAnon = true;
        signedInfo.style.display = 'none';
        anonHint.style.display = 'none';
        isAnonCheckbox.checked = true;
        defaultModeLabel.textContent = 'Anonymous';
      }
    });

    function showMessage(text, type='ok'){
      messageBox.innerHTML = '';
      const div = document.createElement('div');
      div.className = type === 'ok' ? 'success' : 'error';
      div.textContent = text;
      messageBox.appendChild(div);
    }

    let isSubmitting = false;

    form.addEventListener('submit', async (ev)=>{
      ev.preventDefault();
      if (isSubmitting) return;
      isSubmitting = true; submitBtn.disabled = true; messageBox.innerHTML = '';

      const rating = parseInt(document.getElementById('ratingValue').value, 10) || 5;
      const message = document.getElementById('message').value.trim();
      const wantsAnon = isAnonCheckbox.checked;

      if (message.length < 20) { showMessage('Message is too short — please write at least 20 characters.', 'err'); isSubmitting=false; submitBtn.disabled=false; return; }

      try {
        const fingerprint = await getFingerprint();
        const clientId = getClientId();

        // If user is signed-in AND did NOT choose anonymous, attach their uid/displayName.
        // Otherwise store null for userId/displayName (anonymous).
        const authorId = (currentUser && !wantsAnon) ? currentUser.uid : null;
        const authorName = (currentUser && !wantsAnon) ? (currentUser.displayName || null) : null;

        const payload = {
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp(),
          rating: rating,
          category: 'praise',
          message: message,
          status: 'closed_as_praise', // indicates praise-only (no reply)
          visible: true,
          clientId: clientId,
          fingerprint: fingerprint,
          clientLocale: navigator.language || null,
          userId: authorId,
          displayName: authorName,
          anonymousSubmission: !!wantsAnon
        };

        const col = collection(db, 'feedback');
        const docRef = await addDoc(col, payload);

        // Generate friendly refId and write back
        const refId = shortRefFromId(docRef.id);
        await updateDoc(docRef, { refId, updatedAt: serverTimestamp() });

        refPreview.textContent = refId;
        showMessage(`Thanks! Your praise is received — reference ${refId}.`, 'ok');
        form.reset(); renderStars(5); ratingValue.value = 5;

        // After reset, restore default anon state according to sign-in
        isAnonCheckbox.checked = signedDefaultAnon;

      } catch (err) {
        console.error('Submission failed', err);
        showMessage('Submission failed. Please try again later.', 'err');
      } finally {
        isSubmitting = false; submitBtn.disabled = false;
      }
    });

    // initial preview ref using clientId
    (function(){
      const fake = getClientId().slice(0,6).toUpperCase();
      refPreview.textContent = `FB-${new Date().toISOString().slice(0,10).replace(/-/g,'')}-${fake}`;
      // initial default checkbox state
      isAnonCheckbox.checked = true;
    })();
  </script>
</body>
</html>