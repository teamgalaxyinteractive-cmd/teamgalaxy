<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Profile - TeamGalaxy</title>
  <style>
  /* Reset + base */
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  }

  html, body {
    width: 100%;
    overflow-x: hidden;
  }

  body {
    background: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
    color: #e0e0ff;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    position: relative;
    overflow-x: hidden;
  }

  @font-face {
    font-family: 'Sefa Regular';
    src: url('../assets/fonts/Sefa-Regular.woff2') format('woff2'),
         url('../assets/fonts/Sefa-Regular.woff') format('woff');
    font-weight: normal;
    font-style: normal;
    font-display: swap;
  }

  .bg-layer {
    position: fixed;
    inset: 0;
    z-index: -2;
    background-position: center;
    background-size: cover;
    background-repeat: no-repeat;
    filter: brightness(0.55) saturate(0.9);
  }

  #bgStars {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: -1;
    pointer-events: none;
    display: block;
  }

  /* -------------------------------- */
  /*        CENTERED HEADER           */
  /* -------------------------------- */
  .header {
    display: flex;
    justify-content: center;      /* ‚≠ê centered */
    align-items: center;
    gap: 1rem;
    padding: 1rem 1rem;
    background: rgba(10, 10, 35, 0.95);
    backdrop-filter: blur(15px);
    border-bottom: 1px solid #5a4fcf;
    box-shadow: 0 4px 20px rgba(0,0,0,0.4);
    position: sticky;
    top: 0;
    z-index: 100;
    flex-wrap: wrap;
  }

  .logo {
    font-size: 2rem;
    font-weight: bold;
    letter-spacing: 1.5px;
    color: #8a7cff;
    background: linear-gradient(45deg, #8a7cff, #d66efd);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    cursor: pointer;
    text-align: center;
  }

  .header-buttons {
    display: flex;
    gap: 1rem;
    flex-wrap: nowrap;
    justify-content: center;
  }

  .btn {
    padding: 0.7rem 1.2rem;
    border-radius: 8px;
    border: 1px solid rgba(138, 124, 255, 0.3);
    background: rgba(20, 20, 40, 0.5);
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s ease;
    font-size: 0.95rem;
    color: #b1a6ff;
    backdrop-filter: blur(10px);
  }

  .btn:hover {
    background: rgba(30, 30, 60, 0.7);
    border-color: rgba(138,124,255,0.6);
    box-shadow: 0 0 15px rgba(138,124,255,0.2);
  }

  .container {
    max-width: 1200px;
    margin: 2rem auto;
    padding: 0 1rem;
    flex: 1;
    width: calc(100% - 2rem);
  }

  .profile-card {
    background: rgba(20,20,40,0.85);
    border-radius: 20px;
    padding: 3rem;
    box-shadow: 0 15px 35px rgba(0,0,0,0.4);
    border: 1px solid #5a4fcf;
    backdrop-filter: blur(10px);
    margin-bottom: 2rem;
    width: 100%;
    position: relative;
    overflow: hidden;
  }

  .profile-header {
    display: flex;
    flex-direction: column; /* ‚≠ê make entire header centered vertically */
    align-items: center;    /* ‚≠ê center */
    gap: 1.5rem;
    margin-bottom: 2.5rem;
  }

  .profile-photo {
    width: 150px;
    height: 150px;
    border-radius: 50%;
    object-fit: cover;
    border: 4px solid #6a5af9;
    background: linear-gradient(45deg, #6a5af9, #d66efd);
    box-shadow: 0 0 20px rgba(106,90,249,0.3);
  }

  /* -------------------------------- */
  /*  CENTERED PROFILE TEXT + SLUG    */
  /* -------------------------------- */
  .profile-info {
    flex: 1 1 auto;
    min-width: 0;
    text-align: center;               /* ‚≠ê CENTERED */
  }

  .profile-name {
    font-size: 2.5rem;
    font-weight: bold;
    color: #fff;
    margin-bottom: 0.5rem;
    word-break: break-word;
  }

  .profile-slug {
    font-size: 1.3rem;
    color: #b1a6ff;
    margin-bottom: 1rem;
    display: inline-flex;             /* ‚≠ê inline-flex for perfect centering */
    gap: 0.5rem;
    align-items: center;
    justify-content: center;          /* ‚≠ê centered */
    flex-wrap: wrap;
  }

  .verified-badge {
    background: linear-gradient(45deg, #6a5af9, #d66efd);
    color: white;
    padding: 0.3rem 1rem;
    border-radius: 20px;
    font-size: 1rem;
    font-weight: bold;
    box-shadow: 0 0 10px rgba(106,90,249,0.3);
  }

  .join-date, .email {
    color: #a0a0d0;
    font-size: 1.1rem;
  }

  .profile-actions {
    position: absolute;
    top: 2rem;
    right: 1.5rem;
  }

  .btn-share {
    padding: 0.6rem 1.1rem;
    border-radius: 8px;
    border: 1px solid rgba(138,124,255,0.3);
    background: rgba(20,20,40,0.5);
    color: #b1a6ff;
    font-size: 0.95rem;
    font-weight: 600;
    cursor: pointer;
  }

  .bio-section {
    margin: 2.5rem 0;
  }

  .section-title {
    font-size: 1.5rem;
    font-weight: 600;
    color: #d0c4ff;
    margin-bottom: 1.5rem;
    border-bottom: 2px solid #5a4fcf;
    padding-bottom: 0.8rem;
    text-align: center;          /* ‚≠ê Titles centered */
  }

  .bio-text {
    line-height: 1.7;
    color: #c0c0e0;
    font-size: 1.15rem;
    text-align: center;          /* ‚≠ê Center bio too */
  }

  .profile-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px,1fr));
    gap: 2rem;
  }

  .stat-card {
    background: rgba(40,40,70,0.6);
    padding: 2rem;
    border-radius: 15px;
    text-align: center;
    border: 1px solid #5a4fcf;
  }

  .stat-value {
    font-size: 2.5rem;
    font-weight: bold;
    color: #8a7cff;
  }

  .stat-label {
    font-size: 1.1rem;
    color: #b1a6ff;
  }

  .posts-section {
    background: rgba(20,20,40,0.85);
    border-radius: 20px;
    padding: 3rem;
    border: 1px solid #5a4fcf;
    margin-bottom: 2rem;
  }

  .posts-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 2rem;
  }

  .post-card {
    background: rgba(30,30,50,0.7);
    border-radius: 15px;
    padding: 1.8rem;
    border: 1px solid #5a4fcf;
  }

  .post-title {
    font-size: 1.4rem;
    font-weight: 600;
    color: #fff;
    margin-bottom: 0.8rem;
  }

  .post-body {
    color: #c0c0e0;
    line-height: 1.6;
  }

  .post-meta {
    display: flex;
    justify-content: space-between;
    color: #a0a0d0;
    padding-top: 1rem;
    border-top: 1px solid #4a4a8a;
    flex-wrap: wrap;
    gap: 0.5rem;
  }

  .comments-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 1.5rem;
  }

  .comment-card {
    background: rgba(40,40,60,0.6);
    border-radius: 12px;
    padding: 1.2rem;
    border: 1px solid #4a4a8a;
  }

  .post-actions {
    display: flex;
    gap: 1rem;
    justify-content: center;
    margin-top: 2rem;
  }

  .btn-post {
    padding: 0.9rem 2rem;
    border-radius: 8px;
    border: 1px solid rgba(138,124,255,0.3);
    background: rgba(20,20,40,0.5);
    cursor: pointer;
    color: #b1a6ff;
  }

  .footer {
    background: rgba(10,10,35,0.95);
    padding: 2.5rem 1rem 2rem;
    margin-top: 3rem;
    border-top: 1px solid #5a4fcf;
  }

  .footer-content {
    max-width: 1200px;
    margin: 0 auto;
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 3rem;
  }

  .rocket-text {
    text-align: center;
  }

  @media (max-width: 768px) {
    .header {
      flex-direction: column;
    }
    .profile-card {
      padding: 2rem 1.5rem;
    }
    .posts-section {
      padding: 2rem 1.5rem;
    }
    .profile-photo {
      width: 120px;
      height: 120px;
    }
  }
</style>
</head>
<body>  
  <!-- Background image layer: edit style attribute or add class with background-image in CSS -->  
  <div class="bg-layer" style="background-image: url('https://dl.dropboxusercontent.com/scl/fi/6vctg6446bxpsb3adeixf/IMG_20251124_201705.jpg?rlkey=wrhhx0n6w04cy4aw5b6gkhj85&st=bn4uv550&dl=0');"></div>    <!-- Star canvas over the background image -->  <canvas id="bgStars" aria-hidden="true"></canvas>

  <!-- Loading Overlay -->    <div class="loading-overlay" id="loadingOverlay">  
    <div class="loading-message">Building your profile, wait for a second...</div>  
    <div class="stars-container" id="starsContainer"></div>  
  </div>    <!-- Header -->    <header class="header">  
 <div   
        class="logo"   
        onclick="window.location.href='../dashboard.html'"   
        style="  
            cursor: pointer;  font-family: 'Sefa Regular', sans-serif;   
        font-size: 2.5em;   
        font-weight: bold;  
        color: #ccf381; /* Neon color */  
        letter-spacing: 3px;  
    "  
>  
    GalaxyWeb  
</div>  
<div class="header-buttons">  
  <button class="btn btn-settings">Settings</button>  
  <button class="btn btn-logout">Log Out</button>  
</div>

  </header>    <!-- Main Content -->    <div class="container">  
    <div id="profile-content">  
      <div class="loading">Loading profile...</div>  
    </div>  
    <div id="posts-section"></div>  
  </div>    <!-- Footer -->    <footer class="footer">  
    <div class="footer-content">  
      <div class="footer-left">  
        <div class="footer-about-title">About TeamGalaxy</div>  
        <div class="footer-about-text">  
          TeamGalaxy is an innovative gaming and creative community, united by passion and the spirit of collaboration. We host tournaments, share design ideas, and grow talents together ‚Äî join now to explore the Galaxy!  
        </div>  
      </div>  
      <div class="footer-right">  
        <div class="footer-links">  
          <a href="../legal/privacy_policy.html">Privacy Policy</a>  
          <a href="../legal/terms_and_conditions.html">Terms & Conditions</a>  
          <a href="../about_us.html">About</a>  
        </div>  
        <div class="rocket-frame">  
          <div class="rocket-text">üöÄ ROCKET   üöÄ</div>
</div>
</div>
</div>

  </footer>  
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-auth.js";
  import { getFirestore, doc, getDoc, collection, query, where, orderBy, limit, getDocs } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-firestore.js";

  // Firebase configuration
  const firebaseConfig = {
    apiKey: "AIzaSyD0Yv_bQjxi2_kjzPR4XHOlaB7Sb6NRVUc",
    authDomain: "teamgalaxy-77344.firebaseapp.com",
    projectId: "teamgalaxy-77344",
    storageBucket: "teamgalaxy-77344.firebasestorage.app",
    messagingSenderId: "770256225320",
    appId: "1:770256225320:web:5a363ebd757de6cde3a11d",
    measurementId: "G-6C2W9NSNCH"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // DOM Elements
  const loadingOverlay = document.getElementById('loadingOverlay');
  const profileContent = document.getElementById('profile-content');
  const postsSection = document.getElementById('posts-section');
  const logoutBtn = document.querySelector('.btn-logout');
  const settingsBtn = document.querySelector('.btn-settings');

  // Create stars for loading overlay (unchanged)
  function createLoadingStars() {
    const container = document.getElementById('starsContainer');
    container.innerHTML = '';
    for (let i = 0; i < 30; i++) {
      const star = document.createElement('div');
      star.classList.add('star');

      // Random position
      const x = Math.random() * 100;
      const y = Math.random() * 100;
      star.style.left = `${x}%`;
      star.style.top = `${y}%`;

      // Random size
      const size = Math.random() * 3 + 1;
      star.style.width = `${size}px`;
      star.style.height = `${size}px`;

      // Random animation duration
      const duration = Math.random() * 3 + 2;
      star.style.setProperty('--duration', `${duration}s`);

      container.appendChild(star);
    }
  }

  // Format date - FIXED
  function formatDate(dateValue) {
    if (!dateValue) return '';

    // Check if it's a Firestore Timestamp object
    if (dateValue && dateValue.seconds !== undefined) {
      const date = new Date(dateValue.seconds * 1000);
      return date.toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'long',
        day: 'numeric'
      });
    }
    // If it's already a Date object
    else if (dateValue instanceof Date) {
      return dateValue.toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'long',
        day: 'numeric'
      });
    }
    // If it's a string or number
    else {
      const date = new Date(dateValue);
      if (isNaN(date.getTime())) {
        return 'Invalid Date';
      }
      return date.toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'long',
        day: 'numeric'
      });
    }
  }

  // Format number (e.g., 1000 -> 1K)
  function formatNumber(num) {
    if (num >= 1000000) {
      return (num / 1000000).toFixed(1) + 'M';
    }
    if (num >= 1000) {
      return (num / 1000).toFixed(1) + 'K';
    }
    return num.toString();
  }

  // Time ago function - FIXED
  function timeAgo(dateValue) {
    if (!dateValue) return 'Just now';

    let date;
    // Check if it's a Firestore Timestamp object
    if (dateValue && dateValue.seconds !== undefined) {
      date = new Date(dateValue.seconds * 1000);
    }
    // If it's already a Date object
    else if (dateValue instanceof Date) {
      date = dateValue;
    }
    // If it's a string or number
    else {
      date = new Date(dateValue);
      if (isNaN(date.getTime())) {
        return 'Invalid Date';
      }
    }

    const now = new Date();
    const seconds = Math.floor((now - date) / 1000);

    let interval = seconds / 31536000;
    if (interval > 1) return Math.floor(interval) + ' years ago';
    interval = seconds / 2592000;
    if (interval > 1) return Math.floor(interval) + ' months ago';
    interval = seconds / 86400;
    if (interval > 1) return Math.floor(interval) + ' days ago';
    interval = seconds / 3600;
    if (interval > 1) return Math.floor(interval) + ' hours ago';
    interval = seconds / 60;
    if (interval > 1) return Math.floor(interval) + ' minutes ago';
    return Math.floor(seconds) + ' seconds ago';
  }

  // Load profile data - now accepts user object so we always have the UID
  async function loadProfile(user) {
    if (!user) {
      profileContent.innerHTML = '<div class="loading">Please log in to view your profile.</div>';
      return;
    }

    try {
      const docRef = doc(db, 'usersPrivate', user.uid);
      const docSnap = await getDoc(docRef);

      if (!docSnap.exists()) {
        profileContent.innerHTML = '<div class="loading">Profile not found.</div>';
        return;
      }

      const data = docSnap.data();
      // Pass the authenticated user's UID to renderProfile
      renderProfile(data, user.uid);
      await loadUserPosts(user.uid);
    } catch (error) {
      console.error('Error loading profile:', error);
      profileContent.innerHTML = '<div class="loading">Error loading profile.</div>';
    }
  }

  // Load user posts
  async function loadUserPosts(userId) {
    try {
      const q = query(
        collection(db, 'posts'),
        where('authorId', '==', userId),
        orderBy('createdAt', 'desc'),
        limit(3)
      );
      const querySnapshot = await getDocs(q);

      const posts = [];
      querySnapshot.forEach(doc => {
        posts.push({ id: doc.id, ...doc.data() });
      });

      renderPosts(posts);
    } catch (error) {
      console.error('Error loading posts:', error);
      postsSection.innerHTML = '<div class="loading">Error loading posts.</div>';
    }
  }

  // Render profile HTML
  // Now accepts userUid so we can attach it to the share URL reliably
  function renderProfile(data, userUid) {
    profileContent.innerHTML = `
      <div class="profile-card">
        <div class="profile-actions">
          <button class="btn-share" id="shareBtn">Share Profile</button>
        </div>
        
        <!-- Profile Header -->
        <div class="profile-header">
          <img src="${data.profilePhotoUrl || 'https://via.placeholder.com/150'}" alt="Profile Photo" class="profile-photo">
          <div class="profile-info">
            <h1 class="profile-name">${data.name || 'Unknown User'}</h1>
            <div class="profile-slug">${data.slug ? '@' + data.slug : ''}${data.verified ? '<span class="verified-badge">‚úì Verified</span>' : ''}</div>
            <div class="join-date">Joined: ${formatDate(data.joinDate)}</div>
            <div class="email">${data.email || ''}</div>
          </div>
        </div>

        <!-- Bio Section -->
        <div class="bio-section">
          <h2 class="section-title">Bio</h2>
          <p class="bio-text">${data.bio || 'No bio available.'}</p>
        </div>

        <!-- Stats Section -->
        <div class="profile-stats">
          <div class="stat-card">
            <div class="stat-value">${formatNumber(data.publicPostCount || 0)}</div>
            <div class="stat-label">Public Posts</div>
          </div>
        </div>
      </div>
    `;

    // Add share button functionality
    const shareBtn = document.getElementById('shareBtn');
    if (shareBtn) {
      shareBtn.addEventListener('click', async () => {
        // Ensure we have a UID from authenticated user
        if (!userUid) {
          alert('Unable to share profile: user not authenticated.');
          return;
        }

        // Build the share URL with UID attached exactly as ?={user.uid}
        const shareUrl = `https://teamgalaxyinteractive-cmd.github.io/teamgalaxy/public_data_manager/public_user_profile.html?=${encodeURIComponent(userUid)}`;

        // If Web Share API available, prefer it
        if (navigator.share) {
          try {
            await navigator.share({
              title: `${data.name || 'TeamGalaxy User'} - Profile`,
              text: `Check out this profile on TeamGalaxy:`,
              url: shareUrl
            });
            // Optionally notify user - Web Share API shows native UI already
          } catch (err) {
            // share() may throw if user cancels; fallback to clipboard
            console.warn('Navigator.share failed or cancelled:', err);
            try {
              await navigator.clipboard.writeText(shareUrl);
              alert('Profile URL copied to clipboard!');
            } catch (copyErr) {
              console.error('Failed to copy: ', copyErr);
              alert('Failed to share or copy URL. Please try again.');
            }
          }
        } else {
          // Fallback: copy to clipboard
          try {
            await navigator.clipboard.writeText(shareUrl);
            alert('Profile URL copied to clipboard!');
          } catch (err) {
            console.error('Failed to copy: ', err);
            alert('Failed to copy URL. Please try again.');
          }
        }
      });
    }
  }

  // Render posts HTML
  async function renderPosts(posts) {
    if (posts.length === 0) {
      postsSection.innerHTML = '<div class="loading">No posts found.</div>';
      return;
    }

    let postsHTML = `
      <div class="posts-section">
        <h2 class="section-title">Recent Posts</h2>
        <div class="posts-grid">
    `;

    for (const post of posts) {
      // Load comments for this post
      const commentsQuery = query(
        collection(db, 'posts', post.id, 'comments'),
        orderBy('createdAt', 'desc'),
        limit(3)
      );
      const commentsSnapshot = await getDocs(commentsQuery);

      const comments = [];
      commentsSnapshot.forEach(doc => {
        comments.push({ id: doc.id, ...doc.data() });
      });

      postsHTML += `
        <div class="post-card">
          <h3 class="post-title">${post.title || 'Untitled Post'}</h3>
          <p class="post-body">${post.body || 'No content available.'}</p>
          <div class="post-meta">
            <span class="post-author">By ${post.authorName || 'Anonymous'}</span>
            <span class="post-time">${timeAgo(post.createdAt)}</span>
          </div>
          <div class="post-meta">
            <span>üëç ${formatNumber(post.upvotesCount || 0)}</span>
            <span>üëé ${formatNumber(post.downvotesCount || 0)}</span>
            <span>üí¨ ${formatNumber(post.commentsCount || 0)}</span>
          </div>

          ${comments.length > 0 ? `
            <div class="comments-section">
              <h4>Recent Comments</h4>
              <div class="comments-grid">
                ${comments.map(comment => `
                  <div class="comment-card">
                    <div class="comment-header">
                      <span class="comment-author">${comment.authorName || 'Anonymous'}</span>
                      <span class="comment-time">${timeAgo(comment.createdAt)}</span>
                    </div>
                    <p class="comment-body">${comment.body || ''}</p>
                  </div>
                `).join('')}
              </div>
            </div>
          ` : ''}
        </div>
      `;
    }

    postsHTML += `
        </div>
        <div class="post-actions">
          <button class="btn-post" id="explore-btn">Explore</button>
          <button class="btn-post" id="show-all-btn">Show All Posts</button>
        </div>
      </div>
    `;

    postsSection.innerHTML = postsHTML;

    // Add event listeners for buttons
    document.getElementById('explore-btn').addEventListener('click', () => {
      window.location.href = '../posts.html';
    });

    document.getElementById('show-all-btn').addEventListener('click', () => {
      window.location.href = 'user_posts.html';
    });
  }

  // Auth state listener - pass user object into loadProfile
  onAuthStateChanged(auth, (user) => {
    if (user) {
      loadProfile(user);
    } else {
      profileContent.innerHTML = '<div class="loading">Please log in to view your profile.</div>';
      postsSection.innerHTML = '';
    }
  });

  // Logout functionality
  if (logoutBtn) {
    logoutBtn.addEventListener('click', () => {
      signOut(auth).then(() => {
        console.log('User signed out');
        window.location.href = 'index.html';
      }).catch((error) => {
        console.error('Sign out error:', error);
        alert('Error signing out. Please try again.');
      });
    });
  }

  // Settings functionality
  if (settingsBtn) {
    settingsBtn.addEventListener('click', () => {
      window.location.href = 'user_settings.html';
    });
  }

  // Initialize stars and handle loading overlay
  window.addEventListener('load', () => {
    createLoadingStars();

    // Simulate a minimum 2 second load time
    setTimeout(() => {
      loadingOverlay.classList.add('hidden');
    }, 3000);

    // Start background star animation
    initBgStars();
  });

  /* -----------------------------
     Background star animation code
     Lightweight, twinkling stars with subtle parallax
     ----------------------------- */
  function initBgStars() {
    const canvas = document.getElementById('bgStars');
    const ctx = canvas.getContext('2d');
    let width = canvas.width = window.innerWidth;
    let height = canvas.height = window.innerHeight;
    let stars = [];
    const STAR_COUNT = Math.round((width * height) / 6000); // scale by screen area (keeps perf)
    let mouseX = width / 2, mouseY = height / 2;

    function resetStars() {
      stars = [];
      for (let i = 0; i < STAR_COUNT; i++) {
        const radius = Math.random() * 1.2 + 0.3; // small stars
        stars.push({
          x: Math.random() * width,
          y: Math.random() * height,
          baseX: 0, // will set below
          baseY: 0,
          r: radius,
          alpha: Math.random() * 0.9 + 0.1,
          twinkleSpeed: Math.random() * 0.02 + 0.005,
          phase: Math.random() * Math.PI * 2
        });
      }
      // set base positions
      stars.forEach(s => { s.baseX = s.x; s.baseY = s.y; });
    }

    function onResize() {
      width = canvas.width = window.innerWidth;
      height = canvas.height = window.innerHeight;
      resetStars();
    }

    window.addEventListener('resize', throttle(onResize, 150));

    // subtle parallax on mouse move
    window.addEventListener('mousemove', (e) => {
      mouseX = e.clientX;
      mouseY = e.clientY;
    });

    let lastTime = 0;
    function animate(time) {
      const dt = (time - lastTime) / 1000;
      lastTime = time;
      ctx.clearRect(0, 0, width, height);

      // draw subtle vignette to better integrate stars with bg image
      const vignette = ctx.createRadialGradient(width/2, height/2, Math.max(width, height)/8, width/2, height/2, Math.max(width, height)/1.2);
      vignette.addColorStop(0, 'rgba(255,255,255,0.00)');
      vignette.addColorStop(1, 'rgba(0,0,0,0.18)');
      ctx.fillStyle = vignette;
      ctx.fillRect(0,0,width,height);

      for (let i = 0; i < stars.length; i++) {
        const s = stars[i];

        // twinkle
        s.phase += s.twinkleSpeed;
        const tw = (Math.sin(s.phase) + 1) / 2; // 0..1
        const alpha = s.alpha * (0.6 + 0.4 * tw);

        // parallax offset (small)
        const px = (mouseX - width/2) * (s.r * 0.003);
        const py = (mouseY - height/2) * (s.r * 0.003);

        const drawX = s.baseX + px;
        const drawY = s.baseY + py;

        // subtle movement to mimic depth drift
        s.baseX += Math.sin((i + time*0.0001) * 0.0003) * 0.02;
        s.baseY += Math.cos((i + time*0.0002) * 0.0004) * 0.02;

        ctx.beginPath();
        ctx.globalAlpha = alpha;
        // draw glow for larger-ish stars
        if (s.r > 0.9) {
          const g = ctx.createRadialGradient(drawX, drawY, 0, drawX, drawY, s.r * 6);
          g.addColorStop(0, `rgba(255,255,255,${alpha})`);
          g.addColorStop(1, `rgba(255,255,255,0)`);
          ctx.fillStyle = g;
          ctx.arc(drawX, drawY, s.r * 6, 0, Math.PI * 2);
          ctx.fill();
        }
        // core
        ctx.beginPath();
        ctx.fillStyle = 'white';
        ctx.arc(drawX, drawY, s.r, 0, Math.PI * 2);
        ctx.fill();

        ctx.globalAlpha = 1;
      }

      requestAnimationFrame(animate);
    }

    resetStars();
    requestAnimationFrame(animate);

    // simple throttle utility
    function throttle(fn, wait) {
      let time = Date.now();
      return function() {
        if ((time + wait - Date.now()) < 0) {
          fn();
          time = Date.now();
        }
      }
    }
  }
</script>
</body>  
</html>