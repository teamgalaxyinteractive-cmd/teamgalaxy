<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Settings - TeamGalaxy</title>
  <style>
    :root {
      --overlay-color: rgba(34, 16, 80, 0.06); /* matching-color overlay (very low opacity) */
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    html, body { height: 100%; }

    body {
      background: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
      color: #e0e0ff;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      position: relative;
      overflow-x: hidden;
    }

    /* BACKGROUND IMAGE LAYER */
    .bg-layer {
      position: fixed;
      inset: 0;
      z-index: -4;
      background-image: url('https://dl.dropboxusercontent.com/scl/fi/1csa5jjslfhutldgd4in9/IMG_20251116_113654.png?rlkey=p2jqe4ngtw8z2id5rpqspw9sb&st=grvkp8p9&dl=0');
      background-position: center;
      background-size: cover;
      background-repeat: no-repeat;
      filter: brightness(0.55) saturate(0.95);
      transition: filter .35s ease;
    }

    /* subtle overlay that tints the background with matching color */
    .bg-overlay {
      position: fixed;
      inset: 0;
      z-index: -3;
      background: var(--overlay-color);
      pointer-events: none;
      mix-blend-mode: multiply;
    }

    /* Star canvas sits above overlay but behind UI */
    #bgStars {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: -2;
      pointer-events: none;
      display: block;
    }

    /* shimmer sweep (very low opacity) */
    .shimmer-layer {
      position: fixed;
      inset: 0;
      z-index: -1;
      pointer-events: none;
      background: linear-gradient(120deg,
        rgba(255,255,255,0.00) 0%,
        rgba(255,255,255,0.08) 45%,
        rgba(255,255,255,0.00) 60%);
      background-size: 300% 300%;
      opacity: 0.10;
      mix-blend-mode: screen;
      animation: shimmer-move 10s linear infinite;
      filter: blur(6px);
    }

    @keyframes shimmer-move {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    /* Header */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 2rem;
      background: rgba(10, 10, 35, 0.95);
      backdrop-filter: blur(15px);
      border-bottom: 1px solid #5a4fcf;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .logo {
      font-size: 2rem;
      font-weight: bold;
      color: #8a7cff;
      letter-spacing: 1.5px;
      text-shadow: 0 0 10px rgba(138, 124, 255, 0.5);
      background: linear-gradient(45deg, #8a7cff, #d66efd);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .header-buttons { display: flex; gap: 1rem; }

    .btn {
      padding: 0.7rem 1.4rem;
      border-radius: 8px;
      border: 1px solid rgba(138, 124, 255, 0.3);
      background: rgba(20, 20, 40, 0.5);
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
      font-size: 0.95rem;
      color: #b1a6ff;
      backdrop-filter: blur(10px);
    }

    .btn:hover {
      background: rgba(30, 30, 60, 0.7);
      border: 1px solid rgba(138, 124, 255, 0.6);
      box-shadow: 0 0 15px rgba(138, 124, 255, 0.2);
    }

    /* Main Content */
    .container {
      max-width: 800px;
      margin: 2rem auto;
      padding: 0 1.5rem;
      flex: 1;
      position: relative;
      z-index: 2; /* above decorations */
    }

    /* SETTINGS CARD */
    .settings-card {
      background: rgba(20, 20, 40, 0.55); /* reduced from 0.65 to 0.55 */
      border-radius: 20px;
      padding: 3rem;
      box-shadow: 0 15px 35px rgba(0, 0, 0, 0.45);
      border: 1px solid rgba(90,79,207,0.9);
      backdrop-filter: blur(10px);
      width: 100%;
      position: relative;
    }

    .settings-header {
      display: flex;
      align-items: center;
      gap: 2rem;
      margin-bottom: 2.5rem;
      flex-wrap: wrap;
    }

    .profile-photo-container {
      width: 150px;
      height: 150px;
      border-radius: 50%;
      object-fit: cover;
      border: 4px solid #6a5af9;
      background: linear-gradient(45deg, #6a5af9, #d66efd);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 4rem;
      box-shadow: 0 0 20px rgba(106, 90, 249, 0.3);
      position: relative;
      overflow: hidden;
    }

    .profile-photo-container img {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      object-fit: cover;
    }

    .settings-info {
      flex: 1;
      min-width: 300px;
    }

    .settings-title {
      font-size: 2.5rem;
      font-weight: bold;
      color: #ffffff;
      margin-bottom: 0.5rem;
      text-shadow: 0 0 10px rgba(255, 255, 255, 0.2);
    }

    .settings-subtitle {
      font-size: 1.1rem;
      color: #b1a6ff;
      margin-bottom: 1rem;
    }

    .form-group {
      margin-bottom: 2rem;
    }

    .form-label {
      display: block;
      margin-bottom: 0.5rem;
      color: #d0c4ff;
      font-weight: 500;
      font-size: 1.1rem;
    }

    .form-input {
      width: 100%;
      padding: 1rem;
      border-radius: 10px;
      border: 1px solid rgba(138, 124, 255, 0.3);
      background: rgba(30, 30, 60, 0.6);
      color: #e0e0ff;
      font-size: 1rem;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
    }

    .form-input:focus {
      outline: none;
      border: 1px solid rgba(138, 124, 255, 0.6);
      box-shadow: 0 0 15px rgba(138, 124, 255, 0.2);
    }

    .form-textarea {
      width: 100%;
      padding: 1rem;
      border-radius: 10px;
      border: 1px solid rgba(138, 124, 255, 0.3);
      background: rgba(30, 30, 60, 0.6);
      color: #e0e0ff;
      font-size: 1rem;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
      min-height: 120px;
      resize: vertical;
    }

    .form-textarea:focus {
      outline: none;
      border: 1px solid rgba(138, 124, 255, 0.6);
      box-shadow: 0 0 15px rgba(138, 124, 255, 0.2);
    }

    .save-btn {
      padding: 1rem 2.5rem;
      border-radius: 10px;
      border: 1px solid rgba(138, 124, 255, 0.3);
      background: linear-gradient(45deg, #6a5af9, #d66efd);
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
      font-size: 1.1rem;
      color: white;
      backdrop-filter: blur(10px);
      width: 100%;
      margin-top: 1rem;
    }

    .save-btn:hover {
      background: linear-gradient(45deg, #7a6af9, #e67fdd);
      box-shadow: 0 0 20px rgba(106, 90, 249, 0.4);
    }

    .save-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .status-message {
      margin-top: 1rem;
      padding: 0.8rem;
      border-radius: 8px;
      text-align: center;
      font-weight: 500;
    }

    .status-success {
      background: rgba(40, 167, 69, 0.2);
      border: 1px solid rgba(40, 167, 69, 0.3);
      color: #28a745;
    }

    .status-error {
      background: rgba(220, 53, 69, 0.2);
      border: 1px solid rgba(220, 53, 69, 0.3);
      color: #dc3545;
    }

    /* Info Box */
    .info-box {
      background: rgba(30, 30, 60, 0.5);
      border-radius: 15px;
      padding: 1.5rem;
      margin-bottom: 2rem;
      border: 1px solid rgba(138, 124, 255, 0.3);
    }

    .info-title {
      color: #8a7cff;
      font-size: 1.2rem;
      margin-bottom: 1rem;
      text-align: center;
    }

    .info-text {
      color: #a0a0d0;
      font-size: 0.95rem;
      line-height: 1.6;
      text-align: center;
    }

    /* Footer */
    .footer {
      background: rgba(10, 10, 35, 0.95);
      padding: 3rem 2rem 2rem;
      margin-top: 3rem;
      border-top: 1px solid #5a4fcf;
      box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.3);
      z-index: 2;
    }

    .footer-content { max-width: 1200px; margin: 0 auto; display: grid; grid-template-columns: 1fr 1fr; gap: 3rem; }
    .footer-about-title { font-size: 1.1rem; color: #8a7cff; margin-bottom: 1rem; font-weight: 600; }
    .footer-about-text { color:#a0a0d0; line-height:1.6; font-size:.9rem; }

    .footer-links { display:flex; flex-direction:column; gap:.8rem; }
    .footer-links a { color:#a0a0d0; text-decoration:none; font-size:.95rem; transition:color .3s ease; }
    .footer-links a:hover { color:#8a7cff; text-decoration:underline; }

    .rocket-frame { margin-top:2rem; padding:1.5rem; border:2px solid #5a4fcf; border-radius:12px; background: rgba(20,20,40,0.5); position:relative; overflow:hidden; }
    .rocket-text { font-size:1.8rem; font-weight:bold; color:#8a7cff; text-align:center; text-shadow:0 0 15px rgba(138,124,255,0.6); background: linear-gradient(45deg,#8a7cff,#d66efd,#8a7cff); background-size:200% auto; -webkit-background-clip:text; -webkit-text-fill-color:transparent; animation: shimmer 3s linear infinite; font-family: 'Arial Rounded MT Bold','Segoe UI',sans-serif; }

    @keyframes shimmer { 0% { background-position: -200% center; } 100% { background-position: 200% center; } }

    /* Loading Overlay and small stars used during load */
    .loading-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: linear-gradient(135deg,#0f0c29,#302b63,#24243e); display:flex; flex-direction:column; justify-content:center; align-items:center; z-index:9999; transition:opacity .5s ease; }
    .loading-overlay.hidden { opacity: 0; pointer-events: none; }
    .loading-message { font-size:1.8rem; color:#e0e0ff; margin-bottom:2rem; text-align:center; font-weight:600; text-shadow:0 0 10px rgba(138,124,255,0.5); }
    .stars-container { position: relative; width:300px; height:300px; }
    .star { position:absolute; background-color: white; border-radius:50%; animation: twinkle var(--duration) infinite ease-in-out; }
    @keyframes twinkle { 0%,100% { opacity: .2; } 50% { opacity: 1; } }

    /* Responsive */
    @media (max-width: 768px) {
      .header { flex-direction: column; gap: 1.2rem; padding: 1.2rem; }
      .settings-header { flex-direction: column; text-align: center; }
      .footer-content { grid-template-columns: 1fr; }
      .settings-card { padding: 2rem 1.5rem; }
      .settings-title { font-size: 2rem; }
      /* reduce star density on small screens for performance */
      .shimmer-layer { display: none; }
    }
  </style>
</head>
<body>
  <!-- Background layers -->
  <div class="bg-layer" aria-hidden="true"></div>
  <div class="bg-overlay" aria-hidden="true"></div>
  <canvas id="bgStars" aria-hidden="true"></canvas>
  <div class="shimmer-layer" aria-hidden="true"></div>

  <!-- Loading Overlay -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="loading-message">Loading settings...</div>
    <div class="stars-container" id="starsContainer"></div>
  </div>

  <!-- Header -->
  <header class="header">
  <div class="logo" onclick="window.location.href='../dashboard.html'" style="cursor: pointer;">GalaxyWeb</div>
  <div class="header-buttons">
    <button class="btn btn-profile">Profile</button>
    <button class="btn btn-logout">Log Out</button>
  </div>
</header>

  <!-- Main Content -->
  <div class="container">
    <div class="settings-card">
      <div class="settings-header">
        <div class="profile-photo-container">
          <img src="https://via.placeholder.com/150" alt="Profile Photo" id="currentPhoto">
        </div>
        <div class="settings-info">
          <h1 class="settings-title">Settings</h1>
          <p class="settings-subtitle">Manage your profile information</p>
        </div>
      </div>

      <form id="settingsForm">
        <div class="form-group">
          <label class="form-label">Display Name</label>
          <input type="text" id="nameInput" class="form-input" placeholder="Enter your display name">
        </div>

        <div class="form-group">
          <label class="form-label">Username Slug</label>
          <input type="text" id="slugInput" class="form-input" placeholder="Enter your username slug (e.g., john_doe)">
        </div>

        <div class="form-group">
          <label class="form-label">Profile Photo URL</label>
          <input type="text" id="photoUrlInput" class="form-input" placeholder="Paste your image URL here">
          <p style="color: #a0a0d0; font-size: 0.85rem; margin-top: 0.5rem;">Note: Upload your image to a public CDN and paste the URL here. Direct upload will be available in future updates.</p>
        </div>

        <div class="form-group">
          <label class="form-label">Bio</label>
          <textarea id="bioInput" class="form-textarea" placeholder="Tell us about yourself..."></textarea>
        </div>

        <!-- Info Box for Verified Badge -->
        <div class="info-box">
          <h3 class="info-title">Verified Badge</h3>
          <p class="info-text">The verified badge will be introduced later. Currently, it is only available to select members.</p>
        </div>

        <button type="submit" class="save-btn" id="saveBtn">Save Changes</button>
      </form>

      <div id="statusMessage" class="status-message" style="display: none;"></div>
    </div>
  </div>

  <!-- Footer -->
  <footer class="footer">
    <div class="footer-content">
      <div class="footer-left">
        <div class="footer-about-title">About TeamGalaxy</div>
        <div class="footer-about-text">
          TeamGalaxy is an innovative gaming and creative community, united by passion and the spirit of collaboration. We host tournaments, share design ideas, and grow talents together â€” join now to explore the Galaxy!
        </div>
      </div>
      <div class="footer-right">
        <div class="footer-links">
          <a href="../legal/privacy_policy.html">Privacy Policy</a>
          <a href="../legal/terms_and_conditions.html">Terms & Conditions</a>
          <a href="../about_us.html">About</a>
        </div>
        <div class="rocket-frame">
          <div class="rocket-text">ðŸš€ ROCKET ðŸš€</div>
        </div>
      </div>
    </div>
  </footer>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-auth.js";
    import { getFirestore, doc, getDoc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-firestore.js";

    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyD0Yv_bQjxi2_kjzPR4XHOlaB7Sb6NRVUc",
      authDomain: "teamgalaxy-77344.firebaseapp.com",
      projectId: "teamgalaxy-77344",
      storageBucket: "teamgalaxy-77344.firebasestorage.app",
      messagingSenderId: "770256225320",
      appId: "1:770256225320:web:5a363ebd757de6cde3a11d",
      measurementId: "G-6C2W9NSNCH"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // DOM Elements
    const loadingOverlay = document.getElementById('loadingOverlay');
    const currentPhoto = document.getElementById('currentPhoto');
    const nameInput = document.getElementById('nameInput');
    const slugInput = document.getElementById('slugInput');
    const photoUrlInput = document.getElementById('photoUrlInput');
    const bioInput = document.getElementById('bioInput');
    const settingsForm = document.getElementById('settingsForm');
    const saveBtn = document.getElementById('saveBtn');
    const statusMessage = document.getElementById('statusMessage');
    const logoutBtn = document.querySelector('.btn-logout');
    const profileBtn = document.querySelector('.btn-profile');

    // Create stars for loading overlay
    function createLoadingStars() {
      const container = document.getElementById('starsContainer');
      container.innerHTML = '';
      for (let i = 0; i < 30; i++) {
        const star = document.createElement('div');
        star.classList.add('star');

        // Random position
        const x = Math.random() * 100;
        const y = Math.random() * 100;
        star.style.left = `${x}%`;
        star.style.top = `${y}%`;

        // Random size
        const size = Math.random() * 3 + 1;
        star.style.width = `${size}px`;
        star.style.height = `${size}px`;

        // Random animation duration
        const duration = Math.random() * 3 + 2;
        star.style.setProperty('--duration', `${duration}s`);

        container.appendChild(star);
      }
    }

    // Load user profile data
    async function loadProfile() {
      const user = auth.currentUser;
      if (!user) {
        window.location.href = 'index.html';
        return;
      }

      try {
        const docRef = doc(db, 'usersPrivate', user.uid);
        const docSnap = await getDoc(docRef);

        if (!docSnap.exists()) {
          showStatus('Profile not found.', 'error');
          return;
        }

        const data = docSnap.data();
        // Populate form fields with existing data
        currentPhoto.src = data.profilePhotoUrl || 'https://via.placeholder.com/150';
        nameInput.value = data.name || '';
        slugInput.value = data.slug || '';
        photoUrlInput.value = data.profilePhotoUrl || '';
        bioInput.value = data.bio || '';
      } catch (error) {
        console.error('Error loading profile:', error);
        showStatus('Error loading profile data.', 'error');
      }
    }

    // Show status message
    function showStatus(message, type) {
      statusMessage.textContent = message;
      statusMessage.className = 'status-message';
      if (type === 'success') {
        statusMessage.classList.add('status-success');
      } else {
        statusMessage.classList.add('status-error');
      }
      statusMessage.style.display = 'block';

      setTimeout(() => {
        statusMessage.style.display = 'none';
      }, 5000);
    }

    // Update profile data in Firestore
    async function updateProfile() {
      const user = auth.currentUser;
      if (!user) return;

      const name = nameInput.value.trim();
      const slug = slugInput.value.trim();
      const photoUrl = photoUrlInput.value.trim();
      const bio = bioInput.value.trim();

      if (!name || !slug) {
        showStatus('Name and slug are required.', 'error');
        return;
      }

      try {
        saveBtn.disabled = true;
        saveBtn.textContent = 'Saving...';

        const docRef = doc(db, 'usersPrivate', user.uid);
        await updateDoc(docRef, {
          name: name,
          slug: slug,
          profilePhotoUrl: photoUrl,
          bio: bio,
          termsAccepted: true, // Always set to true when saving
          termsTimestamp: serverTimestamp() // Store current timestamp
        });

        // Update the displayed image
        if (photoUrl) {
          currentPhoto.src = photoUrl;
        }

        showStatus('Profile updated successfully!', 'success');
      } catch (error) {
        console.error('Error updating profile:', error);
        showStatus('Error saving profile data.', 'error');
      } finally {
        saveBtn.disabled = false;
        saveBtn.textContent = 'Save Changes';
      }
    }

    // Event Listeners
    settingsForm.addEventListener('submit', (e) => {
      e.preventDefault();
      updateProfile();
    });

    // Update photo preview when URL is entered
    photoUrlInput.addEventListener('change', () => {
      const url = photoUrlInput.value.trim();
      if (url) {
        currentPhoto.src = url;
      }
    });

    logoutBtn.addEventListener('click', () => {
      signOut(auth).then(() => { window.location.href = 'index.html'; }).catch((error) => { console.error('Sign out error:', error); showStatus('Error signing out.', 'error'); });
    });

    profileBtn.addEventListener('click', () => { window.location.href = 'user_profile.html'; });

    // Auth state listener
    onAuthStateChanged(auth, (user) => {
      if (user) {
        loadProfile();
      } else {
        window.location.href = 'index.html';
      }
    });

    // Initialize small loading stars, hide overlay, and start bg animation
    window.addEventListener('load', () => {
      createLoadingStars();
      setTimeout(() => loadingOverlay.classList.add('hidden'), 2000);
      initBgStars();
    });

    /* -----------------------------
       Background star animation (realistic, multi-layer + twinkle + shooting stars)
       ----------------------------- */
    function initBgStars() {
      const canvas = document.getElementById('bgStars');
      const ctx = canvas.getContext('2d');
      let w = canvas.width = window.innerWidth;
      let h = canvas.height = window.innerHeight;
      // Three depth layers: far, mid, near
      const LAYERS = [
        { depth: 0.25, countFactor: 1.0, radiusRange: [0.25, 0.8], speed: 0.02 }, // far (many small)
        { depth: 0.6, countFactor: 0.6, radiusRange: [0.6, 1.6], speed: 0.06 },  // mid
        { depth: 1.2, countFactor: 0.25, radiusRange: [1.4, 3.5], speed: 0.12 }   // near (fewer larger)
      ];
      let stars = [];
      let shootingStars = [];
      const BASE_DENSITY = 0.00022; // tweak: stars per px^2 (increased for more stars)
      let mouseX = w/2, mouseY = h/2;

      function createStars() {
        stars = [];
        for (let li = 0; li < LAYERS.length; li++) {
          const layer = LAYERS[li];
          const count = Math.round(w * h * BASE_DENSITY * layer.countFactor);
          for (let i = 0; i < count; i++) {
            const r = randRange(layer.radiusRange[0], layer.radiusRange[1]);
            stars.push({
              x: Math.random() * w,
              y: Math.random() * h,
              baseX: 0,
              baseY: 0,
              r,
              layer: li,
              depth: layer.depth,
              twinklePhase: Math.random() * Math.PI * 2,
              twinkleSpeed: (Math.random() * 0.02 + 0.005) * (1 / layer.depth),
              alphaBase: Math.random() * 0.7 + 0.2,
              color: randomStarColor()
            });
          }
        }
        stars.forEach(s => { s.baseX = s.x; s.baseY = s.y; });
      }

      function onResize() {
        w = canvas.width = window.innerWidth;
        h = canvas.height = window.innerHeight;
        createStars();
      }
      window.addEventListener('resize', throttle(onResize, 150));

      // mouse parallax
      window.addEventListener('mousemove', (e) => { mouseX = e.clientX; mouseY = e.clientY; });

      // occasional shooting stars
      function maybeSpawnShooting() {
        if (Math.random() < 0.025) { // slightly higher spawn chance
          spawnShootingStar();
        }
        setTimeout(maybeSpawnShooting, randRange(1000, 4000)); // random intervals
      }
      maybeSpawnShooting();

      function spawnShootingStar() {
        const startX = Math.random() < 0.6 ? -50 : w + 50; // left or right
        const startY = Math.random() * h * 0.6;
        const velX = (startX < 0) ? randRange(600, 1200) : randRange(-1200, -600); // px/s
        const velY = randRange(60, 220) * (Math.random() < 0.5 ? 1 : -1);
        const len = randRange(220, 520);
        shootingStars.push({
          x: startX,
          y: startY,
          vx: velX / 1000,
          vy: velY / 1000,
          life: 0,
          len,
          maxLife: randRange(600, 1200),
          opacity: 0.95
        });
      }

      // helpers
      function randRange(min, max) { return Math.random() * (max - min) + min; }
      function randomStarColor() {
        // slight blue-white-yellow variance (more realistic)
        const t = Math.random();
        if (t < 0.10) return 'rgba(255,235,200,'; // warm (yellowish)
        if (t < 0.6) return 'rgba(255,255,255,'; // white
        if (t < 0.8) return 'rgba(200,220,255,'; // cool (bluish)
        return 'rgba(230,240,255,'; // icy white
      }

      let last = performance.now();
      function frame(now) {
        const dt = now - last;
        last = now;
        ctx.clearRect(0, 0, w, h);

        // faint vignette to blend with bg image
        const vign = ctx.createRadialGradient(w/2, h/2, Math.max(w,h)/8, w/2, h/2, Math.max(w,h)/1.1);
        vign.addColorStop(0, 'rgba(255,255,255,0.00)');
        vign.addColorStop(1, 'rgba(0,0,0,0.16)');
        ctx.fillStyle = vign;
        ctx.fillRect(0,0,w,h);

        // draw stars by layer (back-to-front)
        for (let li = 0; li < LAYERS.length; li++) {
          for (let i = 0; i < stars.length; i++) {
            const s = stars[i];
            if (s.layer !== li) continue;

            // twinkle (more realistic - smoother, deeper variation)
            s.twinklePhase += s.twinkleSpeed * (dt/16.67);
            const tw = (Math.sin(s.twinklePhase) + 1) / 2; // 0..1
            const alpha = s.alphaBase * (0.35 + 0.65 * tw); // more pronounced twinkle

            // parallax offset influenced by depth
            const px = (mouseX - w/2) * (0.0005 * s.r) * (1 / s.depth);
            const py = (mouseY - h/2) * (0.0005 * s.r) * (1 / s.depth);
            const drawX = s.baseX + px + Math.sin((i + now*0.00002) * (0.0002 * s.depth)) * 0.4;
            const drawY = s.baseY + py + Math.cos((i + now*0.00003) * (0.0003 * s.depth)) * 0.4;

            // glow for larger stars (more realistic)
            if (s.r > 1.2) {
              const g = ctx.createRadialGradient(drawX, drawY, 0, drawX, drawY, s.r * 6);
              g.addColorStop(0, s.color + alpha + ')');
              g.addColorStop(0.4, s.color + (alpha * 0.6) + ')');
              g.addColorStop(1, s.color + '0)');
              ctx.fillStyle = g;
              ctx.fillRect(drawX - s.r*6, drawY - s.r*6, s.r*12, s.r*12);
            }

            // core (more realistic - slightly sharper)
            ctx.beginPath();
            ctx.globalAlpha = alpha;
            ctx.fillStyle = s.color + Math.min(1, alpha) + ')';
            ctx.arc(drawX, drawY, s.r, 0, Math.PI * 2);
            ctx.fill();
            ctx.globalAlpha = 1;
          }
        }

        // animate shooting stars
        for (let i = shootingStars.length - 1; i >= 0; i--) {
          const sh = shootingStars[i];
          // move
          sh.x += sh.vx * dt;
          sh.y += sh.vy * dt;
          sh.life += dt;

          // draw trail (shimmer effect)
          ctx.save();
          ctx.globalCompositeOperation = 'lighter';
          const trailLen = sh.len;
          const grad = ctx.createLinearGradient(sh.x, sh.y, sh.x - sh.vx*10, sh.y - sh.vy*10);
          grad.addColorStop(0, `rgba(255,255,255,${sh.opacity})`);
          grad.addColorStop(0.3, `rgba(200,220,255,${sh.opacity * 0.8})`);
          grad.addColorStop(1, `rgba(255,255,255,0)`);
          ctx.strokeStyle = grad;
          ctx.lineWidth = 2.8;
          ctx.beginPath();
          ctx.moveTo(sh.x, sh.y);
          ctx.lineTo(sh.x - sh.vx*trailLen, sh.y - sh.vy*trailLen);
          ctx.stroke();

          // head (with shimmer)
          const headGlow = ctx.createRadialGradient(sh.x, sh.y, 0, sh.x, sh.y, 6);
          headGlow.addColorStop(0, `rgba(255,255,255,${sh.opacity})`);
          headGlow.addColorStop(0.7, `rgba(200,220,255,${sh.opacity * 0.6})`);
          headGlow.addColorStop(1, `rgba(255,255,255,0)`);
          ctx.fillStyle = headGlow;
          ctx.beginPath();
          ctx.arc(sh.x, sh.y, 3.0, 0, Math.PI*2);
          ctx.fill();
          ctx.restore();

          // remove after life or if offscreen
          if (sh.life > sh.maxLife || sh.x < -600 || sh.x > w + 600 || sh.y < -600 || sh.y > h + 600) {
            shootingStars.splice(i, 1);
          }
        }

        requestAnimationFrame(frame);
      }

      // initial setup
      createStars();
      let raf = requestAnimationFrame(frame);

      // spawn shooting stars recursively
      // helper throttle
      function throttle(fn, wait) {
        let time = Date.now();
        return function() {
          if ((time + wait - Date.now()) < 0) {
            fn();
            time = Date.now();
          }
        }
      }

      // spawn first shooting star now with delay
      setTimeout(spawnShootingStar, randRange(800, 2500));

      // Burn CPU more? user said it's ok â€” but still keep tuned. You can increase BASE_DENSITY if you want more stars.

      return {
        stop() { cancelAnimationFrame(raf); window.removeEventListener('resize', onResize); }
      };
    }

    // utility throttle defined earlier used inside initBgStars but keep here for reuse
    function throttle(fn, wait) {
      let time = Date.now();
      return function() {
        if ((time + wait - Date.now()) < 0) {
          fn();
          time = Date.now();
        }
      }
    }

  </script>
</body>
</html>