<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Settings - TeamGalaxy</title>
  <style>
  /* ===== Your restored styles + mobile overflow fixes ===== */
  :root { --overlay-color: rgba(34, 16, 80, 0.06); }

  /* reset + box-sizing */
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  html, body { height: 100%; width: 100%; overflow-x: hidden; -webkit-overflow-scrolling: touch; }
  body{
    font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg,#0f0c29,#302b63,#24243e);
    color:#e0e0ff;
    min-height:100vh;
    display:flex;
    flex-direction:column;
    position:relative;
    overflow-x:hidden; /* prevents horizontal scroll */
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
  }

  /* background layers */
  .bg-layer{ position:fixed; inset:0; z-index:-4;
    background-image:url('https://dl.dropboxusercontent.com/scl/fi/6vctg6446bxpsb3adeixf/IMG_20251124_201705.jpg?rlkey=wrhhx0n6w04cy4aw5b6gkhj85&st=bn4uv550&dl=0');
    background-position:center; background-size:cover; background-repeat:no-repeat;
    filter:brightness(0.55) saturate(0.95); transition:filter .35s ease;
    pointer-events:none;
  }
  .bg-overlay{ position:fixed; inset:0; z-index:-3; background:var(--overlay-color); pointer-events:none; mix-blend-mode:multiply; }
  #bgStars{ position:fixed; top:0; left:0; width:100%; height:100%; z-index:-2; pointer-events:none; display:block; }
  .shimmer-layer{ position:fixed; inset:0; z-index:-1; pointer-events:none;
    background:linear-gradient(120deg, rgba(255,255,255,0) 0%, rgba(255,255,255,0.08) 45%, rgba(255,255,255,0) 60%);
    background-size:300% 300%; opacity:0.10; mix-blend-mode:screen; animation:shimmer-move 10s linear infinite; filter:blur(6px);
  }
  @keyframes shimmer-move { 0%{background-position:0% 50%} 50%{background-position:100% 50%} 100%{background-position:0% 50%} }

  /* fonts */
  @font-face {
    font-family: 'Sefa Regular';
    src: url('../assets/fonts/Sefa-Regular.woff2') format('woff2'),
         url('../assets/fonts/Sefa-Regular.woff') format('woff');
    font-weight: normal; font-style: normal; font-display: swap;
  }

  /* basic helpers */
  .hidden { display:none !important; }
  img, picture, svg, video { max-width:100%; height:auto; display:block; }
  button, input, textarea { font-family: inherit; }
  .muted{ color:#a0a0d0; font-size:13px; }

  /* loading stars */
  .stars-container { position:relative; width:240px; height:240px; }
  .star { position:absolute; border-radius:50%; background: radial-gradient(circle, rgba(255,255,255,1) 0%, rgba(255,255,255,0.75) 40%, rgba(255,255,255,0) 100%); opacity:0.95; transform-origin:center; animation:twinkle var(--duration,2s) ease-in-out infinite alternate; pointer-events:none; filter:drop-shadow(0 0 6px rgba(200,200,255,0.35)); }
  @keyframes twinkle { from{ transform:scale(0.6); opacity:0.6 } to{ transform:scale(1.2); opacity:1 } }

  /* header */
  .header{
    display:flex; justify-content:space-between; align-items:center;
    padding:1rem 1.25rem; background:rgba(10,10,35,0.95);
    backdrop-filter: blur(15px); border-bottom:1px solid #5a4fcf;
    box-shadow:0 4px 20px rgba(0,0,0,0.4); position:sticky; top:0; z-index:100;
  }
  .logo{
    font-size:1.6rem; font-weight:bold; color:#8a7cff; letter-spacing:1.5px;
    text-shadow:0 0 10px rgba(138,124,255,0.5); background:linear-gradient(45deg,#8a7cff,#d66efd);
    -webkit-background-clip:text; -webkit-text-fill-color:transparent; cursor:pointer;
    white-space:nowrap;
  }
  .header-buttons{ display:flex; gap:.6rem; align-items:center; }
  .btn{ padding:.55rem .9rem; border-radius:8px; border:1px solid rgba(138,124,255,0.3); background:rgba(20,20,40,0.5); cursor:pointer; font-weight:600; transition:all .25s ease; font-size:.9rem; color:#b1a6ff; backdrop-filter: blur(6px); white-space:nowrap; }
  .btn:hover{ background:rgba(30,30,60,0.7); border:1px solid rgba(138,124,255,0.6); box-shadow:0 0 12px rgba(138,124,255,0.12); }

  /* main container */
  .container{
    max-width:980px; margin:1.5rem auto; padding:0 1rem; flex:1; position:relative; z-index:2;
    width:100%;
    box-sizing:border-box;
  }

  /* card */
  .settings-card{
    background:rgba(20,20,40,0.55); border-radius:16px; padding:2.2rem; box-shadow:0 15px 35px rgba(0,0,0,0.45);
    border:1px solid rgba(90,79,207,0.9); backdrop-filter: blur(10px); width:100%; position:relative; overflow:hidden;
  }

  .settings-header{ display:flex; align-items:center; gap:1.25rem; margin-bottom:1.75rem; flex-wrap:wrap; }
  .profile-photo-container{ width:130px; height:130px; border-radius:50%; object-fit:cover; border:4px solid #6a5af9; background:linear-gradient(45deg,#6a5af9,#d66efd); display:flex; align-items:center; justify-content:center; font-size:3.4rem; box-shadow:0 0 20px rgba(106,90,249,0.3); position:relative; overflow:hidden; cursor:pointer; flex:0 0 auto; }
  .profile-photo-container img{ width:100%; height:100%; border-radius:50%; object-fit:cover; display:block; }

  /* ensure flex children can shrink to prevent overflow */
  .settings-info{ flex:1 1 auto; min-width:0; } /* min-width:0 lets input/text wrap instead of forcing overflow */
  .settings-title{ font-size:1.8rem; font-weight:700; color:#ffffff; margin-bottom:.35rem; text-shadow:0 0 10px rgba(255,255,255,0.08); word-break:break-word; }
  .settings-subtitle{ font-size:.99rem; color:#b1a6ff; margin-bottom:.6rem; word-wrap:break-word; }

  .form-group{ margin-bottom:1.25rem; }
  .form-label{ display:block; margin-bottom:.45rem; color:#d0c4ff; font-weight:600; font-size:1rem; }
  .form-input, .form-textarea{
    width:100%; padding:.95rem; border-radius:10px; border:1px solid rgba(138,124,255,0.3); background:rgba(30,30,60,0.6); color:#e0e0ff; font-size:1rem; transition:all .25s ease; backdrop-filter: blur(8px);
    min-width:0; /* allows inputs to shrink inside flex containers */
    box-sizing:border-box;
  }
  .form-input:focus, .form-textarea:focus{ outline:none; border:1px solid rgba(138,124,255,0.6); box-shadow:0 0 12px rgba(138,124,255,0.14); }
  .form-textarea{ min-height:110px; resize:vertical; }

  .save-btn{ padding:.95rem 1rem; border-radius:10px; border:1px solid rgba(138,124,255,0.3); background:linear-gradient(45deg,#6a5af9,#d66efd); cursor:pointer; font-weight:700; transition:all .25s ease; font-size:1rem; color:white; backdrop-filter: blur(8px); width:100%; margin-top:.6rem; box-shadow:0 6px 18px rgba(0,0,0,0.35); }
  .info-box{ background:rgba(30,30,60,0.5); border-radius:12px; padding:1rem; margin-bottom:1rem; border:1px solid rgba(138,124,255,0.12); }

  .status-message{ margin-top:1rem; padding:.8rem; border-radius:8px; text-align:center; font-weight:600; display:none; word-wrap:break-word; }
  .status-success{ background:rgba(40,167,69,0.12); border:1px solid rgba(40,167,69,0.2); color:#28a745; display:block; }
  .status-error{ background:rgba(220,53,69,0.08); border:1px solid rgba(220,53,69,0.12); color:#dc3545; display:block; }

  /* editor modal */
  .editor-modal{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:1500; background: rgba(0,0,0,0.6); padding:20px; }
  .editor-modal.show{ display:flex; }
  .editor-panel{
    width:min(920px,96%); max-width:100%;
    background:#0e0b16; padding:14px; border-radius:12px; display:flex; gap:12px; align-items:flex-start;
    box-shadow:0 10px 60px rgba(0,0,0,0.75); border:1px solid rgba(120,86,250,0.12); box-sizing:border-box; overflow:hidden;
  }
  .editor-left{ display:flex; flex-direction:column; gap:10px; align-items:center; }
  .editor-canvas{ width:320px; height:320px; background:#000; border-radius:8px; touch-action:none; display:block; max-width:100%; }
  .editor-controls{ display:flex; flex-direction:column; gap:8px; min-width:180px; }

  .small-btn{ padding:8px 10px; border-radius:8px; border:1px solid #222; background:#121212; color:#fff; cursor:pointer; }
  .small-primary{ background:linear-gradient(45deg,#6a5af9,#d66efd); color:#fff; border:none; }

  .details-box{ background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); padding:10px; border-radius:10px; border:1px solid rgba(100,90,200,0.08); color:#dbe0ff; font-size:13px; line-height:1.4; max-height:360px; overflow:auto; }
  .modal-actions{ margin-top:8px; display:flex; gap:8px; align-items:center; }
  .close-x{ position:absolute; right:18px; top:14px; background:transparent; border:none; color:#ddd; font-size:20px; cursor:pointer; }

  /* footer */
  .footer{ background:rgba(10,10,35,0.95); padding:2rem 1rem; margin-top:2rem; border-top:1px solid #5a4fcf; box-shadow:0 -4px 20px rgba(0,0,0,0.3); z-index:2; }
  .footer-content{ max-width:1200px; margin:0 auto; display:grid; grid-template-columns:1fr 1fr; gap:1.25rem; box-sizing:border-box; padding:0 0.5rem; }
  .rocket-frame{ margin-top:1rem; padding:1rem; border:2px solid #5a4fcf; border-radius:10px; background:rgba(20,20,40,0.5); }
  .rocket-text{ font-size:1.05rem; font-weight:700; color:#8a7cff; text-align:center; text-shadow:0 0 8px rgba(138,124,255,0.6); background: linear-gradient(45deg,#8a7cff,#d66efd,#8a7cff); background-size:200% auto; -webkit-background-clip:text; -webkit-text-fill-color:transparent; animation: shimmer 3s linear infinite; }

  @keyframes shimmer { 0% { background-position: -200% center; } 100% { background-position: 200% center; } }

  /* small tweaks to avoid overflow from long text/inputs */
  code{ word-break:break-word; }
  a{ word-break:break-word; }
  input[type="text"], textarea { min-width:0; word-break:break-word; }

  /* responsive adjustments (prevent horizontal overflow) */
  @media (max-width:880px) {
    .header{ padding: .8rem 1rem; gap:.4rem; }
    .logo{ font-size:1.2rem; letter-spacing:1px; }
    .container{ margin:1rem auto; padding:0 0.75rem; }
    .settings-card{ padding:1.15rem; border-radius:12px; }
    .profile-photo-container{ width:110px; height:110px; font-size:2.6rem; }
    .settings-title{ font-size:1.4rem; }
    .editor-panel{ flex-direction:column; align-items:stretch; gap:10px; padding:12px; }
    .editor-left{ align-items:center; }
    .editor-canvas{ width:100%; height:auto; aspect-ratio:1/1; max-height:420px; }
    .editor-controls{ min-width:100%; flex-direction:row; flex-wrap:wrap; gap:8px; align-items:center; justify-content:center; }
    .footer-content{ grid-template-columns:1fr; gap:1rem; padding:0 0.5rem; }
  }

  /* extra-safe rule: any element accidentally wider than viewport */
  :where(body, html) * { max-width: 100vw; box-sizing: border-box; }

  /* keep interactive elements accessible on small screens */
  .btn, .small-btn, .small-primary, .save-btn { touch-action: manipulation; -webkit-tap-highlight-color: rgba(255,255,255,0.06); }

</style>
</head>
<body>
  <!-- backgrounds -->
  <div class="bg-layer" aria-hidden="true"></div>
  <div class="bg-overlay" aria-hidden="true"></div>
  <canvas id="bgStars" aria-hidden="true"></canvas>
  <div class="shimmer-layer" aria-hidden="true"></div>

  <!-- loading overlay (restored) -->
  <div class="loading-overlay" id="loadingOverlay" style="position:fixed;top:0;left:0;width:100%;height:100%;display:flex;flex-direction:column;justify-content:center;align-items:center;z-index:9999;background: linear-gradient(135deg,#0f0c29,#302b63,#24243e);">
    <div class="loading-message" style="font-size:1.8rem;color:#e0e0ff;margin-bottom:1.2rem;font-weight:700;text-shadow:0 0 10px rgba(138,124,255,0.5);">Loading settings...</div>
    <div class="stars-container" id="starsContainer" style="position:relative;width:240px;height:240px;"></div>
    <div id="bootError" style="margin-top:12px;color:#ffc9c9;display:none;"></div>
  </div>

  <!-- header -->
  <header class="header">
     <div   
        class="logo"   
        onclick="window.location.href='../dashboard.html'"   
        style="  
            cursor: pointer;  font-family: 'Sefa Regular', sans-serif;   
        font-size: 2.5em;   
        font-weight: bold;  
        color: #ccf381; /* Neon color */  
        letter-spacing: 3px;  
    "  
>  
    GalaxyWeb  
</div>  
    <div class="header-buttons">
      <button class="btn btn-profile">Profile</button>
      <button class="btn btn-logout">Log Out</button>
    </div>
  </header>

  <!-- main -->
  <div class="container">
    <div class="settings-card">
      <div class="settings-header">
        <div class="profile-photo-container" id="photoWrapper" title="Click to change profile photo (one-time)">
          <img src="https://via.placeholder.com/150" alt="Profile Photo" id="currentPhoto">
        </div>

        <div class="settings-info">
          <h1 class="settings-title">Settings</h1>
          <p class="settings-subtitle">Manage your profile information</p>
          <div id="uploadControls" style="margin-top:12px; display:flex; gap:8px; align-items:center;">
            <div id="oneTimeNote" style="color:#a0a0d0;font-size:.9rem;">Click your profile photo to open the upload modal. You can change only once.</div>
          </div>
        </div>
      </div>

      <form id="settingsForm">
        <div class="form-group">
          <label class="form-label">Display Name</label>
          <input type="text" id="nameInput" class="form-input" placeholder="Enter your display name">
        </div>

        <div class="form-group">
          <label class="form-label">Username Slug</label>
          <input type="text" id="slugInput" class="form-input" placeholder="Enter your username slug (e.g., john_doe)">
        </div>

        <!-- visibility control for publicProfiles -->
        <div class="form-group">
          <label class="form-label">Public profile</label>
          <div style="display:flex;align-items:center;gap:10px;">
            <input type="checkbox" id="visibilityCheckbox" />
            <label for="visibilityCheckbox" style="font-size:.95rem;color:#cfd7ff;">Make my profile public</label>
          </div>
        </div>

        <!-- hidden managed field -->
        <div class="form-group" style="display:none;">
          <label class="form-label">Profile Photo URL</label>
          <input type="text" id="photoUrlInput" class="form-input" placeholder="(auto-managed)">
        </div>

        <div class="form-group">
          <label class="form-label">Bio</label>
          <textarea id="bioInput" class="form-textarea" placeholder="Tell us about yourself..."></textarea>
        </div>

        <div class="info-box">
          <h3 class="info-title">Verified Badge</h3>
          <p class="info-text">The verified badge will be introduced later. Currently, it is only available to select members.</p>
        </div>

        <button type="submit" class="save-btn" id="saveBtn">Save Changes</button>
      </form>

      <div id="statusMessage" class="status-message"></div>
    </div>
  </div>

  <!-- footer -->
  <footer class="footer" style="background:rgba(10,10,35,0.95); padding:3rem 2rem 2rem; margin-top:3rem; border-top:1px solid #5a4fcf; box-shadow:0 -4px 20px rgba(0,0,0,0.3); z-index:2;">
    <div class="footer-content" style="max-width:1200px;margin:0 auto;display:grid;grid-template-columns:1fr 1fr;gap:3rem;">
      <div>
        <div style="font-size:1.1rem;color:#8a7cff;margin-bottom:1rem;font-weight:600;">About TeamGalaxy</div>
        <div style="color:#a0a0d0;line-height:1.6;font-size:.9rem;">TeamGalaxy is an innovative gaming and creative community â€” join now to explore the Galaxy!</div>
      </div>
      <div>
        <div style="display:flex;flex-direction:column;gap:.8rem;">
          <a href="../legal/privacy_policy.html" style="color:#a0a6d0;text-decoration:none;">Privacy Policy</a>
          <a href="../legal/terms_and_conditions.html" style="color:#a0a6d0;text-decoration:none;">Terms & Conditions</a>
          <a href="../about_us.html" style="color:#a0a6d0;text-decoration:none;">About</a>
        </div>
        <div class="rocket-frame" style="margin-top:2rem;padding:1.5rem;border:2px solid #5a4fcf;border-radius:12px;background:rgba(20,20,40,0.5);">
          <div class="rocket-text" style="font-size:1.8rem;font-weight:bold;color:#8a7cff;text-align:center;">ðŸš€ ROCKET ðŸš€</div>
        </div>
      </div>
    </div>
  </footer>

  <!-- editor modal -->
  <div id="editorModal" class="editor-modal" role="dialog" aria-hidden="true">
    <div class="editor-panel" role="document" aria-label="Profile photo editor">
      <button class="close-x" id="modalCloseBtn" title="Close">âœ•</button>
      <div class="editor-left">
        <canvas id="editorCanvas" class="editor-canvas" width="360" height="360"></canvas>
        <div style="display:flex;gap:8px;">
          <input id="modalFileInput" type="file" accept="image/*" style="color:#fff" />
          <button id="applyBtnModal" class="small-primary small-btn">Apply Preview</button>
        </div>
      </div>

      <div class="editor-controls">
        <div style="display:flex;gap:8px;flex-wrap:wrap;">
          <button id="zoomIn" class="small-btn">Zoom +</button>
          <button id="zoomOut" class="small-btn">Zoom -</button>
          <button id="rotateLeft" class="small-btn">âŸ²</button>
          <button id="rotateRight" class="small-btn">âŸ³</button>
          <button id="resetBtn" class="small-btn">Reset</button>
        </div>

        <div class="details-box" id="detailsBox">
          <strong>Upload details & notes</strong>
          <p style="margin-top:8px;color:#cfd7ff;">
            â€¢ You can change your profile photo only <strong>once</strong>. After successful upload, it will be locked. <br/>
            â€¢ Upload will attempt a single server upsert. If server rejects with "resource exists", the upload will stop. <br/>
            â€¢ We will store the final public URL in Firestore under <code>profilePhotoUrl</code>, and set <code>profilePhotoLocked: true</code>.
          </p>
          <hr style="opacity:.06;margin:8px 0"/>
          <div id="modalMessages" style="font-size:13px;color:#a9b6ff;"></div>
        </div>

        <div class="modal-actions">
          <button id="confirmUploadBtn" class="small-primary small-btn">Upload & Lock (one-time)</button>
          <button id="cancelModalBtn" class="small-btn">Cancel</button>
        </div>
      </div>
    </div>
  </div>

  <!-- script -->
  <script type="module">
    // defensive global error handler so page doesn't go blank silently
    window.addEventListener('error', (ev) => {
      try {
        const boot = document.getElementById('bootError');
        if (boot) { boot.style.display = 'block'; boot.textContent = 'An error occurred while loading the page â€” check console for details.'; }
        console.error('Global error caught:', ev.error || ev.message || ev);
        const loading = document.getElementById('loadingOverlay');
        if (loading) {
          // show overlay so user sees the error state
          loading.style.display = 'flex';
          loading.classList.remove('hidden');
        }
      } catch (e) { console.error(e); }
    });

    // imports
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-auth.js";
    import { getFirestore, doc, getDoc, updateDoc, serverTimestamp, setDoc } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-firestore.js";

    // config
    const firebaseConfig = {
      apiKey: "AIzaSyD0Yv_bQjxi2_kjzPR4XHOlaB7Sb6NRVUc",
      authDomain: "teamgalaxy-77344.firebaseapp.com",
      projectId: "teamgalaxy-77344",
      storageBucket: "teamgalaxy-77344.firebasestorage.app",
      messagingSenderId: "770256225320",
      appId: "1:770256225320:web:5a363ebd757de6cde3a11d",
      measurementId: "G-6C2W9NSNCH"
    };
    const SUPABASE_URL = 'https://dvjihjkyenzkacviywgk.supabase.co';
    const FUNCTION_URL = 'https://dvjihjkyenzkacviywgk.functions.supabase.co/upload-image';

    // init firebase safely inside DOMContentLoaded
    document.addEventListener('DOMContentLoaded', () => {
      try {
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // DOM refs (guarded)
        const loadingOverlay = document.getElementById('loadingOverlay');
        const starsContainer = document.getElementById('starsContainer');
        const currentPhoto = document.getElementById('currentPhoto');
        const nameInput = document.getElementById('nameInput');
        const slugInput = document.getElementById('slugInput');
        const photoUrlInput = document.getElementById('photoUrlInput');
        const bioInput = document.getElementById('bioInput');
        const settingsForm = document.getElementById('settingsForm');
        const saveBtn = document.getElementById('saveBtn');
        const statusMessage = document.getElementById('statusMessage');
        const logoutBtn = document.querySelector('.btn-logout');
        const profileBtn = document.querySelector('.btn-profile');
        const oneTimeNote = document.getElementById('oneTimeNote');

        const editorModal = document.getElementById('editorModal');
        const modalCloseBtn = document.getElementById('modalCloseBtn');
        const modalFileInput = document.getElementById('modalFileInput');
        const editorCanvas = document.getElementById('editorCanvas');
        const ctx = editorCanvas ? editorCanvas.getContext('2d') : null;
        const zoomIn = document.getElementById('zoomIn');
        const zoomOut = document.getElementById('zoomOut');
        const rotateLeft = document.getElementById('rotateLeft');
        const rotateRight = document.getElementById('rotateRight');
        const resetBtn = document.getElementById('resetBtn');
        const applyBtnModal = document.getElementById('applyBtnModal');
        const confirmUploadBtn = document.getElementById('confirmUploadBtn');
        const cancelModalBtn = document.getElementById('cancelModalBtn');
        const modalMessages = document.getElementById('modalMessages');
        const detailsBox = document.getElementById('detailsBox');

        const editorCanvasExists = !!editorCanvas && !!ctx;
        if (!editorCanvasExists) console.warn('Editor canvas not found â€” editor disabled.');

        // editor state
        let img = null, imgURL = null, pos = {x:0,y:0}, dragging=false, lastPointer=null, scale=1, angle=0;
        window.__editedImageDataURL = null;
        let profilePhotoLocked = false;
        let currentUser = null;

        // helpers
        function safeShowStatus(msg, type='success') {
          try {
            if (!statusMessage) return;
            statusMessage.textContent = msg;
            statusMessage.className = 'status-message';
            if (type === 'success') statusMessage.classList.add('status-success');
            else statusMessage.classList.add('status-error');
            statusMessage.style.display = 'block';
            setTimeout(()=> { if (statusMessage) statusMessage.style.display='none'; }, 4500);
          } catch(e){ console.error(e); }
        }

        function createLoadingStars() {
          try {
            if (!starsContainer) return;
            starsContainer.innerHTML = '';
            for (let i=0;i<24;i++){
              const star = document.createElement('div');
              star.className = 'star';
              const x = Math.random()*100, y=Math.random()*100;
              star.style.left = x + '%'; star.style.top = y + '%';
              const s = Math.random()*3 + 1;
              star.style.width = s + 'px'; star.style.height = s + 'px';
              const d = (Math.random()*2 + 1.2).toFixed(2);
              star.style.setProperty('--duration', d + 's');
              starsContainer.appendChild(star);
            }
          } catch(e){ console.error('createLoadingStars error', e); }
        }

        // background stars simplified & resilient
        function initBgStars() {
          try {
            const canvas = document.getElementById('bgStars');
            if (!canvas) return;
            const ctx2 = canvas.getContext('2d');
            let w = canvas.width = window.innerWidth, h = canvas.height = window.innerHeight;
            const density = 0.00018;
            let stars = [];
            function rand(min,max){ return Math.random()*(max-min)+min; }
            function make(){ stars = []; const count = Math.round(w*h*density); for (let i=0;i<count;i++){ stars.push({ x:Math.random()*w, y:Math.random()*h, r:rand(0.3,1.6), a:Math.random()*0.7+0.2, phase:Math.random()*Math.PI*2 }); } }
            function onResize(){ w=canvas.width=innerWidth; h=canvas.height=innerHeight; make(); }
            window.addEventListener('resize', onResize);
            make();
            let last = performance.now();
            (function frame(now){
              const dt = now - last; last = now;
              ctx2.clearRect(0,0,w,h);
              for (let s of stars){
                s.phase += 0.005*(dt/16.67);
                const alpha = s.a * (0.5 + 0.5*Math.sin(s.phase));
                ctx2.beginPath();
                ctx2.globalAlpha = alpha;
                ctx2.fillStyle = 'white';
                ctx2.arc(s.x, s.y, s.r, 0, Math.PI*2);
                ctx2.fill();
                ctx2.globalAlpha = 1;
              }
              requestAnimationFrame(frame);
            })(last);
          } catch(e){ console.error('initBgStars error', e); }
        }

        // editor draw (guarded)
        function drawEditor() {
          try {
            if (!editorCanvasExists) return;
            const w = editorCanvas.width, h = editorCanvas.height;
            ctx.clearRect(0,0,w,h);
            ctx.fillStyle = '#000'; ctx.fillRect(0,0,w,h);
            if (!img) {
              ctx.fillStyle = '#333'; ctx.font = '16px system-ui'; ctx.textAlign = 'center';
              ctx.fillText('No image selected', w/2, h/2);
              return;
            }
            ctx.save();
            ctx.translate(w/2 + pos.x, h/2 + pos.y);
            ctx.rotate(angle);
            ctx.scale(scale, scale);
            ctx.drawImage(img, -img.width/2, -img.height/2);
            ctx.restore();
            // overlay circle
            ctx.beginPath(); ctx.lineWidth = 3; ctx.strokeStyle = 'rgba(255,255,255,0.6)';
            ctx.arc(w/2, h/2, Math.min(w,h)/2 - 6, 0, Math.PI*2); ctx.stroke();
            // darken outside
            ctx.save(); ctx.globalCompositeOperation = 'source-over'; ctx.fillStyle = 'rgba(0,0,0,0.45)';
            ctx.beginPath(); ctx.rect(0,0,w,h); ctx.arc(w/2,h/2,Math.min(w,h)/2 - 6,0,Math.PI*2,true); ctx.fill('evenodd'); ctx.restore();
          } catch(e){ console.error('drawEditor error', e); }
        }

        // pointer handlers (guarded)
        if (editorCanvasExists) {
          editorCanvas.addEventListener('pointerdown', (ev)=>{ if(!img) return; dragging=true; lastPointer={x:ev.clientX,y:ev.clientY}; try{ editorCanvas.setPointerCapture(ev.pointerId);}catch(e){} });
          editorCanvas.addEventListener('pointermove', (ev)=>{ if(!dragging) return; const dx = ev.clientX - lastPointer.x; const dy = ev.clientY - lastPointer.y; lastPointer={x:ev.clientX,y:ev.clientY}; pos.x += dx; pos.y += dy; drawEditor(); });
          editorCanvas.addEventListener('pointerup', (ev)=>{ dragging=false; try{ editorCanvas.releasePointerCapture(ev.pointerId);}catch(e){}});
          editorCanvas.addEventListener('pointercancel', ()=>{ dragging=false; });
          editorCanvas.addEventListener('wheel', (ev)=>{ ev.preventDefault(); const delta=-ev.deltaY; const f = 1 + (delta>0?0.06:-0.06); scale *= f; scale = Math.max(0.12, Math.min(8, scale)); drawEditor(); }, {passive:false});
        }

        // editor control hooks
        if (zoomIn) zoomIn.addEventListener('click', ()=>{ scale *= 1.12; drawEditor(); });
        if (zoomOut) zoomOut.addEventListener('click', ()=>{ scale /= 1.12; drawEditor(); });
        if (rotateLeft) rotateLeft.addEventListener('click', ()=>{ angle -= Math.PI/18; drawEditor(); });
        if (rotateRight) rotateRight.addEventListener('click', ()=>{ angle += Math.PI/18; drawEditor(); });
        if (resetBtn) resetBtn.addEventListener('click', ()=>{ scale=1; angle=0; pos={x:0,y:0}; drawEditor(); });

        // file selection in modal
        if (modalFileInput) modalFileInput.addEventListener('change', (e)=> {
          try {
            const f = e.target.files && e.target.files[0];
            if (!f) return;
            if (f.size > 6*1024*1024) { alert('File too large (max ~6MB)'); return; }
            if (imgURL) try{ URL.revokeObjectURL(imgURL); }catch(e){}
            imgURL = URL.createObjectURL(f);
            img = new Image();
            img.crossOrigin = "anonymous";
            img.onload = ()=> {
              // ensure sensible starting scale
              const baseScale = Math.min(editorCanvas.width / img.width, editorCanvas.height / img.height);
              scale = Math.min(1, Math.max(0.2, baseScale)) * 1.4;
              angle = 0; pos = {x:0,y:0}; drawEditor();
            };
            img.src = imgURL;
          } catch(e) { console.error('modalFileInput change error', e); }
        });

        // apply preview: produce circular dataURL
        if (applyBtnModal) applyBtnModal.addEventListener('click', ()=> {
          try {
            if (!img) return alert('Select image first');
            const outSize = 360;
            const out = document.createElement('canvas'); out.width = outSize; out.height = outSize;
            const octx = out.getContext('2d');
            octx.save(); octx.translate(outSize/2 + pos.x, outSize/2 + pos.y); octx.rotate(angle); octx.scale(scale, scale);
            octx.drawImage(img, -img.width/2, -img.height/2); octx.restore();
            const circ = document.createElement('canvas'); circ.width = outSize; circ.height = outSize; const cctx = circ.getContext('2d');
            cctx.save(); cctx.beginPath(); cctx.arc(outSize/2, outSize/2, outSize/2, 0, Math.PI*2); cctx.closePath(); cctx.clip(); cctx.drawImage(out,0,0); cctx.restore();
            const dataURL = circ.toDataURL('image/png');
            window.__editedImageDataURL = dataURL;
            if (modalMessages) modalMessages.innerHTML = '<div style="color:#bfffc9">Preview ready â€” click "Upload & Lock" to upload and lock the photo.</div>';
            if (currentPhoto) currentPhoto.src = dataURL; // soft preview
          } catch(e) { console.error('apply preview error', e); if (modalMessages) modalMessages.innerHTML = '<div style="color:#ffc9c9">Preview failed.</div>'; }
        });

        // single upsert call
        async function postUploadUpsert(fileName, base64) {
          try {
            const res = await fetch(FUNCTION_URL, { method:'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ fileName, base64, upsert: true }) });
            let body = null;
            try { body = await res.json(); } catch(e){ body = { ok: res.ok, status: res.status }; }
            return { ok: res.ok, status: res.status, body };
          } catch (err) { return { ok:false, error: err.message || String(err) }; }
        }

        // upload & lock (one-time)
        if (confirmUploadBtn) confirmUploadBtn.addEventListener('click', async ()=>{
          try {
            if (!currentUser) return alert('Not authenticated');
            const docRef = doc(db, 'usersPrivate', currentUser.uid);
            const snapshot = await getDoc(docRef);
            if (snapshot.exists() && snapshot.data().profilePhotoLocked) {
              profilePhotoLocked = true;
              if (editorModal) { editorModal.classList.remove('show'); editorModal.setAttribute('aria-hidden','true'); }
              safeShowStatus('Profile photo is already locked. You cannot change it again.', 'error');
              return;
            }
            const confirmed = window.confirm('You can change profile picture ONLY ONCE. Proceed to upload & lock?');
            if (!confirmed) return;
            let dataURL = window.__editedImageDataURL;
            if (!dataURL) return alert('Create a preview first (Apply Preview).');
            const base64 = dataURL.split(',')[1];
            const fileName = `${currentUser.uid}.png`;
            if (modalMessages) modalMessages.innerHTML = '<div style="color:#bde0ff">Uploading...</div>';
            const attempt = await postUploadUpsert(fileName, base64);
            if (attempt.ok && (!attempt.body || !attempt.body.error)) {
              const newUrl = `${SUPABASE_URL}/storage/v1/object/public/images/${fileName}?v=${Date.now()}`;
              await updateDoc(docRef, {
                profilePhotoUrl: newUrl,
                profilePhotoLocked: true,
                profilePhotoLockedAt: serverTimestamp()
              });
              if (photoUrlInput) photoUrlInput.value = newUrl;
              if (currentPhoto) currentPhoto.src = newUrl;
              profilePhotoLocked = true;
              if (modalMessages) modalMessages.innerHTML = '<div style="color:#bfffc9">Uploaded & locked successfully!</div>';
              if (editorModal) { editorModal.classList.remove('show'); editorModal.setAttribute('aria-hidden','true'); }
              if (oneTimeNote) { oneTimeNote.textContent = 'Profile photo is locked â€” you cannot change it again.'; oneTimeNote.style.color = '#ffc9c9'; }
              safeShowStatus('Profile photo uploaded and locked!', 'success');
              return;
            }
            const msg = (attempt.body && (attempt.body.error || attempt.body.message)) || attempt.error || `HTTP ${attempt.status}`;
            if (/resource\s+already\s+exists|already exists|409|exists/i.test(String(msg))) {
              if (modalMessages) modalMessages.innerHTML = `<div style="color:#ffc9c9">Upload blocked: resource already exists on server. No further attempts will be made.</div>`;
              safeShowStatus('Upload blocked: resource already exists on server.', 'error');
              return;
            }
            if (modalMessages) modalMessages.innerHTML = `<div style="color:#ffc9c9">Upload failed: ${String(msg)}</div>`;
            safeShowStatus(`Upload failed: ${String(msg)}`, 'error');
          } catch (e) {
            console.error('Upload exception', e);
            if (modalMessages) modalMessages.innerHTML = `<div style="color:#ffc9c9">Upload exception: ${e.message || e}</div>`;
            safeShowStatus(`Upload failed: ${e.message || e}`, 'error');
          }
        });

        // open modal when clicking photo (if allowed)
        if (currentPhoto) currentPhoto.addEventListener('click', async ()=>{
          try {
            if (!currentUser) return alert('Login required');
            if (profilePhotoLocked) { safeShowStatus('Profile photo is locked â€” cannot change it.', 'error'); return; }
            if (modalMessages) modalMessages.innerHTML = '';
            window.__editedImageDataURL = null;
            img = null; imgURL = null; pos={x:0,y:0}; scale=1; angle=0;
            if (editorModal) { editorModal.classList.add('show'); editorModal.setAttribute('aria-hidden','false'); }
          } catch(e){ console.error(e); }
        });

        // close modal
        if (modalCloseBtn) modalCloseBtn.addEventListener('click', ()=> { if (editorModal) { editorModal.classList.remove('show'); editorModal.setAttribute('aria-hidden','true'); } });
        if (cancelModalBtn) cancelModalBtn.addEventListener('click', ()=> { if (editorModal) { editorModal.classList.remove('show'); editorModal.setAttribute('aria-hidden','true'); } });

        // save other profile fields (now updates usersPrivate AND publicProfiles)
        async function updateProfile() {
          try {
            if (!currentUser) return;
            const name = (nameInput?.value || '').trim();
            const slug = (slugInput?.value || '').trim();
            const photoUrl = (photoUrlInput?.value || '').trim();
            const bio = (bioInput?.value || '').trim();
            const visibilityCheckbox = document.getElementById('visibilityCheckbox');
            const visibility = !!(visibilityCheckbox && visibilityCheckbox.checked);

            if (!name || !slug) { safeShowStatus('Name and slug are required.', 'error'); return; }
            if (saveBtn) { saveBtn.disabled = true; saveBtn.textContent = 'Saving...'; }

            // Update usersPrivate (doc id = uid)
            const privateRef = doc(db, 'usersPrivate', currentUser.uid);
            await updateDoc(privateRef, {
              name,
              slug,
              profilePhotoUrl: photoUrl || null,
              bio,
              termsAccepted: true,
              termsTimestamp: serverTimestamp(),
              updatedAt: serverTimestamp()
            });

            // Update publicProfiles (doc id = uid) â€” create/merge if doesn't exist
            const publicRef = doc(db, 'publicProfiles', currentUser.uid);
            await setDoc(publicRef, {
              name,
              slug,
              bio,
              visibility,
              updatedAt: serverTimestamp()
            }, { merge: true });

            if (photoUrl) currentPhoto.src = photoUrl;
            safeShowStatus('Profile updated successfully!', 'success');
          } catch (err) {
            console.error('Error updating profile', err);
            safeShowStatus('Error saving profile data.', 'error');
          } finally { if (saveBtn) { saveBtn.disabled=false; saveBtn.textContent='Save Changes'; } }
        }
        if (settingsForm) settingsForm.addEventListener('submit', (e)=>{ e.preventDefault(); updateProfile(); });

        // load user profile (extended to read publicProfiles.visibility)
        async function loadProfile(uid) {
          try {
            const docRef = doc(db, 'usersPrivate', uid);
            const snap = await getDoc(docRef);
            if (!snap.exists()) { safeShowStatus('Profile not found.', 'error'); return; }
            const data = snap.data();
            if (currentPhoto) currentPhoto.src = data.profilePhotoUrl || 'https://via.placeholder.com/150';
            if (nameInput) nameInput.value = data.name || '';
            if (slugInput) slugInput.value = data.slug || '';
            if (photoUrlInput) photoUrlInput.value = data.profilePhotoUrl || '';
            if (bioInput) bioInput.value = data.bio || '';
            profilePhotoLocked = !!data.profilePhotoLocked;

            // get visibility from publicProfiles (defaults false if missing)
            try {
              const publicRef = doc(db, 'publicProfiles', uid);
              const publicSnap = await getDoc(publicRef);
              const vis = publicSnap.exists() ? !!publicSnap.data().visibility : false;
              const visibilityCheckbox = document.getElementById('visibilityCheckbox');
              if (visibilityCheckbox) visibilityCheckbox.checked = vis;
            } catch(e) {
              console.warn('Could not load publicProfiles visibility', e);
              const visibilityCheckbox = document.getElementById('visibilityCheckbox');
              if (visibilityCheckbox) visibilityCheckbox.checked = false;
            }

            if (profilePhotoLocked && oneTimeNote) { oneTimeNote.textContent = 'Profile photo is locked â€” you cannot change it again.'; oneTimeNote.style.color = '#ffc9c9'; }
            else if (oneTimeNote) { oneTimeNote.textContent = 'Click your profile photo to open the upload modal. You can change only once.'; oneTimeNote.style.color = '#a0a0d0'; }
          } catch(e){ console.error('loadProfile error', e); safeShowStatus('Error loading profile', 'error'); }
        }

        // auth state listener
        onAuthStateChanged(auth, async (user) => {
          try {
            if (!user) { location.href = 'index.html'; return; }
            currentUser = user;
            await loadProfile(user.uid);
            // hide loading overlay smoothly
            if (loadingOverlay) {
              loadingOverlay.classList.add('hidden');
              loadingOverlay.style.display = 'none';
            }
          } catch(e){ console.error('onAuthStateChanged error', e); }
        });

        // logout/profile buttons
        if (logoutBtn) logoutBtn.addEventListener('click', ()=> signOut(auth).then(()=>location.href='index.html').catch(err=>{ console.error(err); safeShowStatus('Sign out failed', 'error'); }));
        if (profileBtn) profileBtn.addEventListener('click', ()=> location.href='user_profile.html');

        // initial visuals
        try { createLoadingStars(); initBgStars(); if (editorCanvasExists) drawEditor(); } catch(e){ console.error('visual init error', e); }

      } catch (e) {
        console.error('Initialization failed', e);
        const boot = document.getElementById('bootError');
        if (boot) { boot.style.display='block'; boot.textContent = 'Failed during initialization â€” check console.'; }
      }
    }); // DOMContentLoaded
  </script>
</body>
</html>