<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TeamGalaxy â€” My Posts</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    /* Updated theme based on your detailed color palette */
    :root {
      --bg: #0a0e17;
      --card: rgba(24, 31, 43, 0.95);
      --card-end: rgba(32, 40, 57, 0.95);
      --surface: #161b28;
      --surface-alt: #1c2236;
      --muted: #d0d0d0;
      --text: #ffffff;
      --accent1: #64c2ff; /* Cyan */
      --accent2: #fab84f; /* Gold */
      --danger: #ff5b5b; /* Red */
      --border: rgba(255, 255, 255, 0.1);
      --hover-bg: rgba(100, 194, 255, 0.1);
      --success: #4caf50;
      --icon-color: #afeafd;
    }

    body {
      margin: 0;
      font-family: 'Segoe UI', system-ui, Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      position: relative;
      overflow-x: hidden;
    }

    /* Stars background */
    body::before {
      content: "";
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-image: 
        radial-gradient(2px 2px at 10% 20%, #fff, transparent),
        radial-gradient(1px 1px at 30% 40%, #64c2ff, transparent),
        radial-gradient(1.5px 1.5px at 50% 60%, #fab84f, transparent),
        radial-gradient(1px 1px at 70% 80%, #fff, transparent),
        radial-gradient(2px 2px at 90% 10%, #64c2ff, transparent),
        radial-gradient(1px 1px at 20% 80%, #fab84f, transparent),
        radial-gradient(1.5px 1.5px at 80% 30%, #fff, transparent),
        radial-gradient(1px 1px at 60% 70%, #64c2ff, transparent),
        radial-gradient(2px 2px at 40% 10%, #fab84f, transparent),
        radial-gradient(1px 1px at 95% 50%, #fff, transparent);
      background-repeat: repeat;
      background-size: 100% 100%;
      z-index: -1;
      animation: sparkle 20s linear infinite;
    }

    @keyframes sparkle {
      0% { transform: translateY(0); }
      100% { transform: translateY(-100vh); }
    }

    /* Header */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 2rem;
      background: rgba(10, 10, 35, 0.95);
      backdrop-filter: blur(15px);
      border-bottom: 1px solid #5a4fcf;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .logo {
      font-size: 2rem;
      font-weight: bold;
      color: #8a7cff;
      letter-spacing: 1.5px;
      text-shadow: 0 0 10px rgba(138, 124, 255, 0.5);
      background: linear-gradient(45deg, #8a7cff, #d66efd);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .public-label {
      font-size: 1.8rem;
      font-weight: bold;
      color: #8a7cff;
      letter-spacing: 1.5px;
      text-shadow: 0 0 10px rgba(138, 124, 255, 0.5);
      background: linear-gradient(45deg, #8a7cff, #d66efd);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .header {
        flex-direction: column;
        gap: 1.2rem;
        padding: 1.2rem;
      }
    }

    .container {
      max-width: 900px;
      margin: 2rem auto;
      padding: 0 1.5rem;
      position: relative;
      z-index: 1;
      flex: 1;
      width: 100%;
      box-sizing: border-box;
    }

    /* Create Post button styling */
    .create-post-btn {
      background: var(--accent2);
      color: #000;
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 6px;
      font-weight: 600;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 2px 5px rgba(250, 184, 79, 0.3);
    }

    .create-post-btn:hover {
      background: #e9c46a; /* Slightly darker gold on hover */
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(250, 184, 79, 0.4);
    }

    .card {
      background: linear-gradient(145deg, var(--card) 0%, var(--card-end) 100%);
      border-radius: 8px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      border: 1px solid var(--border);
      width: 100%;
      box-sizing: border-box;
    }

    .meta {
      color: var(--muted);
      font-size: 0.875rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .title {
      font-size: 1.25rem;
      font-weight: 600;
      margin: 0.75rem 0;
      color: var(--text);
    }

    .snippet {
      color: var(--muted);
      margin-top: 0.5rem;
    }

    .row {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }

    button {
      cursor: pointer;
      border: 0;
      padding: 0.5rem 1rem;
      border-radius: 6px;
      font-weight: 500;
      font-size: 0.875rem;
      transition: all 0.2s ease;
    }

    .btn-primary {
      background: var(--accent1);
      color: #fff;
    }

    .btn-primary:hover {
      background: var(--accent2);
      color: #000;
    }

    .btn-ghost {
      background: transparent;
      color: var(--muted);
      border: 1px solid var(--border);
    }

    .btn-ghost:hover {
      background: var(--hover-bg);
      color: var(--accent1);
    }

    .small {
      font-size: 0.875rem;
      color: var(--muted);
    }

    .tags {
      display: flex;
      gap: 0.5rem;
      margin-top: 0.75rem;
      flex-wrap: wrap;
    }

    .tag {
      background: rgba(255, 255, 255, 0.05);
      padding: 0.25rem 0.75rem;
      border-radius: 999px;
      font-size: 0.75rem;
      color: var(--accent2);
    }

    .vote {
      display: inline-flex;
      gap: 0.25rem;
      align-items: center;
    }

    .count {
      font-weight: 600;
      min-width: 1.5rem;
      text-align: center;
    }

    .actions {
      margin-top: 1rem;
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }

    .center {
      display: flex;
      justify-content: center;
      margin: 1.5rem 0;
    }

    .link-like {
      background: transparent;
      color: var(--accent1);
      border: 0;
      cursor: pointer;
      padding: 0.25rem;
    }

    .link-like:hover {
      color: var(--accent2);
    }

    .comment-form-container {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 12px;
      padding: 1rem;
      border: 1px solid rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      margin-top: 1rem;
      box-sizing: border-box;
      width: 100%;
      overflow: hidden;
    }

    .comment-input-section {
      width: 100%;
    }

    .comment-label {
      display: block;
      margin-bottom: 0.5rem;
      color: #aaa;
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .comment-input-wrapper {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      width: 100%;
    }

    #commentInput {
      width: 100%;
      min-height: 80px;
      padding: 0.75rem;
      border-radius: 8px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      background: rgba(0, 0, 0, 0.2);
      color: white;
      font-family: inherit;
      font-size: 1rem;
      resize: vertical;
      transition: all 0.3s ease;
      box-sizing: border-box;
    }

    #commentInput:focus {
      outline: none;
      border-color: #00bcd4;
      box-shadow: 0 0 0 2px rgba(0, 188, 212, 0.2);
      background: rgba(0, 0, 0, 0.3);
    }

    .comment-actions {
      display: flex;
      gap: 0.5rem;
      align-items: center;
      width: 100%;
    }

    .comment-submit-btn {
      background: linear-gradient(45deg, #00bcd4, #0097a7);
      border: none;
      color: white;
      padding: 0.5rem 1rem;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    .comment-submit-btn:hover {
      background: linear-gradient(45deg, #0097a7, #007888);
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(0, 188, 212, 0.3);
    }

    .comment-clear-btn {
      background: transparent;
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: #aaa;
      padding: 0.5rem 1rem;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .comment-clear-btn:hover {
      background: rgba(255, 255, 255, 0.1);
      color: white;
      border-color: rgba(255, 255, 255, 0.3);
    }

    .comment-status {
      font-size: 0.85rem;
      color: #00bcd4;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      background: rgba(0, 188, 212, 0.1);
      min-width: 80px;
      text-align: right;
    }

    .comment {
      padding: 1rem;
      border-radius: 6px;
      background: var(--card);
      margin-bottom: 0.75rem;
      border: 1px solid var(--border);
    }

    .muted {
      color: var(--muted);
    }

    /* Optimized Skeleton loading */
    .skeleton {
      background: linear-gradient(90deg, #1a2232 25%, #232e44 50%, #1a2232 75%);
      background-size: 200% 100%;
      animation: skeleton-loading 1.5s infinite;
      border-radius: 4px;
    }

    @keyframes skeleton-loading {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }

    .skeleton-text {
      height: 0.875rem;
      margin-bottom: 0.5rem;
      width: 100%;
    }

    .skeleton-title {
      height: 1.25rem;
      margin: 0.75rem 0;
      width: 100%;
    }

    .skeleton-tag {
      height: 1.5rem;
      width: 4rem;
      border-radius: 999px;
      margin-right: 0.5rem;
      display: inline-block;
    }

    .skeleton-circle {
      width: 2.5rem;
      height: 2.5rem;
      border-radius: 50%;
    }

    /* Loading spinner */
    .spinner {
      width: 1rem;
      height: 1rem;
      border: 2px solid transparent;
      border-top: 2px solid var(--accent1);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      display: inline-block;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Vote loading state */
    .vote-loading {
      opacity: 0.7;
      pointer-events: none;
    }

    .vote-loading .spinner {
      margin-right: 0.25rem;
    }

    /* Post skeleton */
    .post-skeleton {
      padding: 1.5rem;
      width: 100%;
      box-sizing: border-box;
    }

    .post-skeleton .meta {
      margin-bottom: 1rem;
    }

    /* Comment skeleton */
    .comment-skeleton {
      padding: 1rem;
      margin-bottom: 0.75rem;
      width: 100%;
      box-sizing: border-box;
    }

    /* User info in header */
    .user-info {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      position: relative;
    }

    .avatar {
      width: 2.5rem;
      height: 2.5rem;
      border-radius: 50%;
      border: 2px solid var(--accent1);
      object-fit: cover;
      cursor: pointer;
      display: inline-block;
    }

    /* small avatar used in feed/cards */
    .avatar.small {
      width: 1.5rem;
      height: 1.5rem;
      border-radius: 50%;
      border: 1px solid var(--accent1);
      object-fit: cover;
      display:inline-block;
      vertical-align: middle;
    }
    /* Dropdown menu */
    .dropdown {
      position: absolute;
      top: 100%;
      right: 0;
      background: rgba(29, 35, 54, 0.95);
      border-radius: 6px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.2);
      z-index: 100;
      min-width: 180px;
      display: none;
    }

    .dropdown.show {
      display: block;
    }

    .dropdown-item {
      display: block;
      padding: 0.75rem 1rem;
      color: #e0e0e0;
      text-decoration: none;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }

    .dropdown-item:hover {
      background: var(--hover-bg);
      color: var(--accent1);
    }

    .dropdown-item:last-child {
      border-bottom: none;
      border-radius: 0 0 6px 6px;
    }

    /* Footer */
    .footer {
      background: rgba(10, 10, 35, 0.95);
      padding: 3rem 2rem 2rem;
      margin-top: auto;
      border-top: 1px solid #5a4fcf;
      box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.3);
      width: 100%;
      flex-shrink: 0;
    }

    .footer-content {
      max-width: 1200px;
      margin: 0 auto;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 3rem;
    }

    .footer-about-title {
      font-size: 1.1rem;
      color: #8a7cff;
      margin-bottom: 1rem;
      font-weight: 600;
    }

    .footer-about-text {
      color: #a0a0d0;
      line-height: 1.6;
      font-size: 0.90rem;
    }

    .footer-links {
      display: flex;
      flex-direction: column;
      gap: 0.8rem;
    }

    .footer-links a {
      color: #a0a0d0;
      text-decoration: none;
      font-size: 0.95rem;
      transition: color 0.3s ease;
    }

    .footer-links a:hover {
      color: #8a7cff;
      text-decoration: underline;
    }

    .rocket-frame {
      margin-top: 2rem;
      padding: 1.5rem;
      border: 2px solid #5a4fcf;
      border-radius: 12px;
      background: rgba(20, 20, 40, 0.5);
      position: relative;
      overflow: hidden;
    }

    .rocket-text {
      font-size: 1.8rem;
      font-weight: bold;
      color: #8a7cff;
      text-align: center;
      text-shadow: 0 0 15px rgba(138, 124, 255, 0.6);
      background: linear-gradient(45deg, #8a7cff, #d66efd, #8a7cff);
      background-size: 200% auto;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      animation: shimmer 3s linear infinite;
      font-family: 'Arial Rounded MT Bold', 'Segoe UI', sans-serif;
    }

    @keyframes shimmer {
      0% { background-position: -200% center; }
      100% { background-position: 200% center; }
    }

    /* Responsive improvements */
    @media (max-width: 768px) {
      .footer-content {
        grid-template-columns: 1fr;
        gap: 2rem;
      }
      
      .container {
        padding: 0 1rem;
      }
      
      .comment-actions {
        flex-wrap: wrap;
      }
      
      .comment-status {
        margin-left: 0;
        margin-top: 0.5rem;
      }
    }

html, body { height: 100%; }   /* ensures flex/min-height math works */
body { display: flex; flex-direction: column; min-height: 100vh; }

.container { flex: 1 0 auto; }  /* container grows, footer stays below it */

footer.footer {
  position: relative;    /* ensure not fixed inside other rules */
  display: block;
  width: 100%;
  min-height: 120px;     /* avoid 0x0 collapse */
  z-index: 20;
  box-sizing: border-box;
}
  </style>
</head>
<body>
    <!-- Header -->
  <header class="header">
    <div class="logo">GalaxyWeb</div>
    <div class="public-label">Public Profile</div>
  </header>

  <div class="container">
    <!-- Create Post button -->
    <div style="text-align: center; margin-bottom: 1.5rem;">
      <button class="create-post-btn">Create Post</button>
    </div>

    <!-- FEED (main page) -->
    <div id="feedView" style="display:none">
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <h2 style="margin:0">My Posts</h2>
            <div class="small muted">Sorted by publish time â€” newest first</div>
          </div>
          <div><button id="refreshBtn" class="btn-ghost"><i class="fas fa-sync-alt"></i> Refresh</button></div>
        </div>
      </div>

      <div id="postsList"></div>
      <div class="center"><button id="loadMoreBtn" class="btn-ghost">Load more</button></div>
    </div>

    <!-- SINGLE POST VIEW -->
    <div id="postView" style="display:none">
      <div style="margin-bottom:1rem;"><button id="backToFeed" class="link-like"><i class="fas fa-arrow-left"></i> Back to feed</button></div>
      <div id="postContainer"></div>

      <div class="card" style="margin-top:1rem">
        <h3 style="margin:0 0 0.5rem 0">Comments</h3>
        <div id="commentsList" style="max-height:420px;overflow:auto;margin-bottom:0.5rem"></div>

        <div id="commentFormWrap" class="comment-form-container">
          <div class="comment-input-section">
            <div class="small muted comment-label">Add a comment</div>
            <div class="comment-input-wrapper">
              <textarea id="commentInput" placeholder="Share your thoughts..."></textarea>
              <div class="comment-actions">
                <button id="submitComment" class="btn-primary comment-submit-btn">Post</button>
                <button id="clearComment" class="btn-ghost comment-clear-btn">Clear</button>
                <div id="commentStatus" class="comment-status" style="margin-left:auto"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Dropdown menu (kept in container but positioned via JS) -->
    <div id="dropdownMenu" class="dropdown" aria-hidden="true">
      <a href="#" class="dropdown-item" id="profileLink">Profile</a>
      <a href="#" class="dropdown-item" id="settingsLink">Settings</a>
      <a href="#" class="dropdown-item" id="signOutLink">Sign Out</a>
    </div>
  </div> <!-- /.container -->

  <!-- FOOTER (intentionally OUTSIDE .container and outside #postView/#feedView) -->
  <footer class="footer">
    <div class="footer-content">
      <div class="footer-left">
        <div class="footer-about-title">About TeamGalaxy</div>
        <div class="footer-about-text">
          TeamGalaxy is an innovative gaming and creative community, united by passion and the spirit of collaboration. We host tournaments, share design ideas, and grow talents together â€” join now to explore the Galaxy!
        </div>
      </div>
      <div class="footer-right">
        <div class="footer-links">
          <a href="../legal/privacy_policy.html">Privacy Policy</a>
          <a href="../legal/terms_and_conditions.html">Terms & Conditions</a>
          <a href="../about_us.html">About</a>
        </div>
        <div class="rocket-frame">
          <div class="rocket-text">ðŸš€ ROCKET ðŸš€</div>
        </div>
      </div>
    </div>
  </footer>

  <!-- Defensive JS: if footer accidentally ends up inside a hidden parent, move it to body -->
  <script>
    (function ensureFooterVisible(){
      // run after DOM loaded (safe even if script already at bottom)
      const tryMove = () => {
        const footer = document.querySelector('footer.footer');
        if(!footer) return;
        // if any ancestor has display:none, move footer to body
        let p = footer.parentElement;
        let hiddenAncestor = null;
        while(p && p !== document.body) {
          if (getComputedStyle(p).display === 'none') { hiddenAncestor = p; break; }
          p = p.parentElement;
        }
        if(hiddenAncestor) {
          document.body.appendChild(footer);
          // restore sane styles
          footer.style.position = 'relative';
          footer.style.display = 'block';
          footer.style.width = '100%';
          footer.style.minHeight = footer.style.minHeight || '120px';
          footer.style.zIndex = '20';
          // remove debug outline if any
          footer.style.outline = footer.style.outline || 'none';
          console.log('Footer moved out of hidden ancestor to <body>');
        }
      };

      if (document.readyState === 'complete' || document.readyState === 'interactive') tryMove();
      else document.addEventListener('DOMContentLoaded', tryMove);
      // also try again after a short delay (in case your script toggles views after load)
      setTimeout(tryMove, 400);
    })();
  </script>
<script type="module">
  // ---------- CONFIG (do not change unless needed) ----------
  const firebaseConfig = {
    apiKey: "AIzaSyD0Yv_bQjxi2_kjzPR4XHOlaB7Sb6NRVUc",
    authDomain: "teamgalaxy-77344.firebaseapp.com",
    projectId: "teamgalaxy-77344",
    storageBucket: "teamgalaxy-77344.firebasestorage.app",
    messagingSenderId: "770256225320",
    appId: "1:770256225320:web:5a363ebd757de6cde3a11d",
    measurementId: "G-6C2W9NSNCH"
  };
  const RECAPTCHA_SITE_KEY = "6Ld395IrAAAAAIvG4gyf0vUJeI_jKOsI9XVn0jUx";

  // ---------- Firebase imports (v11.9.0) ----------
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.9.0/firebase-app.js';
  import { initializeAppCheck, ReCaptchaV3Provider } from 'https://www.gstatic.com/firebasejs/11.9.0/firebase-app-check.js';
  import {
    getFirestore, collection, query, orderBy, limit, startAfter, getDocs,
    doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot,
    where, serverTimestamp, runTransaction, increment
  } from 'https://www.gstatic.com/firebasejs/11.9.0/firebase-firestore.js';
  import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/11.9.0/firebase-auth.js';

  // ---------- initialize ----------
  const app = initializeApp(firebaseConfig);
  try {
    initializeAppCheck(app, {
      provider: new ReCaptchaV3Provider(RECAPTCHA_SITE_KEY),
      isTokenAutoRefreshEnabled: true
    });
    console.log('App Check initialized');
  } catch(e) { console.warn('App Check problem', e); }

  const db = getFirestore(app);
  const auth = getAuth(app);
  const provider = new GoogleAuthProvider();

  // ---------- page-state ----------
  const postsListEl = document.getElementById('postsList');
  const feedView = document.getElementById('feedView');
  const postView = document.getElementById('postView');
  const postContainer = document.getElementById('postContainer');
  const loadMoreBtn = document.getElementById('loadMoreBtn');
  const refreshBtn = document.getElementById('refreshBtn');
  const backToFeed = document.getElementById('backToFeed');
  const commentInput = document.getElementById('commentInput');
  const submitComment = document.getElementById('submitComment');
  const commentsList = document.getElementById('commentsList');
  const commentStatus = document.getElementById('commentStatus');
  const clearComment = document.getElementById('clearComment');
  const createPostBtn = document.querySelector('.create-post-btn');
  const dropdownMenu = document.getElementById('dropdownMenu');
  const profileLink = document.getElementById('profileLink');
  const settingsLink = document.getElementById('settingsLink');
  const signOutLink = document.getElementById('signOutLink');
  const logoutBtn = document.getElementById('logoutBtn');
  const settingsBtn = document.getElementById('settingsBtn');

  let lastVisible = null;
  const PAGE_SIZE = 8;
  let currentUser = null;
  let currentUserProfile = null; // from /users/{uid} if exists
  let currentPostId = null;
  let commentsUnsub = null;
  let isVoting = false; // Track if a vote is in progress
  let authInitialized = false;

  // Determine URL params: postId and profileSlug
  const urlParams = new URLSearchParams(window.location.search);
  const requestedPostId = urlParams.get('postId');

  // support ?slug=xxx OR weird ?=xxx format (the value after '=' is the slug)
  let profileSlug = null;
  if (!requestedPostId) {
    profileSlug = urlParams.get('slug') || (function(){
      const raw = window.location.search || '';
      if (raw.startsWith('?=')) {
        // take everything after '?=' until & or end
        return raw.slice(2).split('&')[0] || null;
      }
      // Also handle case where entire search is like "?abcdef" (no equals) â€” not expected but safe:
      if (raw.startsWith('?') && raw.indexOf('=') === -1 && raw.length > 1) {
        return raw.slice(1).split('&')[0];
      }
      return null;
    })();
  }

  // ---------- small helpers ----------
  function timeAgo(ts) {
    if (!ts) return '';
    const d = ts.toDate ? ts.toDate() : new Date(ts);
    const diff = Math.floor((Date.now() - d.getTime())/1000);
    if (diff < 60) return diff + 's';
    if (diff < 3600) return Math.floor(diff/60) + 'm';
    if (diff < 86400) return Math.floor(diff/3600) + 'h';
    return Math.floor(diff/86400) + 'd';
  }
  function snippet(text, n=220){ return (text||'').length>n ? text.slice(0,n)+'â€¦' : (text||''); }

  // Escape HTML to prevent XSS
  function escapeHTML(s){
    return String(s || '')
      .replaceAll('&','&amp;')
      .replaceAll('<','&lt;')
      .replaceAll('>','&gt;')
      .replaceAll('"','&quot;')
      .replaceAll("'",'&#039;');
  }

  // Generate initials from name
  function getInitials(name) {
    return name ? name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2) : 'U';
  }

  // Show skeleton loading for posts
  function renderPostSkeletons(count) {
    let skeletonsHtml = '';
    for (let i = 0; i < count; i++) {
      skeletonsHtml += `
        <div class="card post-skeleton">
          <div class="meta">
            <div class="skeleton skeleton-circle"></div>
            <div class="skeleton skeleton-text" style="width: 120px;"></div>
          </div>
          <div class="skeleton skeleton-title"></div>
          <div class="skeleton skeleton-text"></div>
          <div class="skeleton skeleton-text" style="width: 80%;"></div>
          <div class="tags">
            <span class="skeleton-tag"></span>
            <span class="skeleton-tag"></span>
          </div>
          <div class="actions">
            <div class="skeleton skeleton-text" style="width: 80px; height: 30px;"></div>
            <div style="margin-left: auto;">
              <div class="skeleton skeleton-text" style="width: 120px; height: 30px;"></div>
            </div>
          </div>
        </div>
      `;
    }
    postsListEl.innerHTML = skeletonsHtml;
  }
  // Show skeleton loading for comments
  function renderCommentSkeletons(count) {
    let skeletonsHtml = '';
    for (let i = 0; i < count; i++) {
      skeletonsHtml += `
        <div class="comment-skeleton">
          <div class="skeleton skeleton-text" style="width: 100px; margin-bottom: 0.5rem;"></div>
          <div class="skeleton skeleton-text"></div>
          <div class="skeleton skeleton-text" style="width: 80%;"></div>
        </div>
      `;
    }
    commentsList.innerHTML = skeletonsHtml;
  }

  // Show skeleton for post view
  function renderPostViewSkeleton() {
    postContainer.innerHTML = `
      <div class="card post-skeleton">
        <div class="meta">
          <div class="skeleton skeleton-circle"></div>
          <div class="skeleton skeleton-text" style="width: 120px;"></div>
        </div>
        <div class="skeleton skeleton-title" style="width: 80%;"></div>
        <div class="skeleton skeleton-text"></div>
        <div class="skeleton skeleton-text"></div>
        <div class="skeleton skeleton-text" style="width: 60%;"></div>
        <div class="tags">
          <span class="skeleton-tag"></span>
          <span class="skeleton-tag"></span>
        </div>
        <div class="actions">
          <div class="skeleton skeleton-text" style="width: 80px; height: 30px;"></div>
        </div>
      </div>
    `;

    // Also render comment skeletons
    renderCommentSkeletons(3);
  }

  // ---------- auth ----------
  async function signIn() {
    try {
      await signInWithPopup(auth, provider);
    }
    catch(e){
      console.error('Signin error', e);
      alert('Signin failed: ' + e.message);
    }
  }

  // Optimized auth state listener with loading state
  onAuthStateChanged(auth, async (user) => {
    currentUser = user;
    authInitialized = true;

    if (user) {
      // try read existing users/{uid} doc for name/email
      try {
        const udocRef = doc(db,'users', user.uid);
        const uSnap = await getDoc(udocRef);
        if (uSnap.exists()) {
          currentUserProfile = uSnap.data();
        } else {
          currentUserProfile = { name: user.displayName || null, email: user.email || null, photoURL: user.photoURL || null };
        }
      } catch(e) {
        console.warn('users read failed', e);
        currentUserProfile = { name: user.displayName || null, email: user.email || null, photoURL: user.photoURL || null };
      }

      // place avatar image (use photoURL if available, else placeholder initials image)
      const avatarSrc = user.photoURL || (`https://via.placeholder.com/80/444444/ffffff?text=${encodeURIComponent(getInitials(currentUserProfile?.name || user.email))}`);
      document.querySelector('.header-buttons').innerHTML = `
        <button class="btn btn-settings" id="settingsBtn">Settings</button>
        <button class="btn btn-logout" id="logoutBtn">Log Out</button>
      `;

      // Re-attach event listeners for the new buttons
      document.getElementById('logoutBtn').addEventListener('click', () => signOut(auth));
      document.getElementById('settingsBtn').addEventListener('click', () => {
        window.location.href = 'settings.html';
      });
    } else {
      document.querySelector('.header-buttons').innerHTML = `
        <button class="btn btn-settings" id="settingsBtn">Settings</button>
        <button class="btn btn-logout" id="logoutBtn">Log In</button>
      `;

      // Re-attach event listeners for the new buttons
      document.getElementById('logoutBtn').addEventListener('click', signIn);
      document.getElementById('settingsBtn').addEventListener('click', () => {
        window.location.href = 'settings.html';
      });
      currentUserProfile = null;
    }

    // Re-render feed to reflect auth state
    if (currentPostId) renderPostView(currentPostId);
    else {
      // refreshFeed behaviour handles both profileSlug (public) and user posts
      refreshFeed(true);
    }
  });

  // Close dropdown when clicking outside
  document.addEventListener('click', (e) => {
    if (!dropdownMenu.contains(e.target) && !e.target.classList.contains('avatar') && e.target.id !== 'headerAvatar') {
      dropdownMenu.classList.remove('show');
      dropdownMenu.setAttribute('aria-hidden','true');
    }
  });

  // Dropdown item event listeners
  profileLink.addEventListener('click', (e) => {
    e.preventDefault();
    window.location.href = 'profile.html';
    dropdownMenu.classList.remove('show');
  });

  settingsLink.addEventListener('click', (e) => {
    e.preventDefault();
    window.location.href = 'settings.html';
    dropdownMenu.classList.remove('show');
  });

  signOutLink.addEventListener('click', (e) => {
    e.preventDefault();
    signOut(auth);
    dropdownMenu.classList.remove('show');
  });

  // Create Post button functionality
  createPostBtn.addEventListener('click', () => {
    if (!currentUser) {
      alert('Sign in to create a post');
      return;
    }
    window.location.href = '/teamgalaxy/tools/create_post.html';
  });

  // ---------- routing: if ?postId=... show single post view ----------
  if (requestedPostId) {
    // show single post page
    feedView.style.display = 'none';
    postView.style.display = 'block';
    currentPostId = requestedPostId;
    renderPostView(requestedPostId);
  } else {
    // show feed (either profileSlug public feed OR currentUser posts)
    feedView.style.display = 'block';
    postView.style.display = 'none';
    // call to refreshFeed should wait for auth init only for non-public-case;
    // but we want it to run now (refreshFeed internally handles whether currentUser is required).
    refreshFeed(true);
  }

  // ---------- FEED: fetch posts (paged) ----------
  async function refreshFeed(reset=false) {
    if (reset) {
      lastVisible = null;
      renderPostSkeletons(4); // Show 4 skeleton loaders
    }

    const postsRef = collection(db, 'posts');
    let q;

    // If profileSlug is provided in URL -> public profile view: fetch posts with slug == profileSlug
    if (profileSlug) {
      // build query for slug (slug must exist in post documents)
      if (!lastVisible) q = query(postsRef, where('slug', '==', profileSlug), orderBy('createdAt','desc'), limit(PAGE_SIZE));
      else q = query(postsRef, where('slug', '==', profileSlug), orderBy('createdAt','desc'), startAfter(lastVisible), limit(PAGE_SIZE));
    } else {
      // No slug: fall back to currentUser's posts (private feed). require auth
      if (!currentUser) {
        // If auth hasn't initialized yet, show skeleton until it does
        if (!authInitialized) { renderPostSkeletons(4); loadMoreBtn.style.display = 'none'; return; }
        postsListEl.innerHTML = '<div class="card small muted">Sign in to view your posts.</div>';
        loadMoreBtn.style.display = 'none';
        return;
      }
      if (!lastVisible) q = query(postsRef, where('authorId', '==', currentUser.uid), orderBy('createdAt','desc'), limit(PAGE_SIZE));
      else q = query(postsRef, where('authorId', '==', currentUser.uid), orderBy('createdAt','desc'), startAfter(lastVisible), limit(PAGE_SIZE));
    }

    try {
      const snaps = await getDocs(q);
      if (snaps.docs.length === 0) {
        if (!lastVisible) {
          if (profileSlug) postsListEl.innerHTML = `<div class="card small muted">No posts found for "${escapeHTML(profileSlug)}".</div>`;
          else postsListEl.innerHTML = '<div class="card small muted">You have no posts yet â€” create one!</div>';
        }
        loadMoreBtn.style.display = 'none';
        return;
      }

      // If resetting, clear skeletons and list
      if (!lastVisible) postsListEl.innerHTML = '';

      for (const d of snaps.docs) {
        renderPostCard(d.id, d.data());
      }

      lastVisible = snaps.docs[snaps.docs.length - 1];
      // show load more only if returned PAGE_SIZE items
      loadMoreBtn.style.display = snaps.docs.length === PAGE_SIZE ? 'inline-block' : 'none';
    } catch(e){
      console.error('feed fetch error', e);
      postsListEl.innerHTML = '<div class="card small muted">Failed to load posts</div>';
      loadMoreBtn.style.display = 'none';
    }
  }

  refreshBtn.addEventListener('click', ()=> {
    lastVisible=null;
    refreshFeed(true);
  });

  loadMoreBtn.addEventListener('click', ()=> refreshFeed(false));

  // Helper to choose avatar for posts/comments
  function avatarHtmlFor(author, data) {
    // Check for photoUrl first, then other possible fields
    const photo = (data && (data.photoUrl || data.authorPhotoUrl || data.authorPhoto || data.photoURL || data.authorAvatar)) || null;
    // Google default avatar fallback (public-ish)
    const googleDefault = 'https://www.gstatic.com/images/branding/product/2x/avatar_square_64dp.png';
    if (photo) {
      return `<img class="avatar small" src="${escapeHTML(photo)}" alt="${escapeHTML(author)}">`;
    } else {
      // Use googleDefault if you want a consistent "google-like" fallback
      return `<img class="avatar small" src="${googleDefault}" alt="avatar">`;
    }
  }

  function renderPostCard(postId, data) {
    const el = document.createElement('div');
    el.className = 'card';
    const author = data.authorName || data.authorEmail || 'Unknown';
    const created = data.createdAt ? timeAgo(data.createdAt) : '';

    // build avatar (image if available else google default image)
    const avatarHtml = avatarHtmlFor(author, data);

    el.innerHTML = `
      <div class="meta">
        ${avatarHtml}
        <span style="margin-left:8px">${escapeHTML(author)} Â· <span class="muted">${created}</span></span>
      </div>
      <div class="title">${escapeHTML(data.title || 'Untitled')}</div>
      <div class="snippet">${escapeHTML(snippet(data.body || ''))}</div>
      <div class="tags">${(data.tags || []).map(t => `<span class="tag">${escapeHTML(t)}</span>`).join('')}</div>
      <div class="actions">
        <div class="vote">
          <button class="link-like upvote" data-id="${postId}">â–²</button>
          <div class="count" id="up_${postId}">${data.upvotesCount||0}</div>
          <button class="link-like downvote" data-id="${postId}">â–¼</button>
          <div class="count" id="down_${postId}">${data.downvotesCount||0}</div>
        </div>
        <div style="margin-left:auto">
          <button class="btn-ghost commentBtn" data-id="${postId}"><i class="far fa-comment"></i> Comments (${data.commentsCount||0})</button>
          <button class="btn-primary viewBtn" data-id="${postId}">View Post</button>
        </div>
      </div>
    `;
    postsListEl.appendChild(el);

    // attach handlers
    el.querySelector('.viewBtn').addEventListener('click', ()=> openPostPage(postId));
    el.querySelector('.commentBtn').addEventListener('click', ()=> openPostPage(postId));
    el.querySelector('.upvote').addEventListener('click', ()=> handleVoteClick(postId, 1));
    el.querySelector('.downvote').addEventListener('click', ()=> handleVoteClick(postId, -1));
  }

  function openPostPage(postId) {
    // navigate to same file with ?postId
    const base = window.location.href.split('?')[0];
    window.location.href = base + '?postId=' + postId;
  }

  // ---------- Voting logic (safe per-user using 'votes' collection) ----------
  async function handleVoteClick(postId, delta) {
    if (isVoting) return; // Prevent multiple simultaneous votes
    if (!currentUser) { alert('Sign in to vote'); return; }

    const uid = currentUser.uid;
    const voteDocRef = doc(db, 'votes', `${postId}_${uid}`);
    const postRef = doc(db, 'posts', postId);

    // Set voting state and update UI
    isVoting = true;
    const voteButtons = document.querySelectorAll(`.upvote[data-id="${postId}"], .downvote[data-id="${postId}"]`);
    voteButtons.forEach(btn => {
      btn.classList.add('vote-loading');
      btn.innerHTML = delta === 1 && btn.classList.contains('upvote') ?
        '<span class="spinner"></span> â–²' :
        (delta === -1 && btn.classList.contains('downvote') ?
        '<span class="spinner"></span> â–¼' : btn.innerHTML);
    });

    try {
      await runTransaction(db, async (tx) => {
        const voteSnap = await tx.get(voteDocRef);
        const postSnap = await tx.get(postRef);
        if (!postSnap.exists()) throw 'Post not found';
        let up = postSnap.data().upvotesCount || 0;
        let down = postSnap.data().downvotesCount || 0;

        if (!voteSnap.exists()) {
          // create vote
          tx.set(voteDocRef, { postId, userId: uid, vote: delta, createdAt: serverTimestamp() });
          if (delta === 1) up++; else down++;
        } else {
          const prev = voteSnap.data().vote || 0;
          if (prev === delta) {
            // undo
            tx.delete(voteDocRef);
            if (delta === 1) up = Math.max(0, up-1); else down = Math.max(0, down-1);
          } else {
            // switch
            tx.update(voteDocRef, { vote: delta, updatedAt: serverTimestamp() });
            if (delta === 1) { up++; down = Math.max(0, down-1); }
            else { down++; up = Math.max(0, up-1); }
          }
        }
        tx.update(postRef, { upvotesCount: up, downvotesCount: down });
      });
      // update UI quickly by refetching either the single post view or the feed counts
      if (currentPostId === postId) renderPostView(postId);
      else refreshFeed(true);
    } catch(e) {
      console.error('vote failed', e);
      alert('Vote failed');
    } finally {
      isVoting = false;
      // Reset UI state
      voteButtons.forEach(btn => {
        btn.classList.remove('vote-loading');
        btn.innerHTML = btn.classList.contains('upvote') ? 'â–²' : 'â–¼';
      });
    }
  }

  // ---------- POST VIEW (single post + comments) ----------
  backToFeed.addEventListener('click', ()=> {
    const base = window.location.href.split('?')[0];
    window.location.href = base; // go back to feed
  });

  async function renderPostView(postId) {
    currentPostId = postId;
    // Show skeleton while loading
    renderPostViewSkeleton();

    try {
      const postRef = doc(db,'posts',postId);
      const pSnap = await getDoc(postRef);
      if (!pSnap.exists()) {
        postContainer.innerHTML = '<div class="card small muted">Post not found</div>';
        return;
      }

      const data = pSnap.data();
      const author = data.authorName || data.authorEmail || 'Unknown';
      const created = data.createdAt ? timeAgo(data.createdAt) : '';

      // Use image avatar if present in post data; fallback to google default
      const avatarForPost = (data.photoUrl || data.authorPhotoUrl || data.authorPhoto || data.authorAvatar || data.photoURL) || 'https://www.gstatic.com/images/branding/product/2x/avatar_square_64dp.png';

      postContainer.innerHTML = `
        <div class="card">
          <div class="meta">
            <img class="avatar small" src="${escapeHTML(avatarForPost)}" alt="${escapeHTML(author)}">
            ${escapeHTML(author)} Â· <span class="muted">${created}</span>
          </div>
          <div class="title">${escapeHTML(data.title || 'Untitled')}</div>
          <div style="margin-top:0.75rem; line-height: 1.8;">${escapeHTML(data.body || '').replace(/\n/g, '<br>')}</div>
          <div class="tags">${(data.tags||[]).map(t=>`<span class="tag">${escapeHTML(t)}</span>`).join('')}</div>

          <div style="margin-top:1rem" class="actions">
            <div class="vote">
              <button id="pvUp" class="link-like">â–²</button>
              <div id="pvUpCount" class="count">${data.upvotesCount||0}</div>
              <button id="pvDown" class="link-like">â–¼</button>
              <div id="pvDownCount" class="count">${data.downvotesCount||0}</div>
            </div>
          </div>
        </div>
      `;

      // bind vote handlers and show user's current vote visually
      document.getElementById('pvUp').addEventListener('click', ()=> handleVoteClick(postId, 1));
      document.getElementById('pvDown').addEventListener('click', ()=> handleVoteClick(postId, -1));

      // fetch and highlight user's vote (if logged in)
      if (currentUser) {
        try {
          const voteSnap = await getDoc(doc(db,'votes', `${postId}_${currentUser.uid}`));
          const prev = voteSnap.exists() ? (voteSnap.data().vote||0) : 0;
          highlightVoteButtons(prev);
        } catch(e){ console.warn('vote read failed', e); }
      } else highlightVoteButtons(0);

      // subscribe to comments in real-time
      const commentsRef = collection(db, 'posts', postId, 'comments');
      const commentsQuery = query(commentsRef, orderBy('createdAt','asc'));
      commentsUnsub = onSnapshot(commentsQuery, (snap) => {
        commentsList.innerHTML = '';
        if (snap.empty) {
          commentsList.innerHTML = '<div class="small muted" style="padding: 1rem; text-align: center;">No comments yet</div>';
          return;
        }

        snap.forEach(docSnap => {
          const c = docSnap.data();
          const authorC = c.authorName || 'Anonymous';
          // choose avatar for comment: check comment data for photo fields, prioritizing photoUrl
          const cAvatar = (c.photoUrl || c.authorPhotoUrl || c.authorPhoto || c.photoURL) || 'https://www.gstatic.com/images/branding/product/2x/avatar_square_64dp.png';
          const cEl = document.createElement('div');
          cEl.className = 'comment';
          cEl.innerHTML = `
            <div class="meta">
              <img class="avatar small" src="${escapeHTML(cAvatar)}" alt="${escapeHTML(authorC)}">
              ${escapeHTML(authorC)} Â· <span class="muted">${c.createdAt ? timeAgo(c.createdAt) : ''}</span>
            </div>
            <div style="margin-top:0.5rem">${escapeHTML(c.body||'').replace(/\n/g, '<br>')}</div>`;
          commentsList.appendChild(cEl);
        });
      }, (error) => {
        console.error('Comments subscription error:', error);
        commentsList.innerHTML = '<div class="small muted" style="padding: 1rem;">Failed to load comments</div>';
      });

    } catch(e) {
      console.error('render post error', e);
      postContainer.innerHTML = '<div class="card small muted">Failed to load post</div>';
    }
  }

  function highlightVoteButtons(v) {
    const up = document.getElementById('pvUp');
    const down = document.getElementById('pvDown');
    if (!up || !down) return;

    up.style.color = v === 1 ? 'var(--accent1)' : 'var(--muted)';
    down.style.color = v === -1 ? 'var(--accent1)' : 'var(--muted)';
    up.style.fontWeight = v === 1 ? '900' : '600';
    down.style.fontWeight = v === -1 ? '900' : '600';
  }

  // ---------- comments: add ----------
  clearComment.addEventListener('click', ()=> commentInput.value='');

  submitComment.addEventListener('click', async () => {
    if (!currentUser) { alert('Sign in to comment'); return; }
    const text = (commentInput.value || '').trim();
    if (!text) { commentStatus.textContent = 'Type your comment'; return; }

    commentStatus.textContent = 'Posting...';
    submitComment.disabled = true;

    try {
      const commentsRef = collection(db, 'posts', currentPostId, 'comments');
      await addDoc(commentsRef, {
        body: text,
        authorId: currentUser.uid,
        authorName: currentUserProfile?.name || currentUser.email || null,
        photoUrl: currentUserProfile?.photoURL || currentUser.photoURL || null, // Add photoUrl to comment
        createdAt: serverTimestamp(),
        upvotesCount: 0
      });
      // increment commentsCount on post
      await updateDoc(doc(db,'posts',currentPostId), { commentsCount: increment(1) });
      commentInput.value = '';
      commentStatus.textContent = 'Posted';
    } catch(e) {
      console.error('post comment failed', e);
      commentStatus.textContent = 'Failed';
    } finally {
      submitComment.disabled = false;
      setTimeout(()=>commentStatus.textContent='',1200);
    }
  });

  // ---------- initial render for feed view ----------
  function showFeed() {
    feedView.style.display = 'block';
    postView.style.display = 'none';
  }
  function showPost() {
    feedView.style.display = 'none';
    postView.style.display = 'block';
  }
  // ensure proper view shown depending on currentPostId
  if (currentPostId) { showPost(); } else { showFeed(); }

  // Logout functionality
  logoutBtn.addEventListener('click', () => {
    signOut(auth).then(() => {
      console.log('User signed out');
    }).catch((error) => {
      console.error('Sign out error:', error);
      alert('Error signing out. Please try again.');
    });
  });

  // Settings functionality
  settingsBtn.addEventListener('click', () => {
    window.location.href = 'settings.html';
  });

  // Wait for auth to be initialized before showing non-public content
  function waitForAuthInitialization() {
    if (authInitialized) {
      // Always refresh feed once auth state is known (refreshFeed handles public vs private)
      refreshFeed(true);
    } else {
      setTimeout(waitForAuthInitialization, 100);
    }
  }

  waitForAuthInitialization();
</script>
</body>
</html>