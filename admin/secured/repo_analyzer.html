<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Repository Analyzer - TeamGalaxy</title>
    <script src="https://www.gstatic.com/firebasejs/11.9.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.9.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.9.0/firebase-firestore-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #00d4ff;
            --dark-bg: #0f0c29;
            --darker-bg: #1a1a2e;
            --card-bg: rgba(25, 25, 35, 0.9);
            --border: rgba(255, 255, 255, 0.1);
            --muted: #a0aec0;
            --success: #4ade80;
            --warning: #fbbf24;
            --error: #f87171;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--dark-bg), #302b63, #24243e);
            color: white;
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }

        /* Loading Screen */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(15, 12, 41, 0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            transition: opacity 0.5s ease;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255,255,255,0.1);
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 1.2rem;
            color: var(--primary);
            text-align: center;
        }

        /* Stars Background */
        .stars {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
        }

        .star {
            position: absolute;
            background-color: white;
            border-radius: 50%;
            animation: twinkle var(--duration, 3s) infinite ease-in-out;
        }

        @keyframes twinkle {
            0%, 100% { opacity: 0.2; }
            50% { opacity: 1; }
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
            z-index: 10;
            display: none;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
            margin-bottom: 30px;
            border-bottom: 1px solid var(--border);
        }

        .back-btn {
            background: rgba(255,255,255,0.1);
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .back-btn:hover {
            background: rgba(0, 212, 255, 0.3);
        }

        .card {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            border: 1px solid var(--border);
            backdrop-filter: blur(10px);
        }

        .controls {
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 20px;
        }

        .input {
            width: 100%;
            padding: 10px 15px;
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: white;
            margin-bottom: 10px;
        }

        .btn {
            background: linear-gradient(45deg, var(--primary), #0077ff);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
            margin-right: 8px;
            margin-bottom: 8px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 212, 255, 0.3);
        }

        .btn.small {
            padding: 8px 12px;
            font-size: 0.9rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 15px;
        }

        .stat {
            text-align: center;
        }

        .v {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 5px;
        }

        .label {
            color: var(--muted);
            font-size: 0.8rem;
        }

        .footer-note {
            margin-top: 15px;
            padding: 10px;
            background: rgba(255, 165, 0, 0.1);
            border: 1px solid rgba(255, 165, 0, 0.3);
            border-radius: 8px;
            font-size: 0.8rem;
        }

        .tabs {
            display: flex;
            border-bottom: 1px solid var(--border);
            margin-bottom: 20px;
        }

        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
        }

        .tab.active {
            border-bottom: 2px solid var(--primary);
            color: var(--primary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .table {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        th {
            background: rgba(255,255,255,0.05);
        }

        .file-type {
            background: rgba(0, 212, 255, 0.2);
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
        }

        .tree-view {
            background: rgba(0,0,0,0.2);
            padding: 15px;
            border-radius: 8px;
            max-height: 400px;
            overflow-y: auto;
        }

        .tree-item {
            margin-left: 20px;
            margin-bottom: 5px;
        }

        .tree-folder {
            cursor: pointer;
            font-weight: bold;
            color: var(--primary);
        }

        .tree-file {
            color: #a0aec0;
        }

        .loading, .error {
            padding: 20px;
            text-align: center;
            border-radius: 8px;
        }

        .loading {
            background: rgba(0, 212, 255, 0.1);
            color: var(--primary);
        }

        .error {
            background: rgba(248, 113, 113, 0.1);
            color: var(--error);
        }

        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-spinner"></div>
        <div class="loading-text">Verifying admin access...</div>
    </div>

    <div class="stars" id="stars"></div>

    <div class="container" id="mainContainer">
        <div class="header">
            <button class="back-btn" onclick="goBack()">
                <i class="fas fa-arrow-left"></i> Back to Dashboard
            </button>
        </div>

        <div class="card">
            <h1>üöÄ GitHub Repository Analyzer</h1>
            <div style="color:var(--muted);margin-top:6px">Analyze GitHub repositories with detailed insights</div>
        </div>

        <div class="controls">
            <div class="card">
                <div style="margin-bottom:10px"><strong>Repository</strong></div>
                <input id="owner" class="input" placeholder="owner" value="teamgalaxyinteractive-cmd">
                <input id="repo" class="input" placeholder="repo" value="teamgalaxy">
                <input id="branch" class="input" placeholder="branch" value="main">
                <input id="root" class="input" placeholder="root path (optional)" value="">

                <div style="display:flex;gap:8px;margin-top:8px">
                    <input id="extensions" class="input" style="flex:1" placeholder=".js,.py" value=".js,.ts,.py,.html,.css,.json,.md">
                </div>

                <div style="display:flex;gap:8px;margin-top:8px;align-items:center">
                    <input id="minSize" class="input" style="width:120px" type="number" placeholder="min size bytes" value="0">
                    <input id="maxContentFetch" class="input" style="width:120px" type="number" placeholder="content fetch N" value="10" title="Max files to fetch content for (0 = none)">
                </div>

                <div style="display:flex;gap:8px;margin-top:8px">
                    <input id="ghToken" class="input" placeholder="GitHub token (optional)" title="Use a personal token to increase rate limit">
                </div>

                <div style="display:flex;gap:8px;margin-top:8px">
                    <button id="analyzeBtn" class="btn">üîÑ Analyze</button>
                    <button id="fetchTopContentBtn" class="btn small" style="background:linear-gradient(45deg,#60a5fa,#3b82f6)">üìÑ Fetch top N</button>
                    <button id="exportBtn" class="btn small" style="background:linear-gradient(45deg,#4ade80,#22c55e)">üì• Export</button>
                </div>

                <div class="footer-note">
                    Tip: By default we do NOT fetch each file‚Äôs content (lazy). Use "Fetch top N" or click a file to load content. This saves API tokens & bandwidth.
                </div>
            </div>

            <div class="card">
                <div style="margin-bottom:6px"><strong>Quick stats</strong></div>
                <div class="stats-grid" id="quickStats">
                    <div class="stat"><div class="v" id="totalFiles">0</div><div class="label" style="color:var(--muted)">Files</div></div>
                    <div class="stat"><div class="v" id="totalSize">0 Bytes</div><div class="label" style="color:var(--muted)">Total size</div></div>
                    <div class="stat"><div class="v" id="largestFile">‚Äî</div><div class="label" style="color:var(--muted)">Largest</div></div>
                    <div class="stat"><div class="v" id="avgSize">‚Äî</div><div class="label" style="color:var(--muted)">Average</div></div>
                </div>

                <div style="margin-top:6px"><strong>Search / Filter</strong></div>
                <input id="searchFilter" class="input" placeholder="Filter by filename or path">

                <div style="margin-top:6px"><strong>Charts</strong></div>
                <div style="display:flex;gap:8px">
                    <button id="showChartsBtn" class="btn small">Show charts</button>
                    <button id="loadCacheBtn" class="btn small" style="background:linear-gradient(45deg,#f59e0b,#f97316)">Load cache</button>
                </div>

                <div id="rateInfo" class="footer-note" style="margin-top:8px;color:var(--muted)"></div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="card">
            <div class="tabs">
                <div class="tab active" data-tab="overview">üìà Overview</div>
                <div class="tab" data-tab="files">üìÅ Files</div>
                <div class="tab" data-tab="charts">üìä Charts</div>
                <div class="tab" data-tab="tree">üå≥ Tree View</div>
                <div class="tab" data-tab="details">üìã Details</div>
            </div>

            <!-- Overview -->
            <div id="overview" class="tab-content active">
                <div style="display:flex;gap:12px;flex-wrap:wrap">
                    <div style="flex:1">
                        <h3 style="margin-bottom:8px">Summary</h3>
                        <div id="summaryText" style="color:var(--muted)">No analysis run yet.</div>
                    </div>
                    <div style="width:360px">
                        <h3 style="margin-bottom:8px">Top files</h3>
                        <div id="topFilesList" style="color:var(--muted)">‚Äî</div>
                    </div>
                </div>
            </div>

            <!-- Files table -->
            <div id="files" class="tab-content">
                <div class="table">
                    <table>
                        <thead><tr><th>Name</th><th>Path</th><th>Size</th><th>Type</th><th>Lines</th><th>Actions</th></tr></thead>
                        <tbody id="filesTableBody"></tbody>
                    </table>
                </div>
                <div id="filesNote" style="color:var(--muted);margin-top:8px">Click üîç to load file content (this will perform a single request for that file).</div>
            </div>

            <!-- Charts -->
            <div id="charts" class="tab-content">
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
                    <div style="background:rgba(0,0,0,0.25);padding:10px;border-radius:8px"><canvas id="typeChart"></canvas></div>
                    <div style="background:rgba(0,0,0,0.25);padding:10px;border-radius:8px"><canvas id="sizeChart"></canvas></div>
                </div>
            </div>

            <!-- Tree View -->
            <div id="tree" class="tab-content">
                <div class="tree-view" id="treeView"></div>
            </div>

            <!-- Details -->
            <div id="details" class="tab-content">
                <div id="fileDetailsInner" style="color:var(--muted)">Select a file to view details.</div>
            </div>
        </div>

        <div id="loading" class="loading hidden"></div>
        <div id="error" class="error hidden"></div>
    </div>

    <script>
        // Initialize Firebase
        const firebaseConfig = {
          apiKey: "AIzaSyD0Yv_bQjxi2_kjzPR4XHOlaB7Sb6NRVUc",
          authDomain: "teamgalaxy-77344.firebaseapp.com",
          projectId: "teamgalaxy-77344",
          storageBucket: "teamgalaxy-77344.firebasestorage.app",
          messagingSenderId: "770256225320",
          appId: "1:770256225320:web:5a363ebd757de6cde3a11d",
          measurementId: "G-6C2W9NSNCH"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Global variables
        window.analysisData = window.analysisData || [];
        window.currentFile = window.currentFile || null;
        window.charts = window.charts || {typeChart:null, sizeChart:null};

        // Create star background
        function createStars() {
            const starsContainer = document.getElementById('stars');
            const starCount = 150;
            
            for (let i = 0; i < starCount; i++) {
                const star = document.createElement('div');
                star.classList.add('star');
                
                const x = Math.random() * 100;
                const y = Math.random() * 100;
                star.style.left = `${x}%`;
                star.style.top = `${y}%`;
                
                const size = Math.random() * 3 + 1;
                star.style.width = `${size}px`;
                star.style.height = `${size}px`;
                
                const duration = Math.random() * 5 + 2;
                star.style.setProperty('--duration', `${duration}s`);
                
                starsContainer.appendChild(star);
            }
        }

        // Check admin authentication
        async function checkAuth() {
            try {
                const user = await new Promise((resolve, reject) => {
                    const unsubscribe = auth.onAuthStateChanged(async (user) => {
                        if (user) {
                            try {
                                const adminQuery = await db.collection('admin').where('gmail', '==', user.email).limit(1).get();
                                if (!adminQuery.empty) {
                                    unsubscribe();
                                    resolve(user);
                                } else {
                                    unsubscribe();
                                    throw new Error('Not an admin');
                                }
                            } catch (error) {
                                unsubscribe();
                                throw error;
                            }
                        } else {
                            unsubscribe();
                            throw new Error('Not signed in');
                        }
                    });
                });

                setTimeout(() => {
                    document.getElementById('loadingScreen').style.opacity = '0';
                    setTimeout(() => {
                        document.getElementById('loadingScreen').classList.add('hidden');
                        document.getElementById('mainContainer').style.display = 'block';
                    }, 500);
                }, 1500);

            } catch (error) {
                console.error('Auth check error:', error);
                document.getElementById('loadingScreen').querySelector('.loading-text').textContent = 'Access denied. Redirecting...';
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 2000);
            }
        }

        // Helper functions
        function el(id){ return document.getElementById(id); }
        function showLoading(txt){ el('loading').classList.remove('hidden'); el('loading').textContent=txt || 'Working...'; }
        function hideLoading(){ el('loading').classList.add('hidden'); }
        function showError(msg){ el('error').classList.remove('hidden'); el('error').textContent = msg; }
        function hideError(){ el('error').classList.add('hidden'); el('error').textContent = ''; }
        function formatBytes(bytes){ if(!bytes && bytes !== 0) return '0 Bytes'; const k=1024; const sizes=['Bytes','KB','MB','GB']; const i = bytes===0?0:Math.floor(Math.log(bytes)/Math.log(k)); return (bytes/Math.pow(k,i)).toFixed(2)+' '+sizes[i]; }
        function getFileType(name){ const ext = (name.split('.').pop()||'').toLowerCase(); const map={'js':'JavaScript','ts':'TypeScript','py':'Python','html':'HTML','css':'CSS','json':'JSON','md':'Markdown'}; return map[ext]||(ext?ext.toUpperCase():'Unknown'); }
        function safeDecodeURIPath(p){ try { return decodeURIComponent(p); } catch(e){ return p; } }
        function escapeForAttr(s){ return (s||'').replace(/'/g,"\\'").replace(/"/g,'\\"'); }
        function escapeHtml(s){ return (s||'').replace(/&/g,'&amp;').replace(/</g,'<').replace(/>/g,'>'); }

        // Tab switching
        document.querySelectorAll('.tab').forEach(t=>{
          t.addEventListener('click', () => {
            const tab = t.dataset.tab;
            document.querySelectorAll('.tab').forEach(x=>x.classList.toggle('active', x===t));
            document.querySelectorAll('.tab-content').forEach(c=> c.classList.toggle('active', c.id===tab));
          });
        });

        // Rate-limit aware fetch wrapper
        async function ghFetch(url, token){
          const headers = { 'Accept': 'application/vnd.github.v3+json' };
          if(token) headers['Authorization'] = 'token ' + token;
          const res = await fetch(url, { headers });
          const remaining = parseInt(res.headers.get('x-ratelimit-remaining') || '0', 10);
          const resetEpoch = parseInt(res.headers.get('x-ratelimit-reset') || '0', 10);
          return { res, remaining, resetEpoch };
        }

        // Main analyze function
        async function analyzeRepo(){
          hideError();
          showLoading('Fetching repo tree from GitHub...');
          try{
            const owner = el('owner').value.trim(), repo = el('repo').value.trim(), branch = el('branch').value.trim() || 'main';
            if(!owner || !repo) throw new Error('Owner & repo required');
            const root = (el('root').value || '').trim();
            const extensions = (el('extensions').value || '').split(',').map(s=>s.trim().toLowerCase()).filter(Boolean);
            const minSize = parseInt(el('minSize').value) || 0;
            const token = (el('ghToken').value || '').trim();

            const treeUrl = `https://api.github.com/repos/${encodeURIComponent(owner)}/${encodeURIComponent(repo)}/git/trees/${encodeURIComponent(branch)}?recursive=1`;
            const { res, remaining, resetEpoch } = await ghFetch(treeUrl, token);
            el('rateInfo').textContent = `GitHub rate remaining: ${remaining} ‚Äî reset ${ new Date(resetEpoch*1000).toLocaleString() }`;

            if(!res.ok){
              const txt = await res.text();
              throw new Error(`GitHub API error ${res.status}: ${txt.substring(0,200)}`);
            }
            const data = await res.json();
            if(!data.tree) throw new Error('Invalid tree response');

            let files = data.tree.filter(i => i.type === 'blob');
            if(root){
              const rootNorm = root.replace(/^\/*/,'').replace(/\/*$/,'') + '/';
              files = files.filter(f => f.path.startsWith(rootNorm));
            }
            files = files.filter(item => {
              const pathLower = item.path.toLowerCase();
              const extMatch = extensions.length ? extensions.some(ext => pathLower.endsWith(ext)) : true;
              const sizeOk = (typeof item.size === 'number') ? item.size > minSize : true;
              return extMatch && sizeOk;
            });

            const built = files.map(f => ({
              path: f.path,
              name: f.path.split('/').pop(),
              size: f.size || 0,
              url: `https://raw.githubusercontent.com/${owner}/${repo}/${branch}/${encodeURI(f.path)}`,
              type: getFileType(f.path),
              lines: null,
              columns: null
            }));

            window.analysisData = built;
            updateUIAfterAnalysis(built);
            buildTreeStructure(built);
            hideLoading();

            if(remaining < 5){
              showError(`Warning: GitHub rate limit low (${remaining} remaining). Avoid fetching many files now or provide a personal token.`);
            }

          }catch(err){
            hideLoading();
            showError('Analysis error: ' + (err.message || err));
            console.error(err);
          }
        }

        // Build tree structure visualization
        function buildTreeStructure(files) {
            const treeView = el('treeView');
            const tree = {};
            
            // Build directory structure
            files.forEach(file => {
                const parts = file.path.split('/');
                let current = tree;
                
                for (let i = 0; i < parts.length - 1; i++) {
                    const part = parts[i];
                    if (!current[part]) {
                        current[part] = {};
                    }
                    current = current[part];
                }
                
                // Add file
                current[parts[parts.length - 1]] = file;
            });

            // Render tree
            function renderTree(obj, depth = 0) {
                let html = '';
                for (const key in obj) {
                    const item = obj[key];
                    const indent = '&nbsp;'.repeat(depth * 4);
                    
                    if (item.path) { // It's a file
                        html += `<div class="tree-item">${indent}<span class="tree-file">üìÑ ${key}</span></div>`;
                    } else { // It's a folder
                        html += `<div class="tree-item">${indent}<span class="tree-folder">üìÅ ${key}</span></div>`;
                        html += renderTree(item, depth + 1);
                    }
                }
                return html;
            }

            treeView.innerHTML = renderTree(tree);
        }

        // Update UI after analysis
        function updateUIAfterAnalysis(files){
          const totalFiles = files.length;
          const totalSize = files.reduce((s,f)=>s + (f.size||0), 0);
          const largest = files.reduce((best,f)=> (!best || (f.size||0) > (best.size||0)) ? f : best, null);
          const avg = totalFiles ? Math.round(totalSize/totalFiles) : 0;

          el('totalFiles').textContent = totalFiles;
          el('totalSize').textContent = formatBytes(totalSize);
          el('largestFile').textContent = largest ? `${largest.name} ‚Äî ${formatBytes(largest.size)}` : '‚Äî';
          el('avgSize').textContent = avg ? formatBytes(avg) : '‚Äî';

          el('summaryText').textContent = `Found ${totalFiles} files (${formatBytes(totalSize)}). Largest: ${largest ? largest.name : '‚Äî'}. Average size: ${avg ? formatBytes(avg) : '‚Äî'}. Content NOT fetched by default to save rate tokens. Click a file to load content on-demand.`;

          const top = [...files].sort((a,b)=> (b.size||0) - (a.size||0)).slice(0,8);
          el('topFilesList').innerHTML = top.map(t=> `<div style="margin-bottom:6px">${t.name} ‚Äî <span style="color:var(--muted)">${formatBytes(t.size)}</span></div>`).join('') || '‚Äî';

          renderFilesTable(files);
          renderCharts(files);
        }

        // Render files table
        function renderFilesTable(files){
          const search = (el('searchFilter').value || '').toLowerCase();
          const filtered = files.filter(f=> (f.name + ' ' + f.path).toLowerCase().includes(search));
          const tbody = el('filesTableBody');
          tbody.innerHTML = '';

          filtered.forEach(f=>{
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${f.name}</td>
              <td style="max-width:420px;word-break:break-all">${f.path}</td>
              <td>${formatBytes(f.size)}</td>
              <td><span class="file-type">${f.type}</span></td>
              <td>${f.lines === null ? '‚Äî' : f.lines}</td>
              <td style="white-space:nowrap">
                <button class="btn small" onclick="loadSingleFile('${escapeForAttr(f.url)}','${escapeForAttr(f.path)}')">üîç Load</button>
                <button class="btn small" style="background:linear-gradient(45deg,#3b82f6,#2563eb)" onclick="downloadDirect('${escapeForAttr(f.url)}','${escapeForAttr(f.name)}')">üì•</button>
              </td>
            `;
            tbody.appendChild(tr);
          });
        }

        // Charts
        function renderCharts(files){
          try{
            const counts = {};
            files.forEach(f=> counts[f.type] = (counts[f.type]||0) + 1 );
            const labels = Object.keys(counts).slice(0,20);
            const data = labels.map(l=> counts[l]);

            if(window.charts.typeChart) window.charts.typeChart.destroy();
            const ctx1 = el('typeChart').getContext('2d');
            window.charts.typeChart = new Chart(ctx1, {
              type: 'doughnut',
              data: { labels, datasets: [{ data }] },
              options: { 
                responsive: true,
                plugins:{legend:{position:'bottom', color: '#fff'}}
              }
            });

            const top = [...files].sort((a,b)=> (b.size||0)-(a.size||0)).slice(0,10);
            const sizeLabels = top.map(t=> t.name);
            const sizeValues = top.map(t=> Math.round((t.size||0)/1024));
            if(window.charts.sizeChart) window.charts.sizeChart.destroy();
            const ctx2 = el('sizeChart').getContext('2d');
            window.charts.sizeChart = new Chart(ctx2, {
              type:'bar',
              data: { labels: sizeLabels, datasets: [{ label: 'Size (KB)', data: sizeValues, backgroundColor: '#00d4ff' }] },
              options: { 
                indexAxis: 'y', 
                plugins:{legend:{display:false}},
                scales: {
                  x: { ticks: { color: '#a0aec0' } },
                  y: { ticks: { color: '#a0aec0' } }
                }
              }
            });
          }catch(e){
            console.warn('charts err', e);
          }
        }

        // Load single file content
        async function loadSingleFile(rawUrl, path){
          hideError();
          showLoading('Fetching file content (on-demand)...');
          try{
            const token = (el('ghToken').value || '').trim();
            const r = await fetch(rawUrl);
            if(!r.ok) throw new Error(`HTTP ${r.status}`);
            const text = await r.text();
            showFileContent(path, text);
            const fileObj = window.analysisData.find(f => f.path === path);
            if(fileObj){ fileObj.lines = text.split(/\r\n|\n/).length; fileObj.columns = Math.max(...text.split(/\r\n|\n/).map(l=>l.length), 0); }
            renderFilesTable(window.analysisData);
            hideLoading();
            switchToDetails(path);
          }catch(err){
            hideLoading();
            showError('File load error: ' + (err.message || err));
            console.error(err);
          }
        }

        function showFileContent(path, content){
          const target = el('fileDetailsInner');
          const safePath = safeDecodeURIPath(path);
          target.innerHTML = `
            <h3 style="margin-top:0">${safePath}</h3>
            <div style="color:var(--muted);margin-bottom:8px">Size: ${content.length} bytes ‚Äî Loaded on demand</div>
            <pre style="white-space:pre-wrap;max-height:420px;overflow:auto;background:rgba(0,0,0,0.2);padding:12px;border-radius:8px">${escapeHtml(content)}</pre>
          `;
        }

        // Fetch top N content
        async function fetchTopNContent(){
          hideError();
          const maxN = parseInt(el('maxContentFetch').value) || 0;
          if(maxN <= 0){ alert('Set a positive number in "content fetch N" to use this feature.'); return; }
          if(!window.analysisData || window.analysisData.length === 0){ alert('Run analysis first.'); return; }

          const token = (el('ghToken').value || '').trim();
          const top = [...window.analysisData].sort((a,b)=> (b.size||0)-(a.size||0)).slice(0,maxN);
          showLoading(`Fetching content for top ${top.length} files... (this uses ${top.length} requests)`);
          let counter = 0;
          for(const f of top){
            try{
              await loadSingleFile(f.url, f.path);
              counter++;
              showLoading(`Fetched ${counter}/${top.length}...`);
              await new Promise(r=>setTimeout(r, 250));
            }catch(e){
              console.warn('top fetch err', e);
            }
          }
          hideLoading();
          alert(`Done fetching content for ${counter}/${top.length} files.`);
        }

        // Utilities
        function downloadDirect(url, name){ 
          fetch(url).then(r=>r.blob()).then(b=>{ 
            const a=document.createElement('a'); 
            a.href=URL.createObjectURL(b); 
            a.download = name || 'file'; 
            document.body.appendChild(a); 
            a.click(); 
            a.remove(); 
            setTimeout(()=>URL.revokeObjectURL(a.href),3000)
          }).catch(e=>alert('Download failed: '+e)); 
        }
        
        function switchToDetails(path){ 
          document.querySelectorAll('.tab').forEach(t=> t.classList.toggle('active', t.dataset.tab==='details')); 
          document.querySelectorAll('.tab-content').forEach(c=> c.classList.toggle('active', c.id==='details')); 
        }

        // Event binds
        el('analyzeBtn').addEventListener('click', analyzeRepo);
        el('fetchTopContentBtn').addEventListener('click', fetchTopNContent);
        el('exportBtn').addEventListener('click', ()=> {
          if(!window.analysisData || window.analysisData.length===0){ alert('No data'); return; }
          const blob = new Blob([JSON.stringify(window.analysisData,null,2)], {type:'application/json'}); 
          const url=URL.createObjectURL(blob); 
          const a=document.createElement('a'); 
          a.href=url; 
          a.download = 'analysis.json'; 
          a.click(); 
          a.remove(); 
          setTimeout(()=>URL.revokeObjectURL(url),4000);
        });
        
        el('searchFilter').addEventListener('input', ()=> renderFilesTable(window.analysisData || []));
        
        el('loadCacheBtn').addEventListener('click', ()=>{
          try{
            const raw = localStorage.getItem('lastAnalysis');
            if(!raw) return alert('No cached analysis found');
            const obj = JSON.parse(raw);
            if(!obj.data) return alert('Invalid cache');
            window.analysisData = obj.data;
            updateUIAfterAnalysis(window.analysisData);
            buildTreeStructure(window.analysisData);
            alert('Loaded cached analysis from ' + (obj.timestamp||'unknown'));
          }catch(e){ alert('Load cache failed: '+e) }
        });

        // Auto-cache hook
        (function autoCacheHook(){
          const origAnalyze = analyzeRepo;
          analyzeRepo = async function(){
            await origAnalyze();
            try{
              if(window.analysisData) localStorage.setItem('lastAnalysis', JSON.stringify({timestamp:new Date().toISOString(), data: window.analysisData}));
            }catch(e){ console.warn('cache fail', e); }
          };
        })();

        // Go back function
        function goBack() {
            window.location.href = 'admin.html';
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            createStars();
            checkAuth();
        });
    </script>
</body>
</html>