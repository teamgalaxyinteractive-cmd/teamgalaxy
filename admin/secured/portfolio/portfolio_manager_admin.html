<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Portfolio Manager - TeamGalaxy</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"/>

  <style>
    :root{
      --primary-bg: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
      --card-bg: rgba(25, 25, 35, 0.9);
      --glass-border: 1px solid rgba(255,255,255,0.1);
      --hover-glow: 0 0 24px rgba(0,212,255,0.35);
      --panel-bg: #1e1e1e;
      --muted: rgba(255,255,255,0.75);
      --accent: linear-gradient(45deg,#00d4ff,#0077ff);
      --primary: #00d4ff;
      --secondary: #0077ff;
      --text: #fff;
      --border: rgba(255,255,255,0.1);
      --success: #4ade80;
      --warning: #fbbf24;
      --error: #f87171;
    }
    *{box-sizing:border-box}
    body{font-family:Segoe UI, Tahoma, Geneva, Verdana, sans-serif;margin:0;padding:20px;background:var(--primary-bg);color:var(--text);min-height:100vh;position:relative;overflow-x:hidden}

    /* Stars Background */
    .stars {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 0;
    }

    .star {
      position: absolute;
      background-color: white;
      border-radius: 50%;
      animation: twinkle var(--duration, 3s) infinite ease-in-out;
    }

    @keyframes twinkle {
      0%, 100% { opacity: 0.2; }
      50% { opacity: 1; }
    }

    /* Loading Screen */
    .loading-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(15, 12, 41, 0.95);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      transition: opacity 0.5s ease;
    }

    .loading-spinner {
      width: 50px;
      height: 50px;
      border: 4px solid rgba(255,255,255,0.1);
      border-top: 4px solid var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .loading-text {
      font-size: 1.2rem;
      color: var(--primary);
      text-align: center;
    }

    .container{max-width:1200px;margin:0 auto;position:relative;z-index:10}
    .header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;padding-bottom:12px;border-bottom:2px solid var(--border)}
    h1{margin:0;background:var(--accent);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    .controls{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .btn{padding:10px 16px;border-radius:8px;border:none;cursor:pointer;font-weight:600}
    .btn-primary{background:linear-gradient(45deg,var(--primary),var(--secondary));color:#fff}
    .btn-secondary{background:rgba(255,255,255,0.1);color:#fff}
    .folders-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:20px;margin-bottom:30px}
    .folder-card{background:var(--card-bg);border-radius:12px;padding:16px;box-shadow:0 4px 15px rgba(0,0,0,0.06);transition:all .18s;cursor:pointer;border:2px solid transparent}
    .folder-card:hover{transform:translateY(-6px);box-shadow:0 10px 30px rgba(0, 212, 255, 0.2);border-color:rgba(0, 212, 255, 0.3)}
    .folder-title{font-size:1.1rem;color:var(--primary);margin-bottom:6px}
    .folder-images{display:grid;grid-template-columns:repeat(auto-fill,minmax(100px,1fr));gap:8px;margin-top:12px;padding-top:12px;border-top:1px solid var(--border)}
    .folder-image{width:100%;height:80px;object-fit:cover;border-radius:6px}
    .items-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(250px,1fr));gap:20px}
    .item-card{background:var(--card-bg);border-radius:12px;overflow:hidden;box-shadow:0 4px 15px rgba(0,0,0,0.06);position:relative}
    .item-image{width:100%;height:200px;object-fit:cover;border-bottom:1px solid var(--border)}
    .item-info{padding:12px}
    .assigned-indicator{position:absolute;top:10px;left:10px;background:rgba(72, 187, 120, 0.9);color:#fff;padding:4px 8px;border-radius:6px;font-size:12px}
    .item-actions{position:absolute;top:10px;right:10px;display:flex;gap:6px}
    .edit-item-btn,.assign-btn{background:rgba(255,255,255,0.1);border:1px solid var(--border);border-radius:6px;padding:6px 8px;cursor:pointer}
    .modal{display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.5)}
    .modal-content{background:var(--card-bg);margin:5% auto;padding:22px;border-radius:12px;width:90%;max-width:520px;box-shadow:0 10px 30px rgba(0,0,0,0.3);border:1px solid var(--border)}
    .form-group{margin-bottom:14px}
    .form-group label{display:block;margin-bottom:8px;font-weight:600}
    .form-group input,.form-group textarea,.form-group select{width:100%;padding:10px;background:rgba(255,255,255,0.05);border:2px solid var(--border);border-radius:8px;color:var(--text)}
    .close{float:right;font-size:24px;cursor:pointer;color:var(--muted)}
    .loading{text-align:center;padding:30px;color:var(--muted)}
    .no-items{text-align:center;color:var(--muted);padding:30px;font-style:italic}

    /* Console Panel */
    #console-panel{position:fixed;left:0;right:0;bottom:0;height:260px;background:var(--panel-bg);color:#d4d4d4;font-family:Consolas,monospace;z-index:99999;display:flex;flex-direction:column;border-top:2px solid #222}
    #console-header{display:flex;align-items:center;padding:8px 10px;background:#222;border-bottom:1px solid #2a2a2a}
    #console-header .title{font-weight:700;color:#fff;margin-right:auto}
    #console-controls{display:flex;gap:8px;align-items:center}
    #console-controls button,#console-controls select{background:#2b2b2b;color:#fff;border:0;padding:6px 10px;border-radius:6px;cursor:pointer}
    #console-body{display:flex;flex:1;gap:12px}
    #console-content{flex:1;padding:10px;overflow-y:auto;border-right:1px solid #292929;white-space:pre-wrap}
    #console-sidebar{width:320px;padding:10px;background:#171717}
    .log-entry{padding:6px 4px;border-bottom:1px dashed rgba(255,255,255,0.03);font-size:13px}
    .log-ts{color:#9aa7d6;margin-right:6px;font-size:11px}
    .field-list{margin-top:8px;font-size:13px;color:#cfd8ff}
    .small-muted{font-size:12px;color:#9aa}
    .auth-controls{display:flex;gap:8px;margin-top:8px}
    .small-btn{padding:6px 8px;border-radius:6px;border:0;background:rgba(255,255,255,0.1);color:#fff;cursor:pointer}

    .hidden {
      display: none !important;
    }

    .back-btn {
      background: rgba(255,255,255,0.1);
      border: none;
      color: white;
      padding: 10px 20px;
      border-radius: 25px;
      cursor: pointer;
      font-size: 1rem;
      transition: all 0.3s ease;
    }

    .back-btn:hover {
      background: rgba(0, 212, 255, 0.3);
    }

    </style>
</head>
<body>
  <!-- Loading Screen -->
  <div class="loading-screen" id="loadingScreen">
    <div class="loading-spinner"></div>
    <div class="loading-text">Verifying admin access...</div>
  </div>

  <!-- Stars Background -->
  <div class="stars" id="stars"></div>

  <div class="container" id="mainContainer" style="display:none">
    <div class="header">
      <div style="display:flex;align-items:center;gap:12px">
        <button class="back-btn" onclick="goBack()">
          <i class="fas fa-arrow-left"></i>
        </button>
        <h1><i class="fas fa-rocket"></i> Portfolio Manager</h1>
      </div>
      <div class="controls">
        <button class="btn btn-primary" onclick="showFolderModal()">Add Folder</button>
        <button class="btn btn-secondary" onclick="showUnassignedItems()">View Unassigned Items</button>
        <button class="btn btn-secondary" onclick="ensureFolderIdField()">Fix Missing Fields</button>
      </div>
    </div>

    <section class="folders-section">
      <h2 class="section-title">Portfolio Folders</h2>
      <div id="foldersGrid" class="folders-grid"></div>
    </section>

    <section class="items-section">
      <div id="folderHeader" class="folder-header" style="display:none">
        <h2 class="folder-name" id="currentFolderName"></h2>
        <button class="btn btn-secondary" onclick="resetView()">Back to All</button>
      </div>
      <h2 class="section-title" id="itemsSectionTitle">All Portfolio Items</h2>
      <div id="itemsGrid" class="items-grid"></div>
    </section>
  </div>

  <!-- Folder Modal -->
  <div id="folderModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeFolderModal()">&times;</span>
      <h2 id="folderModalTitle">Add New Folder</h2>
      <form id="folderForm">
        
        <button type="submit" class="btn btn-primary">Assign Item</button>
      </form>
    </div>
  </div>

  <!-- Edit Item Modal -->
  <div id="editItemModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeEditItemModal()">&times;</span>
      <h2>Edit Item</h2>
      <form id="editItemForm">
        <div class="form-group">
          <label for="editItemTitle">Title</label>
          <input type="text" id="editItemTitle" required>
        </div>
        <div class="form-group">
          <label for="editItemDescription">Description</label>
          <textarea id="editItemDescription" rows="3"></textarea>
        </div>
        <button type="submit" class="btn btn-primary">Save Changes</button>
      </form>
    </div>
  </div>

  <!-- Console Panel -->
  <div id="console-panel" aria-live="polite">
    <div id="console-header">
      <div class="title">Debug Console</div>
      <div id="console-controls">
        <select id="console-level"><option value="all">All</option><option value="log">Log</option><option value="info">Info</option><option value="success">Success</option><option value="warning">Warn</option><option value="error">Error</option></select>
        <button id="clear-console">Clear</button>
        <button id="download-console">Export</button>
        <button id="toggle-console">Hide</button>
      </div>
    </div>

    <div id="console-body">
      <div id="console-content"></div>
      <div id="console-sidebar">
        <div><strong>Auth info</strong></div>
        <div class="small-muted">Signed-in Gmail:</div>
        <div id="sidebar-email" style="color:#dff1ff">—</div>
        <div class="small-muted" style="margin-top:8px">User UID:</div>
        <div id="sidebar-uid" style="color:#dff1ff">—</div>

        <div class="auth-controls" style="margin-top:12px">
          <button id="signin-btn" class="small-btn">Sign in (Google)</button>
          <button id="signout-btn" class="small-btn" style="display:none">Sign out</button>
        </div>

        <div style="margin-top:12px"><strong>Fields accessed (aggregated)</strong></div>
        <div id="sidebar-fields" class="field-list">—</div>

        <div style="margin-top:8px"><strong>Last attempted fields</strong></div>
        <div id="sidebar-last" style="font-size:13px;color:#cfd8ff">—</div>
        <div style="margin-top:12px" class="small-muted">Shortcut: Ctrl + ` to toggle panel</div>
      </div>
    </div>
  </div>

  <!-- Firebase compat v11.9.0 -->
  <script src="https://www.gstatic.com/firebasejs/11.9.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.9.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.9.0/firebase-firestore-compat.js"></script>

  <script>
    /**************** Console panel core ****************/
    (function(){
      if(window.consolePanelInitialized) return;
      window.consolePanelInitialized = true;

      const content = document.getElementById('console-content');
      const clearBtn = document.getElementById('clear-console');
      const toggleBtn = document.getElementById('toggle-console');
      const downloadBtn = document.getElementById('download-console');
      const levelSelect = document.getElementById('console-level');
      const panel = document.getElementById('console-panel');

      let isVisible = true;
      let currentFilter = 'all';
      const logs = [];

      function esc(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'<').replace(/>/g,'>'); }

      window.consolePanelLog = function(message, level='log'){
        try {
          const ts = new Date();
          const msg = (typeof message === 'string') ? message : JSON.stringify(message, null, 2);
          const entry = { ts: ts.toISOString(), level, message: msg };
          logs.push(entry);
          if(currentFilter !== 'all' && currentFilter !== level) return;
          const div = document.createElement('div');
          div.className = 'log-entry';
          const time = ts.toLocaleTimeString();
          div.innerHTML = `<span class="log-ts">[${time}]</span><strong>${level.toUpperCase()}</strong>: <span style="color:#ddd">${esc(msg)}</span>`;
          content.appendChild(div);
          content.scrollTop = content.scrollHeight;
        } catch(e){}
      };

      // keep originals
      const orig = { log: console.log.bind(console), info: console.info.bind(console), warn: console.warn.bind(console), error: console.error.bind(console) };
      console.log = function(...a){ orig.log(...a); window.consolePanelLog(a.join(' '),'log'); };
      console.info = function(...a){ orig.info(...a); window.consolePanelLog(a.join(' '),'info'); };
      console.warn = function(...a){ orig.warn(...a); window.consolePanelLog(a.join(' '),'warning'); };
      console.error = function(...a){ orig.error(...a); window.consolePanelLog(a.join(' '),'error'); };

      clearBtn.onclick = () => { content.innerHTML=''; logs.length=0; };
      toggleBtn.onclick = () => { isVisible = !isVisible; panel.style.display = isVisible ? 'flex' : 'none'; toggleBtn.textContent = isVisible ? 'Hide' : 'Show'; };
      downloadBtn.onclick = () => {
        const blob = new Blob([JSON.stringify(logs,null,2)],{type:'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href=url; a.download=`console-logs-${new Date().toISOString()}.json`; a.click();
        setTimeout(()=>URL.revokeObjectURL(url),3000);
      };
      levelSelect.onchange = function(){ currentFilter=this.value; content.innerHTML=''; logs.forEach(e=>{ if(currentFilter==='all' || e.level===currentFilter) window.consolePanelLog(e.message,e.level); }); };

      document.addEventListener('keydown', (ev)=>{ if(ev.ctrlKey && ev.key === '`') toggleBtn.click(); });
    })();
  </script>

  <script>
    /**************** App + Firebase ****************/
    const firebaseConfig = {
      apiKey: "AIzaSyD0Yv_bQjxi2_kjzPR4XHOlaB7Sb6NRVUc",
      authDomain: "teamgalaxy-77344.firebaseapp.com",
      projectId: "teamgalaxy-77344",
      storageBucket: "teamgalaxy-77344.firebasestorage.app",
      messagingSenderId: "770256225320",
      appId: "1:770256225320:web:5a363ebd757de6cde3a11d",
      measurementId: "G-6C2W9NSNCH"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // Track fields accessed by client operations
    const accessedFields = new Set();
    let lastAttemptedFields = [];

    function recordAccess(fields, note){
      const list = Array.from(fields || []);
      lastAttemptedFields = list;
      list.forEach(f => accessedFields.add(f));
      document.getElementById('sidebar-fields').textContent = Array.from(accessedFields).sort().join(', ') || '—';
      document.getElementById('sidebar-last').textContent = (note ? note + ' | ' : '') + (list.length ? list.join(', ') : '—');
      consolePanelLog(`[FIELDS] ${note || 'access'} → ${list.join(', ')}`, 'info');
    }

    // Auth UI wiring (console sidebar)
    document.getElementById('signin-btn').addEventListener('click', async ()=>{
      const provider = new firebase.auth.GoogleAuthProvider();
      try {
        const res = await auth.signInWithPopup(provider);
        consolePanelLog('Signed in: ' + (res.user && res.user.email), 'success');
      } catch (e) {
        consolePanelLog('Sign-in failed: ' + e.message, 'error');
      }
    });
    document.getElementById('signout-btn').addEventListener('click', async ()=>{
      try {
        await auth.signOut();
        consolePanelLog('Signed out', 'info');
      } catch (e) { consolePanelLog('Sign-out failed: ' + e.message, 'error'); }
    });

    // Elements
    const foldersGrid = document.getElementById('foldersGrid');
    const itemsGrid = document.getElementById('itemsGrid');
    const itemsSectionTitle = document.getElementById('itemsSectionTitle');
    const folderHeader = document.getElementById('folderHeader');
    const currentFolderName = document.getElementById('currentFolderName');
    const folderModal = document.getElementById('folderModal');
    const assignModal = document.getElementById('assignModal');
    const editItemModal = document.getElementById('editItemModal');
    const folderForm = document.getElementById('folderForm');
    const assignForm = document.getElementById('assignForm');
    const editItemForm = document.getElementById('editItemForm');

    let currentFolder = null;
    let folders = [];
    let items = [];
    let currentItemToAssign = null;
    let currentItemToEdit = null;

    // Basic helpers
    function formatFileSize(bytes){
      if(bytes == null || bytes === 0) return '0 Bytes';
      const k=1024; const sizes=['Bytes','KB','MB','GB'];
      const i = Math.floor(Math.log(Math.max(bytes,1))/Math.log(k));
      return (bytes/Math.pow(k,i)).toFixed(2)+' '+sizes[i];
    }
    function escapeHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'<').replace(/>/g,'>'); }

     && i.url === imageIdentifier));
        if(idx === -1 && !isNaN(Number(imageIdentifier))) idx = Number(imageIdentifier);
        if(idx < 0 || idx >= imgs.length) return alert('Image not found in folder');

        const selected = imgs.splice(idx,1)[0];
        // bump others
        imgs.forEach(i=> i.orderBy = (i.orderBy || i.order || 0) + 1);
        selected.orderBy = 0;
        imgs.unshift(selected);

        await ref.update({ images: imgs, updatedAt: firebase.firestore.FieldValue.serverTimestamp() });
        consolePanelLog('Set primary image', 'success');
        await loadFolders();
      } catch (err){
        consolePanelLog('Error setting primary image: ' + (err.code ? `${err.code} — ${err.message}` : err.message), 'error');
        alert('Could not set primary image. See console.');
      }
    }

    // Render item card
    function renderItem(item){
      const itemCard = document.createElement('div');
      itemCard.className = 'item-card';
      itemCard.dataset.id = item.id;
      itemCard.dataset.category = item.category || 'uncategorized';

      const assignedIndicator = item.folderId ? `<div class="assigned-indicator">In ${escapeHtml((folders.find(f=>f.id===item.folderId)||{}).title||'Folder')}</div>` : '';

      itemCard.innerHTML = `
        ${assignedIndicator}
        <div class="item-actions">
          <button class="edit-item-btn">Edit</button>
          <button class="assign-btn">Assign</button>
        </div>
        <img src="${escapeHtml(item.dropboxUrl||'')}" class="item-image" onerror="this.src='';">
        <div class="item-info">
          <div class="item-title">${escapeHtml(item.title||item.originalName||'Untitled')}</div>
          <div class="item-category">${escapeHtml(item.category||'Uncategorized')}</div>
          <div class="item-meta">${escapeHtml(item.originalName||'No name')} • ${formatFileSize(item.fileSize||0)}</div>
        </div>
      `;

      // wire actions
      const editBtn = itemCard.querySelector('.edit-item-btn');
      const assignBtn = itemCard.querySelector('.assign-btn');
      editBtn.addEventListener('click', (e)=>{ e.stopPropagation(); editItem(item.id); });
      assignBtn.addEventListener('click', (e)=>{ e.stopPropagation(); assignItem(item.id); });

      itemsGrid.appendChild(itemCard);
    }

    // selection + view functions
    function selectFolder(folderId){
      currentFolder = folderId;
      document.querySelectorAll('.folder-card').forEach(c => c.classList.toggle('active', c.dataset.id === folderId));
      const folder = folders.find(f=>f.id===folderId);
      if(folder){
        currentFolderName.textContent = folder.title;
        folderHeader.style.display = 'flex';
        itemsSectionTitle.textContent = `Items in ${folder.title}`;
      }
      loadItems(folderId);
    }
    async function showUnassignedItems(){
      currentFolder = 'unassigned';
      document.querySelectorAll('.folder-card').forEach(c => c.classList.remove('active'));
      folderHeader.style.display='none';
      itemsSectionTitle.textContent = 'Unassigned Portfolio Items';
      await loadItems('unassigned');
    }
    async function resetView(){ currentFolder=null; document.querySelectorAll('.folder-card').forEach(c=>c.classList.remove('active')); folderHeader.style.display='none'; itemsSectionTitle.textContent='All Portfolio Items'; await loadItems(); }

    // folder dropdown populate for assign modal
    function populateFolderDropdown(){
      const sel = document.getElementById('assignFolder');
      sel.innerHTML = '<option value="">No Folder</option>';
      folders.forEach(f => {
        const o = document.createElement('option'); o.value=f.id; o.textContent=f.title; sel.appendChild(o);
      });
    }

    // modal helpers
    function showFolderModal(){ document.getElementById('folderModalTitle').textContent='Add New Folder'; folderForm.reset(); folderForm.removeAttribute('data-folder-id'); document.getElementById('folderOrder').value=''; folderModal.style.display='block'; }
    function closeFolderModal(){ folderModal.style.display='none'; }
    function assignItem(itemId){ currentItemToAssign = itemId; populateFolderDropdown(); document.getElementById('assignPrimary').checked = false; assignModal.style.display='block'; }
    function closeAssignModal(){ assignModal.style.display='none'; currentItemToAssign=null; }
    function editItem(itemId){
      const it = items.find(i=>i.id===itemId); if(!it) return;
      currentItemToEdit = itemId;
      document.getElementById('editItemTitle').value = it.title || '';
      document.getElementById('editItemDescription').value = it.description || '';
      editItemModal.style.display='block';
    }
    function closeEditItemModal(){ editItemModal.style.display='none'; currentItemToEdit=null; }

    // Edit folder
    function editFolder(folderId){
      const folder = folders.find(f=>f.id===folderId); if(!folder) return;
      document.getElementById('folderModalTitle').textContent='Edit Folder';
      document.getElementById('folderTitle').value = folder.title || '';
      document.getElementById('folderDescription').value = folder.description || '';
      document.getElementById('folderPublic').value = folder.isPublic ? 'true' : 'false';
      document.getElementById('folderOrder').value = (folder.folderOrder != null) ? folder.folderOrder : '';
      folderForm.setAttribute('data-folder-id', folderId);
      folderModal.style.display = 'block';
    }

    // Delete folder (moves items to unassigned)
    async function deleteFolder(folderId){
      if(!confirm('Delete folder? Items will be moved to Unassigned.')) return;
      try {
        recordAccess(['folderId'], `delete portfolioFolders/${folderId} (and update portfolioItems.folderId)`);
        const itemsInFolder = await db.collection('portfolioItems').where('folderId','==',folderId).get();
        const batch = db.batch();
        itemsInFolder.forEach(doc => batch.update(doc.ref, { folderId: null }));
        await batch.commit();
        await db.collection('portfolioFolders').doc(folderId).delete();
        consolePanelLog('Folder deleted and items moved to unassigned', 'success');
        await init();
      } catch (err){
        consolePanelLog('Error deleting folder: ' + (err.code ? `${err.code} — ${err.message}` : err.message), 'error');
      }
    }
    // ensure folderId exists on all items (adds missing field)
    async function ensureFolderIdField(){
      try {
        recordAccess(['folderId'], 'ensureFolderIdField (batch update)');
        const snap = await db.collection('portfolioItems').get();
        const batch = db.batch();
        let updated = 0;
        snap.forEach(doc => { const d = doc.data(); if(d.folderId === undefined){ batch.update(doc.ref, { folderId: null }); updated++; } });
        if(updated > 0){ await batch.commit(); alert(`Added folderId=null to ${updated} docs`); await init(); }
        else alert('All items already have folderId field');
      } catch (err){
        consolePanelLog('Error fixing folderId fields: ' + (err.code ? `${err.code} — ${err.message}` : err.message), 'error');
        alert('Error fixing fields. See console.');
      }
    }

    // Folder form submit (create or update)
    folderForm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const folderId = folderForm.getAttribute('data-folder-id');
      const data = {
        title: document.getElementById('folderTitle').value,
        description: document.getElementById('folderDescription').value,
        isPublic: document.getElementById('folderPublic').value === 'true',
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      };
      const orderVal = document.getElementById('folderOrder').value;
      if(orderVal !== '') data.folderOrder = parseInt(orderVal,10);
      try {
        if(folderId){
          recordAccess(Object.keys(data), `update portfolioFolders/${folderId}`);
          await db.collection('portfolioFolders').doc(folderId).update(data);
          consolePanelLog('Folder updated', 'success');
        } else {
          data.createdAt = firebase.firestore.FieldValue.serverTimestamp();
          data.folderOrder = (data.folderOrder != null) ? data.folderOrder : (folders.length || 0);
          recordAccess(Object.keys(data), 'create portfolioFolders');
          await db.collection('portfolioFolders').add(data);
          consolePanelLog('Folder created', 'success');
        }
        closeFolderModal(); await init();
      } catch (err){
        consolePanelLog('Error saving folder: ' + (err.code ? `${err.code} — ${err.message}` : err.message), 'error');
        alert('Error saving folder. See console.');
      }
    });

    // Assign form submit
    assignForm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      if(!currentItemToAssign) return;
      const selectedFolderId = document.getElementById('assignFolder').value || null;
      const makePrimary = document.getElementById('assignPrimary').checked;
      const item = items.find(i=>i.id===currentItemToAssign);
      if(!item) return;
      try {
        // prepare batch update: update item's folderId, update target folder images and old folder images
        const batch = db.batch();
        const itemRef = db.collection('portfolioItems').doc(currentItemToAssign);
        recordAccess(['folderId','images'], `assign portfolioItems/${currentItemToAssign}`);
        batch.update(itemRef, { folderId: selectedFolderId });

        if(selectedFolderId){
          const folderRef = db.collection('portfolioFolders').doc(selectedFolderId);
          const folderDoc = await folderRef.get();
          const folderImages = folderDoc.exists ? (folderDoc.data().images || []) : [];

          if(makePrimary){
            folderImages.forEach(img => { img.orderBy = (img.orderBy || img.order || 0) + 1; });
            folderImages.unshift({ id: item.id, url: item.dropboxUrl, title: item.title, orderBy: 0 });
          } else {
            const nextOrder = (folderImages.length > 0) ? Math.max(...folderImages.map(i=> (i.orderBy||i.order||0))) + 1 : 0;
            folderImages.push({ id: item.id, url: item.dropboxUrl, title: item.title, orderBy: nextOrder });
          }
          batch.update(folderRef, { images: folderImages });
        }

        if(item.folderId){
          const oldRef = db.collection('portfolioFolders').doc(item.folderId);
          const oldDoc = await oldRef.get();
          if(oldDoc.exists){
            const oldImgs = oldDoc.data().images || [];
            const filtered = oldImgs.filter(img => img.id !== item.id);
            batch.update(oldRef, { images: filtered });
          }
        }

        await batch.commit();
        closeAssignModal(); await init();
        consolePanelLog('Item assigned successfully', 'success');
      } catch (err){
        consolePanelLog('Error assigning item: ' + (err.code ? `${err.code} — ${err.message}` : err.message), 'error');
        alert('Error assigning item. See console.');
      }
    });

    // Edit item submit
    editItemForm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      if(!currentItemToEdit) return;
      const item = items.find(i=>i.id===currentItemToEdit); if(!item) return;
      const updatedData = { title: document.getElementById('editItemTitle').value, description: document.getElementById('editItemDescription').value };
      try {
        recordAccess(Object.keys(updatedData), `update portfolioItems/${currentItemToEdit}`);
        await db.collection('portfolioItems').doc(currentItemToEdit).update(updatedData);
        // update folder images array if present
        if(item.folderId){
          const folderRef = db.collection('portfolioFolders').doc(item.folderId);
          const folderDoc = await folderRef.get();
          if(folderDoc.exists){
            const arr = folderDoc.data().images || [];
            const idx = arr.findIndex(x=>x.id===currentItemToEdit);
            if(idx !== -1){
              arr[idx].title = updatedData.title;
              await folderRef.update({ images: arr });
            }
          }
        }
        closeEditItemModal(); await init(); consolePanelLog('Item updated', 'success');
      } catch (err){
        consolePanelLog('Error updating item: ' + (err.code ? `${err.code} — ${err.message}` : err.message), 'error');
        alert('Error updating item. See console.');
      }
    });

    // Delete item function (used from other UI places if added)
    async function deleteItem(itemId){
      if(!confirm('Delete this item?')) return;
      try {
        recordAccess(['__delete__'], `delete portfolioItems/${itemId}`);
        await db.collection('portfolioItems').doc(itemId).delete();
        consolePanelLog('Item deleted: ' + itemId, 'success');
        await init();
      } catch (err){
        consolePanelLog('Delete failed: ' + (err.code ? `${err.code} — ${err.message}` : err.message), 'error');
        alert('Delete failed. See console.');
      }
    }

    // Admin verification function
    async function checkAdminAccess() {
      try {
        const user = await new Promise((resolve, reject) => {
          const unsubscribe = auth.onAuthStateChanged(async (user) => {
            if (user) {
              try {
                const adminQuery = await db.collection('admin').where('gmail', '==', user.email).limit(1).get();
                if (!adminQuery.empty) {
                  unsubscribe();
                  resolve(user);
                } else {
                  unsubscribe();
                  throw new Error('Not an admin');
                }
              } catch (error) {
                unsubscribe();
                throw error;
              }
            } else {
              unsubscribe();
              throw new Error('Not signed in');
            }
          });
        });

        // Show main content after admin verification
        setTimeout(() => {
          document.getElementById('loadingScreen').style.opacity = '0';
          setTimeout(() => {
            document.getElementById('loadingScreen').classList.add('hidden');
            document.getElementById('mainContainer').style.display = 'block';
          }, 500);
        }, 1500);

      } catch (error) {
        console.error('Admin access error:', error);
        document.getElementById('loadingScreen').querySelector('.loading-text').textContent = 'Access denied. Redirecting...';
        setTimeout(() => {
          window.location.href = 'index.html';
        }, 2000);
      }
    }

    // Create stars background
    function createStars() {
      const starsContainer = document.getElementById('stars');
      const starCount = 150;

      for (let i = 0; i < starCount; i++) {
        const star = document.createElement('div');
        star.classList.add('star');

        const x = Math.random() * 100;
        const y = Math.random() * 100;
        star.style.left = `${x}%`;
        star.style.top = `${y}%`;

        const size = Math.random() * 3 + 1;
        star.style.width = `${size}px`;
        star.style.height = `${size}px`;

        const duration = Math.random() * 5 + 2;
        star.style.setProperty('--duration', `${duration}s`);

        starsContainer.appendChild(star);
      }
    }

    // Go back function
    function goBack() {
      window.location.href = '../admin_panel.html';
    }

    // init on load
    window.onload = function() {
      createStars();
      checkAdminAccess();
    };

    // expose some funcs for debugging if needed
    window._tg = { loadFolders, loadItems, ensureFolderIdField, recordAccess, deleteItem, setPrimaryImage };
  </script>
</body>
</html>
