<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>TeamGalaxy Portfolio Manager</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"/>
  <style>
    :root{
      --primary-bg: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
      --card-bg: rgba(25, 25, 35, 0.9);
      --glass-border: 1px solid rgba(255,255,255,0.1);
      --panel-bg: #1e1e1e;
      --muted: rgba(255,255,255,0.75);
      --accent: linear-gradient(45deg,#00d4ff,#0077ff);
      --primary: #00d4ff;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%}
    body{
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background:var(--primary-bg); color:#fff; padding:20px; line-height:1.5;
      position: relative; overflow-x: hidden;
    }

    .container{max-width:1200px;margin:0 auto;position:relative;z-index:10}
    .header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:20px}
    .title { display:flex; align-items:center; gap:12px; }
    .title h1{ font-size:1.5rem; background:var(--accent); -webkit-background-clip:text; -webkit-text-fill-color:transparent; margin:0 }
    .auth-area{display:flex;gap:8px;align-items:center}
    .auth-btn{background:rgba(255,255,255,0.1);border:0;padding:8px 10px;border-radius:8px;color:#fff;cursor:pointer}
    .auth-badge{background:rgba(255,255,255,0.04);padding:6px 10px;border-radius:12px;font-size:13px}
    .stats{display:flex;gap:12px;margin:14px 0 18px;flex-wrap:wrap}
    .stat-card{background:var(--card-bg);border:var(--glass-border);border-radius:10px;padding:10px 14px;min-width:120px;text-align:center}
    .stat-number{font-weight:700;font-size:1.2rem;background:var(--accent);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    .controls{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .upload-section{background:var(--card-bg);border:var(--glass-border);padding:14px;border-radius:10px;min-width:420px}
    .file-input-wrapper{position:relative;display:inline-block;background:rgba(255,255,255,0.02);padding:12px 18px;border-radius:999px;border:2px dashed rgba(255,255,255,0.06);cursor:pointer}
    .file-input{position:absolute;left:0;top:0;opacity:0;width:100%;height:100%}
    .upload-btn{background:linear-gradient(45deg,var(--primary),#0077ff);border:0;color:#fff;padding:8px 12px;border-radius:12px;cursor:pointer}
    .preview-container{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .preview-item{width:88px;height:88px;border-radius:8px;overflow:hidden;border:1px solid rgba(255,255,255,0.04);display:flex;align-items:center;justify-content:center;position:relative}
    .preview-item img{width:100%;height:100%;object-fit:cover}
    .gallery{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:16px;margin-top:18px}
    .image-card{background:var(--card-bg);border:var(--glass-border);border-radius:10px;overflow:hidden;position:relative}
    .image-preview{width:100%;height:160px;object-fit:cover;background:#222}
    .image-info{padding:10px}
    .image-title{font-weight:700}
    .image-meta{font-size:12px;color:rgba(255,255,255,0.7);margin-top:6px}
    .image-actions{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap}
    .action-btn{background:rgba(255,255,255,0.03);border:var(--glass-border);padding:6px 8px;border-radius:8px;color:#fff;cursor:pointer}

    .pagination { display:flex; gap:8px; align-items:center; justify-content:center; margin-top:16px; flex-wrap:wrap }
    .page-btn { background:rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.04); color:#fff; padding:8px 10px; border-radius:8px; cursor:pointer; }
    .page-btn.active { background: linear-gradient(45deg,#00d4ff,#0077ff); color:#000; font-weight:700; }

    /* Loading Screen */
    .loading-screen { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(8,7,20,0.95); display:flex; flex-direction:column; align-items:center; justify-content:center; z-index:2000; gap:12px; }
    .loading-spinner{ width:64px;height:64px;border:6px solid rgba(255,255,255,0.06);border-top:6px solid var(--primary);border-radius:50%;animation:spin 1s linear infinite;}
    @keyframes spin {0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
    .loading-title{ font-size:1.25rem; color:var(--primary); font-weight:700; }
    .loading-sub{ color:#d7eaff; font-size:0.95rem; opacity:0.9; }
    .loading-progress{ width:360px; max-width:90%; background:rgba(255,255,255,0.04); border-radius:12px; padding:6px; border:1px solid rgba(255,255,255,0.03); }
    .loading-bar { height:10px; background:linear-gradient(90deg,#00d4ff,#0077ff); width:0%; border-radius:8px; transition:width 300ms linear; }

    /* Console Panel restored */
    #console-panel{ position:fixed; left:0; right:0; bottom:0; height:260px; background:var(--panel-bg); color:#d4d4d4; font-family:Consolas,monospace; z-index:99999; display:flex; flex-direction:column; border-top:2px solid #262626; overflow: hidden; box-shadow: 0 -6px 24px rgba(0,0,0,0.6); }
    #console-header{display:flex;align-items:center;gap:8px;padding:8px 10px;background:#222;border-bottom:1px solid #2a2a2a;flex:0 0 auto}
    #console-controls{display:flex;gap:8px;align-items:center}
    #console-controls button, #console-controls select{background:#2b2b2b;color:#fff;border:0;padding:6px 8px;border-radius:6px;cursor:pointer}
    #console-body{display:flex;flex:1;gap:12px;overflow:hidden;min-height:0}
    #console-content{flex:1;padding:10px;overflow:auto;border-right:1px solid #2a2a2a;white-space:pre-wrap;word-break:break-word;overflow-wrap:anywhere;font-size:13px}
    #console-sidebar{width:320px;padding:10px;background:#181818;overflow:auto}
    .log-entry{padding:6px 4px;border-bottom:1px dashed rgba(255,255,255,0.03);font-size:13px}
    .small-muted{font-size:12px;color:#9aa}

    .hidden { display: none !important; }

    @media (max-width:720px){ #console-sidebar{display:none} #console-panel{height:280px} }
  </style>
</head>
<body>
  <div class="loading-screen" id="loadingScreen">
    <div class="loading-spinner"></div>
    <div class="loading-title" id="loadingTitle">Verifying admin access...</div>
    <div class="loading-sub" id="loadingSub">Preparing your portfolio...</div>
    <div class="loading-progress" id="loadingProgressWrap" style="display:none">
      <div style="display:flex;justify-content:space-between;font-size:12px;margin-bottom:6px">
        <div id="loadingCount">0 / 0</div>
        <div id="loadingPercent">0%</div>
      </div>
      <div style="background:rgba(255,255,255,0.04);padding:6px;border-radius:8px"><div class="loading-bar" id="loadingBar" style="width:0%"></div></div>
      <div style="margin-top:6px;font-size:12px;color:#d4e8ff" id="loadingDetail">Starting...</div>
    </div>
  </div>

  <div class="container" id="mainContainer" style="display:none">
    <div class="header">
      <div class="title">
        <button class="page-btn back-btn" onclick="goBack()"><i class="fas fa-arrow-left"></i></button>
        <h1><i class="fas fa-rocket"></i> TeamGalaxy Portfolio Manager</h1>
      </div>
      <div class="auth-area">
        <div id="authBadge" class="auth-badge">Not signed in</div>
        <button id="btnSignIn" class="auth-btn">Sign in (Google)</button>
        <button id="btnSignOut" class="auth-btn" style="display:none">Sign out</button>
      </div>
    </div>

    <div class="stats">
      <div class="stat-card"><div class="stat-number" id="totalImages">0</div><div class="stat-label">Total Images</div></div>
      <div class="stat-card"><div class="stat-number" id="publicImages">0</div><div class="stat-label">Public</div></div>
      <div class="stat-card"><div class="stat-number" id="storageUsed">0 MB</div><div class="stat-label">Storage</div></div>
    </div>

    <div class="controls">
      <div class="upload-section">
        <div class="file-input-wrapper" title="Click to select images or drag & drop">
          <input type="file" id="imageUpload" class="file-input" accept="image/*" multiple>
          <span><i class="fas fa-cloud-upload-alt"></i> Select images (max 5)</span>
        </div>
        <button id="uploadBtn" class="upload-btn"><i class="fas fa-upload"></i> Upload to Portfolio</button>
        <div id="previewContainer" class="preview-container"></div>
        <div id="uploadNotice" class="small-muted">Please select up to <strong>5 images</strong> at once.</div>
      </div>

      <div style="display:flex;flex-direction:column;gap:8px;align-items:flex-start">
        <select id="categoryFilter" style="padding:8px;border-radius:8px;background:rgba(0,0,0,0.2);border:var(--glass-border);color:#fff">
          <option value="all">All categories</option>
          <option value="web-design">Web Design</option>
          <option value="ui-ux">UI/UX</option>
          <option value="photography">Photography</option>
          <option value="illustration">Illustration</option>
        </select>
        <div class="small-muted">Uploads go to Cloudflare Worker → Dropbox (server).</div>
      </div>
    </div>

    <div id="loadingIndicator" style="display:none;margin-top:12px"><i class="fas fa-spinner fa-spin"></i> Uploading…</div>

    <div id="portfolioGallery" class="gallery"></div>

    <div id="pagination" class="pagination"></div>
  </div>

  <!-- Console Panel -->
  <div id="console-panel" aria-live="polite">
    <div id="console-header">
      <div class="title">Debug Console</div>
      <div id="console-controls">
        <select id="console-level"><option value="all">All</option><option value="log">Log</option><option value="info">Info</option><option value="success">Success</option><option value="warning">Warn</option><option value="error">Error</option></select>
        <button id="clear-console"><i class="fas fa-trash"></i> Clear</button>
        <button id="download-console"><i class="fas fa-download"></i> Export</button>
        <button id="toggle-console">Hide</button>
      </div>
    </div>

    <div id="console-body">
      <div id="console-content"></div>
      <div id="console-sidebar">
        <div style="margin-bottom:8px"><strong>Auth info</strong></div>
        <div class="small-muted">Signed-in Gmail:</div>
        <div id="sidebar-email" style="margin-bottom:8px;color:#dff1ff">—</div>
        <div class="small-muted">User UID:</div>
        <div id="sidebar-uid" style="margin-bottom:12px;color:#dff1ff">—</div>

        <div style="margin-top:8px"><strong>Fields accessed (aggregated)</strong></div>
        <div id="sidebar-fields" class="small-muted">—</div>

        <div style="margin-top:12px" class="small-muted">Shortcuts: Ctrl + ` to toggle panel</div>
      </div>
    </div>
  </div>

  <div style="height:28px"></div>

  <!-- Firebase compat libs v11.9.0 -->
  <script src="https://www.gstatic.com/firebasejs/11.9.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.9.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.9.0/firebase-firestore-compat.js"></script>

  <script>
  /* Console Panel Core (restored) */
  (function(){
    if(window.consolePanelInitialized) return;
    window.consolePanelInitialized = true;
    const content = document.getElementById('console-content');
    const clearBtn = document.getElementById('clear-console');
    const toggleBtn = document.getElementById('toggle-console');
    const downloadBtn = document.getElementById('download-console');
    const levelSelect = document.getElementById('console-level');
    const panel = document.getElementById('console-panel');
    let isVisible = true;
    let currentFilter = 'all';
    const logs = [];
    function esc(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'<').replace(/>/g,'>'); }
    window.consolePanelLog = function(message, level='log'){
      try {
        const ts = new Date();
        const msg = (typeof message === 'string') ? message : JSON.stringify(message,null,2);
        const entry = { ts: ts.toISOString(), level, message: msg };
        logs.push(entry);
        if (currentFilter !== 'all' && currentFilter !== level) return;
        const div = document.createElement('div');
        div.className = 'log-entry';
        const time = ts.toLocaleTimeString();
        div.innerHTML = `<span class="log-ts">[${time}]</span><strong class="log-level-${level}">${level.toUpperCase()}</strong>: <span style="color:#ddd">${esc(msg)}</span>`;
        content.appendChild(div);
        content.scrollTop = content.scrollHeight;
      } catch (e) {}
    };
    const orig = {log:console.log, info:console.info, warn:console.warn, error:console.error};
    console.log = function(...a){ orig.log.apply(console,a); window.consolePanelLog(a.join(' '),'log'); };
    console.info = function(...a){ orig.info.apply(console,a); window.consolePanelLog(a.join(' '),'info'); };
    console.warn = function(...a){ orig.warn.apply(console,a); window.consolePanelLog(a.join(' '),'warning'); };
    console.error = function(...a){ orig.error.apply(console,a); window.consolePanelLog(a.join(' '),'error'); };
    clearBtn.onclick = () => { content.innerHTML = ''; logs.length = 0; };
    toggleBtn.onclick = () => { isVisible = !isVisible; panel.style.display = isVisible ? 'flex' : 'none'; toggleBtn.textContent = isVisible ? 'Hide' : 'Show'; };
    downloadBtn.onclick = () => { const blob = new Blob([JSON.stringify(logs,null,2)], {type:'application/json'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `console-logs-${new Date().toISOString()}.json`; a.click(); setTimeout(()=>URL.revokeObjectURL(url),3000); };
    levelSelect.onchange = function(){ currentFilter = this.value; content.innerHTML = ''; logs.forEach(e => { if (currentFilter==='all' || e.level===currentFilter) window.consolePanelLog(e.message,e.level); }); };
    document.addEventListener('keydown', (ev) => { if(ev.ctrlKey && ev.key === '`') toggleBtn.click(); });
  })();
  </script>

  <script>
  // App code
  const CLOUDFLARE_WORKER_URL = 'https://portfolio-dropbox-handler.teamgalaxy-interactive.workers.dev/';
  const firebaseConfig = {
    apiKey: "AIzaSyD0Yv_bQjxi2_kjzPR4XHOlaB7Sb6NRVUc",
    authDomain: "teamgalaxy-77344.firebaseapp.com",
    projectId: "teamgalaxy-77344",
    storageBucket: "teamgalaxy-77344.firebasestorage.app",
    messagingSenderId: "770256225320",
    appId: "1:770256225320:web:5a363ebd757de6cde3a11d",
    measurementId: "G-6C2W9NSNCH"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  function appLog(msg, level='info'){
    if(level === 'error') console.error(msg);
    else if(level === 'warning') console.warn(msg);
    else if(level === 'success') console.info(msg);
    else console.log(msg);
    if(window.consolePanelLog) window.consolePanelLog(msg, level==='success' ? 'success' : level);
  }

  // Track fields
  const accessedFields = new Set();
  function recordAccess(fields, note){
    fields = Array.from(fields || []);
    fields.forEach(f => accessedFields.add(f));
    document.getElementById('sidebar-fields').textContent = Array.from(accessedFields).sort().join(', ') || '—';
    document.getElementById('sidebar-uid') && (document.getElementById('sidebar-uid').textContent = document.getElementById('sidebar-uid').textContent || '—');
    appLog(`[FIELDS] ${note || 'access'} → ${fields.join(', ')}`, 'info');
  }

  // Auth UI
  async function updateAuthUI(user){
    const badge = document.getElementById('authBadge');
    const sidebarEmail = document.getElementById('sidebar-email');
    const sidebarUid = document.getElementById('sidebar-uid');
    if(!user){ badge.textContent='Not signed in'; sidebarEmail.textContent='—'; sidebarUid.textContent='—'; document.getElementById('btnSignIn').style.display='inline-block'; document.getElementById('btnSignOut').style.display='none'; appLog('No user signed in','warning'); return; }
    try { const idRes = await user.getIdTokenResult(true); } catch(e){ appLog('getIdTokenResult failed: '+e.message,'error'); }
    badge.textContent = user.email || user.uid;
    sidebarEmail.textContent = user.email || '—';
    sidebarUid.textContent = user.uid || '—';
    document.getElementById('btnSignIn').style.display='none';
    document.getElementById('btnSignOut').style.display='inline-block';
    appLog(`Auth: ${user.email || user.uid}`,'info');
    recordAccess(['ownerUid','u.email','u.uid','idToken.claims'], 'auth check');
  }
  document.getElementById('btnSignIn').addEventListener('click', async ()=>{ const provider = new firebase.auth.GoogleAuthProvider(); try { const res = await auth.signInWithPopup(provider); await updateAuthUI(res.user); appLog('Signed in: '+res.user.email,'success'); } catch(e){ appLog('Sign-in failed: '+e.message,'error'); }});
  document.getElementById('btnSignOut').addEventListener('click', async ()=>{ try { await auth.signOut(); updateAuthUI(null); appLog('Signed out','info'); } catch(e){ appLog('Sign-out failed: '+e.message,'error'); }});

  // Upload changes: include filderId = null
  const MAX_UPLOAD = 5;
  const inputEl = document.getElementById('imageUpload');
  const preview = document.getElementById('previewContainer');
  inputEl.addEventListener('change', handleFileSelect);
  function trimToMaxFiles(fileList){ const dt = new DataTransfer(); Array.from(fileList).slice(0,MAX_UPLOAD).forEach(f=>dt.items.add(f)); return dt.files; }
  function handleFileSelect(ev){
    const files = ev.target.files || [];
    preview.innerHTML = '';
    if(files.length === 0){ document.getElementById('uploadBtn').innerHTML = '<i class="fas fa-upload"></i> Upload to Portfolio'; return; }
    let finalFiles = files;
    if(files.length > MAX_UPLOAD){ alert(`You selected ${files.length} files. Only first ${MAX_UPLOAD} will be used.`); finalFiles = trimToMaxFiles(files); inputEl.files = finalFiles; }
    document.getElementById('uploadBtn').innerHTML = `<i class="fas fa-upload"></i> Upload ${finalFiles.length} File(s)`;
    Array.from(finalFiles).forEach(file => {
      if(!file.type.startsWith('image/')) return;
      const r = new FileReader();
      r.onload = (e)=>{ const d=document.createElement('div'); d.className='preview-item'; d.innerHTML=`<img src="${e.target.result}" alt="${file.name}"><div style="position:absolute;bottom:0;left:0;right:0;background:rgba(0,0,0,0.6);color:#fff;padding:2px;font-size:10px;text-align:center">${file.name}</div>`; preview.appendChild(d); };
      r.readAsDataURL(file);
    });
  }

  document.getElementById('uploadBtn').addEventListener('click', handleUpload);
  async function handleUpload(){
    const files = inputEl.files || [];
    if(files.length === 0){ alert('Select images first'); return; }
    if(files.length > MAX_UPLOAD){ alert(`Please select up to ${MAX_UPLOAD} files.`); return; }
    const user = auth.currentUser;
    if(!user){ if(!confirm('You are not signed in. Continue without ownerUid? (recommended: sign in)')) return; }
    document.getElementById('loadingIndicator').style.display = 'inline-block';
    const arr = Array.from(files);
    const results = await Promise.allSettled(arr.map((file,i)=> new Promise((resolve,reject)=>{ setTimeout(async ()=>{ try { await uploadToCloudflareWorker(file,user); resolve(true); } catch(e){ reject(e); } }, i*700); })));
    const failed = results.filter(r=>r.status==='rejected');
    if(failed.length) appLog(`${failed.length} upload(s) failed`,'error'); else appLog('All uploads done','success');
    document.getElementById('loadingIndicator').style.display='none';
    inputEl.value=''; preview.innerHTML=''; document.getElementById('uploadBtn').innerHTML = '<i class="fas fa-upload"></i> Upload to Portfolio';
  }

  async function uploadToCloudflareWorker(file, user){
    const category = document.getElementById('categoryFilter').value || 'uncategorized';
    const form = new FormData();
    form.append('file', file);
    form.append('category', category);
    form.append('title', file.name.replace(/\.[^/.]+$/,''));
    form.append('description', `Uploaded ${file.name}`);
    form.append('isPublic', 'false');

    appLog(`Uploading ${file.name}...`,'info');
    const resp = await fetch(`${CLOUDFLARE_WORKER_URL.replace(/\/$/,'')}/api/upload`, { method:'POST', body: form, mode:'cors' });
    if(!resp.ok){ const txt = await resp.text(); throw new Error(`Upload HTTP ${resp.status}: ${txt.substring(0,200)}`); }
    const res = await resp.json();
    if(!res.success) throw new Error(res.error || 'Upload failed');

    // add filderId = null to metadata
    const itemData = {
      ownerUid: user ? user.uid : null,
      folderId: null,
      fileName: res.fileName || file.name,
      originalName: file.name,
      fileSize: res.fileSize || file.size || 0,
      fileType: res.fileType || file.type,
      dropboxUrl: res.dropboxUrl || res.url || '',
      uploadDate: new Date(),
      lastModified: new Date(),
      category,
      title: file.name.replace(/\.[^/.]+$/,''),
      description: `Uploaded ${file.name}`,
      isPublic: false,
      meta: { dimensions: null }
    };

    recordAccess(Object.keys(itemData), 'create portfolioItems (upload)');
    try { const docRef = await db.collection('portfolioItems').add(itemData); appLog(`Saved metadata ${docRef.id}`,'success'); } catch(e){ appLog('Failed to save metadata: '+e.message,'error'); throw e; }
  }

  // ---------------- Pagination + Preload (slow retries) ----------------
  const PAGE_SIZE = 12;
  let allItems = []; // metadata array
  let currentPage = 1;
  const PRELOAD_MAX_RETRIES = 6;
  const PRELOAD_TIMEOUT_MS = 10000; // 10s per attempt
  const PRELOAD_CONCURRENCY = 2; // slow and steady
  const PRELOAD_BACKOFF_BASE = 300; // ms multiplier

  function sleep(ms){ return new Promise(r => setTimeout(r, ms)); }

  function preloadOnce(url, timeoutMs=PRELOAD_TIMEOUT_MS){
    return new Promise((resolve,reject)=>{
      if(!url) return reject(new Error('no-url'));
      const img = new Image();
      let done=false;
      const t = setTimeout(()=>{ if(done) return; done=true; img.src=''; reject(new Error('timeout')); }, timeoutMs);
      img.onload = ()=>{ if(done) return; done=true; clearTimeout(t); resolve(); };
      img.onerror = ()=>{ if(done) return; done=true; clearTimeout(t); reject(new Error('error')); };
      img.src = url;
    });
  }

  async function preloadWithRetries(url, idx, progressCb){
    let attempt = 0;
    while(attempt < PRELOAD_MAX_RETRIES){
      attempt++;
      try {
        progressCb && progressCb({ idx, attempt, status:'trying' });
        await preloadOnce(url);
        progressCb && progressCb({ idx, attempt, status:'loaded' });
        return { ok:true, attempt };
      } catch(e){
        progressCb && progressCb({ idx, attempt, status:'failed', error: e.message });
        await sleep(PRELOAD_BACKOFF_BASE * attempt);
      }
    }
    progressCb && progressCb({ idx, attempt: PRELOAD_MAX_RETRIES, status:'exhausted' });
    return { ok:false, attempt: PRELOAD_MAX_RETRIES };
  }

  async function preloadPage(itemsForPage, progressCb){
    const results = new Array(itemsForPage.length);
    let iIndex = 0;
    const workers = new Array(Math.min(PRELOAD_CONCURRENCY, itemsForPage.length)).fill(null).map(async ()=>{
      while(true){
        const i = iIndex++;
        if(i >= itemsForPage.length) break;
        const url = itemsForPage[i].dropboxUrl || '';
        const res = await preloadWithRetries(url, i, progressCb);
        results[i] = res;
      }
    });
    await Promise.all(workers);
    return results;
  }

  // Renders a page skeleton then preloads that page's images; hides loading screen after first page done
  async function renderPage(pageNum, options={showProgress:true}){
    currentPage = pageNum;
    const gallery = document.getElementById('portfolioGallery');
    gallery.innerHTML = '';
    const start = (pageNum - 1) * PAGE_SIZE;
    const pageItems = allItems.slice(start, start + PAGE_SIZE);

    // show skeleton cards with data-src
    pageItems.forEach(it => {
      const card = document.createElement('div');
      card.className = 'image-card';
      card.dataset.id = it.id;
      card.dataset.isPublic = it.isPublic ? 'true' : 'false';
      card.innerHTML = `
        <img class="image-preview" loading="eager" src="" data-src="${escapeHtml(it.dropboxUrl||'')}" alt="${escapeHtml(it.title||it.originalName||'')}">
        <div class="image-info">
          <div class="image-title">${escapeHtml(it.title||it.originalName||'Untitled')}</div>
          <div class="image-meta">Size: ${formatFileSize(it.fileSize||0)} | ${it.meta?.dimensions ? it.meta.dimensions.width + '×' + it.meta.dimensions.height : 'Unknown dims'}</div>
          <div class="image-actions"><button class="action-btn" onclick="copyToClipboard('${it.dropboxUrl||''}')"><i class="fas fa-copy"></i> Copy URL</button></div>
        </div>
      `;
      gallery.appendChild(card);
    });

    // Setup progress UI for page preload
    if(options.showProgress){
      document.getElementById('loadingProgressWrap').style.display = 'block';
      document.getElementById('loadingCount').textContent = `0 / ${pageItems.length}`;
      document.getElementById('loadingPercent').textContent = `0%`;
      document.getElementById('loadingBar').style.width = `0%`;
      document.getElementById('loadingDetail').textContent = `Loading page ${pageNum} images...`;
    } else {
      document.getElementById('loadingProgressWrap').style.display = 'none';
    }

    // Preload page images (slow & steady)
    const results = await preloadPage(pageItems, ({ idx, attempt, status, error })=>{
      const completed = results.filter(r=>r && r.ok).length;
      const failed = results.filter(r=>r && !r.ok).length;
      const total = pageItems.length;
      const percent = Math.round(((completed + failed) / total) * 100);
      document.getElementById('loadingCount').textContent = `${completed + failed} / ${total}`;
      document.getElementById('loadingPercent').textContent = `${percent}%`;
      document.getElementById('loadingBar').style.width = `${percent}%`;
      document.getElementById('loadingDetail').textContent = `Item ${idx+1}/${total} — attempt ${attempt} — ${status}${error ? ' ('+error+')' : ''}`;
    });

    // assign loaded srcs and mark failed
    const cards = document.querySelectorAll('.image-card');
    cards.forEach((card, idx) => {
      const img = card.querySelector('.image-preview');
      const url = img.getAttribute('data-src') || '';
      const res = results[idx] || { ok:false };
      if(res.ok) img.src = url;
      else img.src = ''; // leave placeholder
    });

    // hide progress for subsequent pages
    document.getElementById('loadingProgressWrap').style.display = 'none';
    updateStats();
    renderPagination();

    // if initial page (first load) then hide main loading screen now
    if(document.getElementById('mainContainer').style.display === 'none'){
      hideLoadingScreenAndShowMain();
    }
  }

  function renderPagination(){
    const total = allItems.length;
    const pages = Math.max(1, Math.ceil(total / PAGE_SIZE));
    const container = document.getElementById('pagination');
    container.innerHTML = '';
    const prev = document.createElement('button'); prev.className='page-btn'; prev.textContent='Prev'; prev.disabled = currentPage===1; prev.onclick = ()=>{ if(currentPage>1) renderPage(currentPage-1); };
    container.appendChild(prev);
    for(let p=1;p<=pages;p++){
      const b = document.createElement('button');
      b.className = 'page-btn' + (p===currentPage ? ' active' : '');
      b.textContent = p;
      b.onclick = ()=>{ if(p!==currentPage) renderPage(p); };
      container.appendChild(b);
    }
    const next = document.createElement('button'); next.className='page-btn'; next.textContent='Next'; next.disabled = currentPage===pages; next.onclick = ()=>{ if(currentPage<pages) renderPage(currentPage+1); };
    container.appendChild(next);
  }

  function hideLoadingScreenAndShowMain(){
    document.getElementById('loadingScreen').style.opacity = '0';
    setTimeout(()=>{ document.getElementById('loadingScreen').classList.add('hidden'); document.getElementById('mainContainer').style.display='block'; }, 300);
  }

  // Load all metadata first (so we can paginate) but preload only pages on demand
  async function loadAllMetadataThenShow(){
    try {
      appLog('Fetching all portfolio metadata...','info');
      document.getElementById('loadingTitle').textContent = 'Verifying admin and fetching metadata...';
      const snap = await db.collection('portfolioItems').orderBy('uploadDate','desc').get();
      allItems = [];
      const foundFields = new Set();
      snap.forEach(doc => { const d=doc.data(); allItems.push({ id: doc.id, ...d }); Object.keys(d||{}).forEach(k=>foundFields.add(k)); });
      recordAccess(Array.from(foundFields), 'read portfolioItems (metadata)');
      document.getElementById('totalImages').textContent = allItems.length;
      appLog(`Fetched ${allItems.length} items metadata`,'info');
      // render first page (will preload its images); loading screen hides after first page preloaded
      await renderPage(1, { showProgress: true });
    } catch(e){
      appLog('Failed fetching metadata: '+e.message,'error');
      hideLoadingScreenAndShowMain();
    }
  }

  // Stats and helpers
  function updateStats(){
    document.getElementById('totalImages').textContent = allItems.length;
    const publicCount = allItems.filter(i => i.isPublic).length;
    document.getElementById('publicImages').textContent = publicCount;
    let totMB = 0;
    allItems.forEach(i => { const fs = i.fileSize || 0; totMB += (fs/1024/1024); });
    document.getElementById('storageUsed').textContent = `${totMB.toFixed(2)} MB`;
  }
  function formatFileSize(bytes){ if(!bytes && bytes!==0) return '0 Bytes'; const k=1024; const sizes=['Bytes','KB','MB','GB']; const i = bytes===0?0:Math.floor(Math.log(bytes)/Math.log(k)); return (bytes/Math.pow(k,i)).toFixed(2)+' '+sizes[i]; }
  async function copyToClipboard(text){ try { await navigator.clipboard.writeText(text||''); alert('Copied'); appLog('Copied to clipboard','success'); } catch(e){ appLog('Copy fail: '+e.message,'error'); } }
  function escapeHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

  // Admin check -> metadata load -> first page preload -> show UI
  async function checkAdminAccessAndStart(){
    try {
      const user = await new Promise((resolve,reject)=>{
        const unsubscribe = auth.onAuthStateChanged(async (user)=>{
          if(user){
            try {
              const adminQuery = await db.collection('admin').where('gmail','==',user.email).limit(1).get();
              if(!adminQuery.empty){ unsubscribe(); resolve(user); } else { unsubscribe(); throw new Error('Not an admin'); }
            } catch(err){ unsubscribe(); throw err; }
          } else { unsubscribe(); throw new Error('Not signed in'); }
        });
      });
      document.getElementById('loadingTitle').textContent = 'Admin verified — loading metadata';
      document.getElementById('loadingSub').textContent = `Hello ${user.email}. Loading portfolio...`;
      await updateAuthUI(user);
      await loadAllMetadataThenShow();
    } catch(e){
      console.error('Admin error', e);
      document.getElementById('loadingTitle').textContent = 'Access denied';
      document.getElementById('loadingSub').textContent = 'Redirecting...';
      setTimeout(()=>window.location.href='index.html', 1600);
    }
  }

  // init
  (function init(){ appLog('App init','info'); checkAdminAccessAndStart(); })();
  </script>
</body>
</html>