<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>TeamGalaxy Portfolio Manager — Debug</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"/>
  <style>
    :root{
      --primary-bg: linear-gradient(135deg,#667eea 0%,#764ba2 100%);
      --card-bg: rgba(255,255,255,0.06);
      --glass-border: 1px solid rgba(255,255,255,0.12);
      --hover-glow: 0 0 24px rgba(102,126,234,0.35);
      --panel-bg: #1e1e1e;
      --muted: rgba(255,255,255,0.75);
      --accent: linear-gradient(45deg,#ff6b6b,#4ecdc4);
    }
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%}
    body{
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background:var(--primary-bg); color:#fff; padding:20px; line-height:1.5;
    }
    .container{max-width:1200px;margin:0 auto}
    .header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:20px}
    .title { display:flex; align-items:center; gap:12px; }
    .title h1{ font-size:1.5rem; background:var(--accent); -webkit-background-clip:text; -webkit-text-fill-color:transparent; margin:0 }
    .auth-area{display:flex;gap:8px;align-items:center}
    .auth-btn{background:#2b2b2b;border:0;padding:8px 10px;border-radius:8px;color:#fff;cursor:pointer}
    .auth-badge{background:rgba(255,255,255,0.04);padding:6px 10px;border-radius:12px;font-size:13px}
    .stats{display:flex;gap:12px;margin:14px 0 18px;flex-wrap:wrap}
    .stat-card{background:var(--card-bg);border:var(--glass-border);border-radius:10px;padding:10px 14px;min-width:120px;text-align:center}
    .stat-number{font-weight:700;font-size:1.2rem;background:var(--accent);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    .controls{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .upload-section{background:var(--card-bg);border:var(--glass-border);padding:14px;border-radius:10px;min-width:420px}
    .file-input-wrapper{position:relative;display:inline-block;background:rgba(255,255,255,0.02);padding:12px 18px;border-radius:999px;border:2px dashed rgba(255,255,255,0.06);cursor:pointer}
    .file-input{position:absolute;left:0;top:0;opacity:0;width:100%;height:100%}
    .upload-btn{background:linear-gradient(45deg,#ff6b6b,#4ecdc4);border:0;color:#fff;padding:8px 12px;border-radius:12px;cursor:pointer}
    .preview-container{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .preview-item{width:88px;height:88px;border-radius:8px;overflow:hidden;border:1px solid rgba(255,255,255,0.04);display:flex;align-items:center;justify-content:center;position:relative}
    .preview-item img{width:100%;height:100%;object-fit:cover}
    .gallery{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:16px;margin-top:18px}
    .image-card{background:var(--card-bg);border:var(--glass-border);border-radius:10px;overflow:hidden}
    .image-preview{width:100%;height:160px;object-fit:cover;background:#222}
    .image-info{padding:10px}
    .image-title{font-weight:700}
    .image-meta{font-size:12px;color:rgba(255,255,255,0.7);margin-top:6px}
    .image-actions{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap}
    .action-btn{background:rgba(255,255,255,0.03);border:var(--glass-border);padding:6px 8px;border-radius:8px;color:#fff;cursor:pointer}

    /* Console Panel */
    #console-panel{position:fixed;left:0;right:0;bottom:0;height:240px;background:var(--panel-bg);color:#d4d4d4;font-family:Consolas,monospace;z-index:99999;display:flex;flex-direction:column;border-top:2px solid #262626}
    #console-header{display:flex;align-items:center;gap:8px;padding:8px 10px;background:#222;border-bottom:1px solid #2a2a2a}
    #console-header .title{font-weight:700;color:#fff;margin-right:auto}
    #console-controls{display:flex;gap:8px;align-items:center}
    #console-controls button, #console-controls select{background:#2b2b2b;color:#fff;border:0;padding:6px 8px;border-radius:6px;cursor:pointer}
    #console-body{display:flex;flex:1;gap:12px}
    #console-content{flex:1;padding:10px;overflow-y:auto;border-right:1px solid #2a2a2a;white-space:pre-wrap}
    #console-sidebar{width:280px;padding:10px;background:#181818}
    .log-entry{padding:6px 4px;border-bottom:1px dashed rgba(255,255,255,0.03);font-size:13px}
    .log-ts{color:#9aa7d6;margin-right:6px;font-size:11px}
    .field-list{margin-top:8px;font-size:13px;color:#cfd8ff}
    .small-muted{font-size:12px;color:#9aa}
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="title">
        <h1><i class="fas fa-rocket"></i> TeamGalaxy Portfolio Manager</h1>
      </div>

      <div class="auth-area">
        <div id="authBadge" class="auth-badge">Not signed in</div>
        <button id="btnSignIn" class="auth-btn">Sign in (Google)</button>
        <button id="btnSignOut" class="auth-btn" style="display:none">Sign out</button>
      </div>
    </div>

    <div class="stats">
      <div class="stat-card"><div class="stat-number" id="totalImages">0</div><div class="stat-label">Total Images</div></div>
      <div class="stat-card"><div class="stat-number" id="publicImages">0</div><div class="stat-label">Public</div></div>
      <div class="stat-card"><div class="stat-number" id="storageUsed">0 MB</div><div class="stat-label">Storage</div></div>
    </div>

    <div class="controls">
      <div class="upload-section">
        <div class="file-input-wrapper" title="Click to select images or drag & drop">
          <input type="file" id="imageUpload" class="file-input" accept="image/*" multiple>
          <span><i class="fas fa-cloud-upload-alt"></i> Select images</span>
        </div>
        <button id="uploadBtn" class="upload-btn"><i class="fas fa-upload"></i> Upload to Portfolio</button>
        <div id="previewContainer" class="preview-container"></div>
      </div>

      <div style="display:flex;flex-direction:column;gap:8px;align-items:flex-start">
        <select id="categoryFilter" style="padding:8px;border-radius:8px;background:rgba(0,0,0,0.2);border:var(--glass-border);color:#fff">
          <option value="all">All categories</option>
          <option value="web-design">Web Design</option>
          <option value="ui-ux">UI/UX</option>
          <option value="photography">Photography</option>
          <option value="illustration">Illustration</option>
        </select>
        <div class="small-muted">Uploads go to Cloudflare Worker → Dropbox (server).</div>
      </div>
    </div>

    <div id="loadingIndicator" style="display:none;margin-top:12px"><i class="fas fa-spinner fa-spin"></i> Uploading…</div>

    <div id="portfolioGallery" class="gallery"></div>
  </div>

  <!-- Console Panel -->
  <div id="console-panel" aria-live="polite">
    <div id="console-header">
      <div class="title">Debug Console</div>
      <div id="console-controls">
        <select id="console-level"><option value="all">All</option><option value="log">Log</option><option value="info">Info</option><option value="success">Success</option><option value="warning">Warn</option><option value="error">Error</option></select>
        <button id="clear-console"><i class="fas fa-trash"></i> Clear</button>
        <button id="download-console"><i class="fas fa-download"></i> Export</button>
        <button id="toggle-console">Hide</button>
      </div>
    </div>

    <div id="console-body">
      <div id="console-content"></div>
      <div id="console-sidebar">
        <div style="margin-bottom:8px"><strong>Auth info</strong></div>
        <div class="small-muted">Signed-in Gmail:</div>
        <div id="sidebar-email" style="margin-bottom:8px;color:#dff1ff">—</div>
        <div class="small-muted">User UID:</div>
        <div id="sidebar-uid" style="margin-bottom:12px;color:#dff1ff">—</div>

        <div style="margin-top:8px"><strong>Fields accessed (aggregated)</strong></div>
        <div id="sidebar-fields" class="field-list">—</div>

        <div style="margin-top:12px"><strong>Last attempted fields</strong></div>
        <div id="sidebar-last" style="font-size:13px;color:#cfd8ff">—</div>

        <div style="margin-top:12px" class="small-muted">Shortcuts: Ctrl + ` to toggle panel</div>
      </div>
    </div>
  </div>

  <div style="height:28px"></div>

  <!-- Firebase compat libs v11.9.0 -->
  <script src="https://www.gstatic.com/firebasejs/11.9.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.9.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.9.0/firebase-firestore-compat.js"></script>

  <script>
  /***** Console Panel Core (initialize first) *****/
  (function(){
    if(window.consolePanelInitialized) return;
    window.consolePanelInitialized = true;

    const content = document.getElementById('console-content');
    const clearBtn = document.getElementById('clear-console');
    const toggleBtn = document.getElementById('toggle-console');
    const downloadBtn = document.getElementById('download-console');
    const levelSelect = document.getElementById('console-level');
    const panel = document.getElementById('console-panel');

    let isVisible = true;
    let currentFilter = 'all';
    const logs = [];

    // simple safe escape
    function esc(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

    window.consolePanelLog = function(message, level='log'){
      try {
        const ts = new Date();
        const msg = (typeof message === 'string') ? message : JSON.stringify(message,null,2);
        const entry = { ts: ts.toISOString(), level, message: msg };
        logs.push(entry);

        if (currentFilter !== 'all' && currentFilter !== level) return;
        const div = document.createElement('div');
        div.className = 'log-entry';
        const time = ts.toLocaleTimeString();
        div.innerHTML = `<span class="log-ts">[${time}]</span><strong class="log-level-${level}">${level.toUpperCase()}</strong>: <span style="color:#ddd">${esc(msg)}</span>`;
        content.appendChild(div);
        content.scrollTop = content.scrollHeight;
      } catch (e) { /* ignore UI errors */ }
    };

    // wire native console to panel (but keep originals)
    const orig = {log:console.log, info:console.info, warn:console.warn, error:console.error};
    console.log = function(...a){ orig.log.apply(console,a); window.consolePanelLog(a.join(' '),'log'); };
    console.info = function(...a){ orig.info.apply(console,a); window.consolePanelLog(a.join(' '),'info'); };
    console.warn = function(...a){ orig.warn.apply(console,a); window.consolePanelLog(a.join(' '),'warning'); };
    console.error = function(...a){ orig.error.apply(console,a); window.consolePanelLog(a.join(' '),'error'); };

    clearBtn.onclick = () => { content.innerHTML = ''; logs.length = 0; };
    toggleBtn.onclick = () => { isVisible = !isVisible; panel.style.display = isVisible ? 'flex' : 'none'; toggleBtn.textContent = isVisible ? 'Hide' : 'Show'; };
    downloadBtn.onclick = () => {
      const blob = new Blob([JSON.stringify(logs,null,2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = `console-logs-${new Date().toISOString()}.json`; a.click();
      setTimeout(()=>URL.revokeObjectURL(url),3000);
    };
    levelSelect.onchange = function(){ currentFilter = this.value; content.innerHTML = ''; logs.forEach(e => { if (currentFilter==='all' || e.level===currentFilter) window.consolePanelLog(e.message,e.level); }); };

    // keyboard toggle
    document.addEventListener('keydown', (ev) => { if(ev.ctrlKey && ev.key === '`') toggleBtn.click(); });

  })();
  </script>

  <script>
  /***** App code (uses consolePanelLog safely) *****/

  // Config (same one you provided)
  const CLOUDFLARE_WORKER_URL = 'https://portfolio-dropbox-handler.teamgalaxy-interactive.workers.dev/';
  const firebaseConfig = {
    apiKey: "AIzaSyD0Yv_bQjxi2_kjzPR4XHOlaB7Sb6NRVUc",
    authDomain: "teamgalaxy-77344.firebaseapp.com",
    projectId: "teamgalaxy-77344",
    storageBucket: "teamgalaxy-77344.firebasestorage.app",
    messagingSenderId: "770256225320",
    appId: "1:770256225320:web:5a363ebd757de6cde3a11d",
    measurementId: "G-6C2W9NSNCH"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  // small helper to log into both native console and the panel
  function appLog(msg, level='info'){
    if(level === 'error') console.error(msg);
    else if(level === 'warning') console.warn(msg);
    else if(level === 'success') console.info(msg);
    else console.log(msg);
    if(window.consolePanelLog) window.consolePanelLog(msg, level==='success' ? 'success' : level);
  }

  // Track accessed fields globally
  const accessedFields = new Set();
  let lastAttemptedFields = [];

  function recordAccess(fields, note){
    fields = Array.from(fields || []);
    lastAttemptedFields = fields;
    fields.forEach(f => accessedFields.add(f));
    // update sidebar UI
    const elFields = document.getElementById('sidebar-fields');
    elFields.textContent = Array.from(accessedFields).sort().join(', ') || '—';
    const elLast = document.getElementById('sidebar-last');
    elLast.textContent = (note ? note + ' | ' : '') + (fields.length ? fields.join(', ') : '—');
    appLog(`[FIELDS] ${note || 'access'} → ${fields.join(', ')}`, 'info');
  }

  // Update auth UI
  async function updateAuthUI(user){
    const badge = document.getElementById('authBadge');
    const btnSignOut = document.getElementById('btnSignOut');
    const btnSignIn = document.getElementById('btnSignIn');
    const sidebarEmail = document.getElementById('sidebar-email');
    const sidebarUid = document.getElementById('sidebar-uid');

    if(!user){
      badge.textContent = 'Not signed in';
      sidebarEmail.textContent = '—';
      sidebarUid.textContent = '—';
      btnSignIn.style.display = 'inline-block';
      btnSignOut.style.display = 'none';
      appLog('No user signed in', 'warning');
      return;
    }

    // force refresh token to get up-to-date claims
    let idRes = null;
    try {
      idRes = await user.getIdTokenResult(true);
    } catch (e) {
      appLog('getIdTokenResult failed: ' + e.message, 'error');
    }

    badge.textContent = user.email || user.uid;
    document.getElementById('btnSignIn').style.display = 'none';
    document.getElementById('btnSignOut').style.display = 'inline-block';
    sidebarEmail.textContent = user.email || '—';
    sidebarUid.textContent = user.uid || '—';
    appLog(`Auth state: ${user.email || 'unknown email'} | UID: ${user.uid}`, 'info');
    if(idRes && idRes.claims) appLog(`Token claims: ${JSON.stringify(idRes.claims)}`, 'info');

    // record that we read request.auth.* fields (client tries to use email + uid)
    recordAccess(['ownerUid','u.email','u.uid','idToken.claims'], 'auth check');
  }

  // Sign in/out
  async function signInWithGoogle(){
    const provider = new firebase.auth.GoogleAuthProvider();
    try {
      const result = await auth.signInWithPopup(provider);
      appLog('Signed in as: ' + (result.user && result.user.email), 'success');
      await updateAuthUI(result.user);
    } catch (e) {
      appLog('Sign-in failed: ' + e.message, 'error');
    }
  }
  async function signOut(){
    try {
      await auth.signOut();
      appLog('Signed out', 'info');
      updateAuthUI(null);
    } catch (e) {
      appLog('Sign-out failed: ' + e.message, 'error');
    }
  }

  document.getElementById('btnSignIn').addEventListener('click', signInWithGoogle);
  document.getElementById('btnSignOut').addEventListener('click', signOut);

  // File previews
  document.getElementById('imageUpload').addEventListener('change', handleFileSelect);
  function handleFileSelect(ev){
    const files = ev.target.files || [];
    const preview = document.getElementById('previewContainer');
    preview.innerHTML = '';
    if(files.length === 0){
      document.getElementById('uploadBtn').innerHTML = '<i class="fas fa-upload"></i> Upload to Portfolio';
      return;
    }
    document.getElementById('uploadBtn').innerHTML = `<i class="fas fa-upload"></i> Upload ${files.length} File(s)`;
    appLog(`${files.length} file(s) selected: ${Array.from(files).map(f=>f.name).join(', ')}`, 'info');
    Array.from(files).forEach(file=>{
      if(!file.type.startsWith('image/')) return;
      const r = new FileReader();
      r.onload = (e)=>{
        const d = document.createElement('div');
        d.className = 'preview-item';
        d.innerHTML = `<img src="${e.target.result}" alt="${file.name}"><div style="position:absolute;bottom:0;left:0;right:0;background:rgba(0,0,0,0.6);color:#fff;padding:2px;font-size:10px;text-align:center">${file.name}</div>`;
        preview.appendChild(d);
      };
      r.readAsDataURL(file);
    });
  }

  // Upload flow
  document.getElementById('uploadBtn').addEventListener('click', handleUpload);
  async function handleUpload(){
    const input = document.getElementById('imageUpload');
    const files = input.files || [];
    if(files.length === 0){ alert('Select images first'); return; }

    // ensure user is signed in (if you are relying on ownerUid)
    const user = auth.currentUser;
    if(!user){ if(!confirm('You are not signed in. Continue without ownerUid? (recommended: sign in)')) return; }

    document.getElementById('loadingIndicator').style.display = 'inline-block';
    const arr = Array.from(files);

    // staggered uploads
    const results = await Promise.allSettled(arr.map((file, i)=> new Promise((resolve, reject)=>{
      setTimeout(async ()=>{
        try {
          await uploadToCloudflareWorker(file, user);
          resolve(true);
        } catch (e) {
          reject(e);
        }
      }, i * 700);
    })));

    const failed = results.filter(r=>r.status==='rejected');
    if(failed.length) appLog(`${failed.length} upload(s) failed`, 'error');
    else appLog('All uploads done', 'success');

    document.getElementById('loadingIndicator').style.display = 'none';
    input.value = ''; document.getElementById('previewContainer').innerHTML = '';
  }

  // Upload to worker then add metadata to Firestore (client path)
  async function uploadToCloudflareWorker(file, user){
    const category = document.getElementById('categoryFilter').value || 'uncategorized';
    const form = new FormData();
    form.append('file', file);
    form.append('category', category);
    form.append('title', file.name.replace(/\.[^/.]+$/,'')); 
    form.append('description', `Uploaded ${file.name}`);
    form.append('isPublic', 'false');

    appLog(`Uploading ${file.name} to worker...`, 'info');
    const resp = await fetch(`${CLOUDFLARE_WORKER_URL.replace(/\/$/,'')}/api/upload`, { method:'POST', body: form, mode:'cors' });
    if(!resp.ok){
      const txt = await resp.text();
      throw new Error(`Upload HTTP ${resp.status}: ${txt.substring(0,200)}`);
    }
    const res = await resp.json();
    if(!res.success) throw new Error(res.error || 'Upload failed');

    // Build itemData - note fields we will attempt to write
    const itemData = {
      ownerUid: user ? user.uid : null,
      fileName: res.fileName || file.name,
      originalName: file.name,
      fileSize: res.fileSize || file.size || 0,
      fileType: res.fileType || file.type,
      dropboxUrl: res.dropboxUrl || res.url || '',
      uploadDate: new Date(),
      lastModified: new Date(),
      category,
      title: file.name.replace(/\.[^/.]+$/,''),
      description: `Uploaded ${file.name}`,
      isPublic: false,
      meta: { dimensions: null }
    };

    // Log which fields we are about to write
    recordAccess(Object.keys(itemData), 'create portfolioItems');

    // Add to Firestore (client write)
    try {
      const docRef = await db.collection('portfolioItems').add(itemData);
      appLog(`Saved metadata doc ${docRef.id}`, 'success');
      addToGallery({ id: docRef.id, ...itemData });
      updateStats();
    } catch (e) {
      appLog(`Failed to save metadata: ${e.message}`, 'error');
      throw e;
    }
  }

  // Load items (reads from Firestore; record fields present)
  async function loadPortfolioItems(){
    try {
      appLog('Loading portfolio items...', 'info');
      const snap = await db.collection('portfolioItems').orderBy('uploadDate','desc').get();
      const items = [];
      const foundFields = new Set();
      snap.forEach(doc => {
        const data = doc.data();
        items.push({ id: doc.id, ...data });
        Object.keys(data||{}).forEach(k => foundFields.add(k));
      });
      // record read fields
      recordAccess(Array.from(foundFields), 'read portfolioItems (fields present)');
      const gallery = document.getElementById('portfolioGallery');
      gallery.innerHTML = '';
      items.forEach(it => addToGallery(it));
      updateStats();
      appLog(`Loaded ${items.length} items`, 'info');
    } catch (e) {
      appLog('Load failed: ' + e.message, 'error');
    }
  }

  // Add to gallery
  function addToGallery(item){
    const g = document.getElementById('portfolioGallery');
    const card = document.createElement('div');
    card.className = 'image-card';
    card.dataset.id = item.id;
    card.dataset.category = item.category || 'uncategorized';
    card.innerHTML = `
      <img class="image-preview" src="${escapeHtml(item.dropboxUrl||'')}" alt="${escapeHtml(item.title||item.originalName||'')}">
      <div class="image-info">
        <div class="image-title">${escapeHtml(item.title||item.originalName||'Untitled')}</div>
        <div class="image-meta">Size: ${formatFileSize(item.fileSize||0)} | ${item.meta?.dimensions ? item.meta.dimensions.width + '×' + item.meta.dimensions.height : 'Unknown dims'}</div>
        <div class="image-actions">
          <button class="action-btn" onclick="copyToClipboard('${item.dropboxUrl||''}')"><i class="fas fa-copy"></i> Copy URL</button>
          <button class="action-btn" onclick="togglePublicStatus('${item.id}', ${item.isPublic ? 'true' : 'false'})"><i class="fas fa-eye"></i> Toggle Public</button>
          <button class="action-btn" onclick="deleteItem('${item.id}')"><i class="fas fa-trash"></i> Delete</button>
        </div>
      </div>
    `;
    g.appendChild(card);

    // load natural dims
    const img = card.querySelector('.image-preview');
    img.addEventListener('load', async ()=>{
      try {
        const w = img.naturalWidth, h = img.naturalHeight;
        if(!item.meta || !item.meta.dimensions){
          // record attempted update fields
          recordAccess(['meta.dimensions','lastModified'], 'update dimensions after image load');
          // try to update DB (best-effort)
          try { await db.collection('portfolioItems').doc(item.id).update({ 'meta.dimensions': { width: w, height: h }, lastModified: new Date() }); appLog(`Updated dimensions for ${item.id}`, 'info'); }
          catch(e){ appLog('Failed to update dims: ' + e.message, 'warning'); }
        }
      } catch(e){}
    });
    img.addEventListener('error', ()=>{ img.src = ''; });
  }

  // Toggle public (attempts update)
  async function togglePublicStatus(itemId, currentState){
    const newState = !currentState;
    // record attempted fields
    recordAccess(['isPublic','lastModified'], `update portfolioItems/${itemId}`);
    try {
      await db.collection('portfolioItems').doc(itemId).update({ isPublic: newState, lastModified: new Date() });
      appLog(`Toggled isPublic:${newState} for ${itemId}`, 'success');
      // update UI quickly
      loadPortfolioItems();
    } catch (e) {
      appLog('Toggle failed: ' + e.message, 'error');
    }
  }

  // Delete
  async function deleteItem(itemId){
    if(!confirm('Delete this item?')) return;
    // attempted fields: deletion
    recordAccess(['__delete__'], `delete portfolioItems/${itemId}`);
    try {
      await db.collection('portfolioItems').doc(itemId).delete();
      appLog(`Deleted ${itemId}`, 'success');
      const el = document.querySelector(`[data-id="${itemId}"]`);
      if(el) el.remove();
      updateStats();
    } catch (e) {
      appLog('Delete failed: ' + e.message, 'error');
    }
  }

  // Helpers
  function formatFileSize(bytes){
    if(!bytes && bytes !== 0) return '0 Bytes';
    const k = 1024; const sizes = ['Bytes','KB','MB','GB'];
    const i = bytes === 0 ? 0 : Math.floor(Math.log(bytes)/Math.log(k));
    return (bytes/Math.pow(k,i)).toFixed(2) + ' ' + sizes[i];
  }
  async function copyToClipboard(text){
    try { await navigator.clipboard.writeText(text||''); alert('Copied'); appLog('Copied to clipboard', 'success'); } catch(e){ appLog('Copy fail: '+e.message, 'error'); }
  }
  function escapeHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

  // Update stats
  function updateStats(){
    const cards = document.querySelectorAll('.image-card');
    document.getElementById('totalImages').textContent = cards.length;
    document.getElementById('publicImages').textContent = Array.from(cards).filter(c => {
      const btn = c.querySelector('.image-actions button'); // not reliable for public, so keep as is
      return false;
    }).length;
    // storage naive: sum fileSize in displayed meta text
    let totMB = 0;
    cards.forEach(c => {
      const meta = c.querySelector('.image-meta')?.textContent || '';
      const m = meta.match(/Size:\s*([\d.]+)\s*(MB|KB|GB|Bytes)/i);
      if(m){
        const num = parseFloat(m[1]); const unit = m[2].toUpperCase();
        if(unit === 'MB') totMB += num;
        else if(unit === 'KB') totMB += num/1024;
        else if(unit === 'GB') totMB += num*1024;
        else if(unit === 'BYTES') totMB += num/(1024*1024);
      }
    });
    document.getElementById('storageUsed').textContent = `${totMB.toFixed(2)} MB`;
  }

  // Auth state observer
  auth.onAuthStateChanged(async (u) => {
    await updateAuthUI(u);
    // after auth change, reload items (to check read permissions)
    try { await loadPortfolioItems(); }
    catch(e){ appLog('loadPortfolioItems failed after auth change: ' + e.message, 'warning'); }
  });

  // Initial load
  (function init(){ appLog('App init', 'info'); loadPortfolioItems().catch(()=>{}); })();

  </script>
</body>
</html>
