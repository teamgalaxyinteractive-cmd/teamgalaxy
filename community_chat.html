<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>TeamGalaxy â€” Chat (bg + corrected footer)</title>

  <!-- fontawesome (kept for potential future use) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"/>

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore-compat.js"></script>

  <style>
    :root{
      --bg-image: url('https://dl.dropboxusercontent.com/scl/fi/7vp6uxrkls3o0e4325kir/IMG_20251105_161000.png?rlkey=uh7nftac6l80vtlvqjnm6kwfq&st=qvii34oe&dl=0');
      --bg-overlay: rgba(10,8,24,0.45);
      --accent-1: #8a7cff;
      --accent-2: #d66efd;
    }

    html,body { height:100%; }
    *,*::before,*::after { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      overflow-x: hidden;
      font-family: 'Segoe UI', system-ui, Roboto, Arial, sans-serif;
      color: #e0e0ff;
      background: linear-gradient(135deg,#0f0c29,#302b63,#24243e);
    }

    body::before {
      content: "";
      position: fixed;
      inset: 0;
      z-index: -2;
      background-image: var(--bg-image);
      background-size: cover;
      background-position: center center;
      background-repeat: no-repeat;
      filter: none;
    }
    body::after {
      content: "";
      position: fixed;
      inset: 0;
      z-index: -1;
      background: var(--bg-overlay);
      pointer-events: none;
    }

    .site-header, .site-footer {
      width: 100%;
      left: 0;
      right: 0;
      box-sizing: border-box;
      background: rgba(10,10,35,0.95);
      z-index: 40;
    }

    .site-header .container-inner,
    .site-footer .container-inner {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0.85rem 1rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
      box-sizing: border-box;
    }

    .logo { font-weight:700; background: linear-gradient(45deg,var(--accent-1),var(--accent-2)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; font-size:1.35rem; }
    .profile-photo { width:44px; height:44px; border-radius:50%; overflow:hidden; border:2px solid var(--accent-1); display:flex; align-items:center; justify-content:center; background: linear-gradient(45deg,#6a5af9,#d66efd); color:#fff; font-weight:700; }

    .app-wrap { width:100%; display:flex; justify-content:center; flex:1 0 auto; }
    .container {
      width:100%;
      max-width:1200px;
      padding: 1rem;
      display:flex;
      flex-direction:column;
      gap:1rem;
      box-sizing:border-box;
      flex: 1 0 auto;
    }

    .chat-container {
      display:flex;
      flex-direction:column;
      background: rgba(20,20,40,0.56);
      border-radius: 14px;
      border: 1px solid rgba(90,79,207,0.12);
      overflow: hidden;
      box-shadow: 0 15px 35px rgba(0,0,0,0.35);
      width:100%;
      min-height:480px;
      backdrop-filter: blur(6px);
    }

    .messages-area {
      flex:1;
      padding:1.25rem;
      overflow-y:auto;
      display:flex;
      flex-direction:column;
      gap:1rem;
      align-items: stretch;
      scroll-behavior:smooth;
      width:100%;
    }

    .message-card {
      background: rgba(30,30,50,0.64);
      padding:1rem;
      border-radius:12px;
      border:1px solid rgba(68,70,111,0.12);
      display:flex;
      flex-direction:column;
      gap:0.5rem;
      width:100%;
      box-sizing:border-box;
      word-break:break-word;
    }

    .message-header { display:flex; align-items:center; gap:0.75rem; }
    .avatar { width:40px; height:40px; border-radius:50%; flex-shrink:0; display:flex; align-items:center; justify-content:center; background:linear-gradient(45deg,#6a5af9,#d66efd); color:#fff; font-weight:700; border:2px solid rgba(138,124,255,0.25); overflow:hidden; }
    .avatar img{ width:100%; height:100%; object-fit:cover; display:block; }
    .user-info { display:flex; flex-direction:column; min-width:0; }
    .username { font-weight:600; color:var(--accent-1); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .timestamp { font-size:.8rem; color:#a0a0d0; white-space:nowrap; }

    .reply-preview { background:rgba(255,255,255,0.03); padding:.5rem; border-left:3px solid rgba(138,124,255,0.4); border-radius:6px; font-size:.95rem; color:#cbd6ff; }
    .message-content { white-space:pre-wrap; color:#e7e7ff; }

    .message-actions { display:flex; gap:.5rem; align-items:center; margin-top:.4rem; }
    .btn-ghost { background:transparent; border:1px solid rgba(255,255,255,0.03); color:#cfe6ff; padding:.35rem .6rem; border-radius:8px; cursor:pointer; }
    .btn-ghost:hover { border-color:var(--accent-1); color:#fff; }
    .heart-btn { display:inline-flex; align-items:center; gap:.35rem; }
    .heart-count { font-weight:700; color:#ff7b9b; }

    .typing-indicator { padding:.45rem 0; color:#a8caff; min-height:20px; }
    .reply-container { padding:0 0.75rem; }
    .reply-preview { display:block; background:rgba(255,255,255,0.03); padding:.6rem; border-left:3px solid rgba(138,124,255,0.6); border-radius:6px; color:#cbe3ff; }

    .input-area { padding:1rem; display:flex; gap:.6rem; border-top:1px solid rgba(90,79,207,0.08); align-items:flex-end; background:transparent; }
    .message-input { flex:1; padding:.9rem; border-radius:10px; border:1px solid rgba(68,70,111,0.12); background: rgba(12,12,24,0.28); color:#eef; font-size:1rem; outline:none; }
    .message-input:focus { border-color:var(--accent-1); box-shadow:0 0 10px rgba(138,124,255,0.12); }
    .send-button { padding:.9rem 1.2rem; border-radius:10px; border:none; background:linear-gradient(45deg,#6a5af9,#d66efd); color:white; font-weight:700; cursor:pointer; }
    .send-button:disabled { opacity:.5; cursor:not-allowed; }

    .site-footer { }
    .site-footer .container-inner { padding: 0; }
    .footer-content {
      width:100%;
      display:flex;
      gap:1.5rem;
      align-items:start;
      box-sizing:border-box;
      padding: .9rem 1rem;
    }
    .footer-left, .footer-right {
      flex: 1 1 50%;
      min-width: 0;
      box-sizing: border-box;
    }
    .footer-left { padding-right: .5rem; }
    .footer-right { padding-left: .5rem; display:flex; flex-direction:column; gap:.75rem; }

    .footer-about-title { font-size:1.05rem; color:var(--accent-1); margin-bottom:.6rem; font-weight:600; }
    .footer-about-text { color:#a0a0d0; line-height:1.6; font-size:.9rem; }
    .footer-links { display:flex; flex-direction:column; gap:.6rem; }
    .footer-links a { color:#a0a0d0; text-decoration:none; transition:color .15s; }
    .footer-links a:hover { color:var(--accent-1); text-decoration:underline; }

    .rocket-frame { margin-top: .5rem; padding: .8rem; border:2px solid #5a4fcf; border-radius:12px; background:rgba(20,20,40,0.35); overflow:hidden; max-width:420px; width:100%; box-sizing:border-box; }
    .rocket-text { font-size: clamp(1.05rem, 3vw, 1.4rem); font-weight:bold; background:linear-gradient(45deg,var(--accent-1),var(--accent-2),var(--accent-1)); background-size:200% auto; -webkit-background-clip:text; -webkit-text-fill-color:transparent; animation: shimmer 3s linear infinite; text-align:center; line-height:1.2; }
    @keyframes shimmer { 0% { background-position: -200% center; } 100% { background-position: 200% center; } }

    @media (max-width:768px){
      .footer-content { flex-direction: column; padding:.75rem; gap: .75rem; }
      .footer-left, .footer-right { flex: none; width:100%; padding: 0; }
      .container { padding: .75rem; }
      .site-header .container-inner, .site-footer .container-inner { padding: .75rem .9rem; }
    }

    /* Loading overlay */
    #loadingOverlay {
      position: fixed;
      inset: 0;
      z-index: 9999;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(180deg, rgba(4,10,20,0.85), rgba(8,12,25,0.85));
      backdrop-filter: blur(6px);
      color: #dbeeff;
      flex-direction: column;
      gap: 12px;
      padding: 24px;
    }
    #loadingOverlay .overlay-card {
      display: flex;
      flex-direction: column;
      gap: 12px;
      align-items: center;
      max-width: 720px;
      text-align: center;
    }
    #loadingOverlay .overlay-title { font-size: 1.4rem; font-weight:700; color:#fff; }
    #loadingOverlay .overlay-sub { font-size: 1rem; color:#cfeaff; opacity:0.95; }
    .dots { display:inline-flex; gap:8px; align-items:center; padding-top:4px; }
    .dot { width:10px; height:10px; border-radius:50%; background:linear-gradient(90deg,#64c2ff,#8a7cff); box-shadow: 0 0 8px rgba(100,194,255,0.18); transform: translateY(0); animation: dotUp 1.1s infinite ease-in-out; opacity:0.95; }
    .dot.d2 { animation-delay: 0.15s; } .dot.d3 { animation-delay:0.3s; }
    @keyframes dotUp { 0%{transform:translateY(0);opacity:0.5;}40%{transform:translateY(-8px);opacity:1;}100%{transform:translateY(0);opacity:0.5;} }
    #loadingOverlay.hidden { display:none !important; }
  </style>
</head>
<body>
  <!-- Loading overlay -->
  <div id="loadingOverlay" class="hidden" role="status" aria-live="polite">
    <div class="overlay-card">
      <div class="overlay-title">Connecting to the cosmic chatâ€¦</div>
      <div class="overlay-sub">Fetching live messages and preparing the community space â€” this helps keep the feed fresh and safe.</div>
      <div class="dots" aria-hidden="true">
        <span class="dot d1"></span>
        <span class="dot d2"></span>
        <span class="dot d3"></span>
      </div>
      <div style="font-size:.9rem;color:rgba(200,220,255,0.75);max-width:640px">
        Tip: if loading takes longer than a few seconds check your connection or try refreshing. Messages are synced in real time.
      </div>
    </div>
  </div>

  <header class="site-header" role="banner">
    <div class="container-inner">
      <div class="logo">GalaxyWeb</div>
      <div class="profile-photo" id="header-avatar">U</div>
    </div>
  </header>

  <div class="app-wrap">
    <div class="container">
      <main class="chat-container" role="main">
        <div id="messages-area" class="messages-area">
          <div style="text-align:center;color:#a0a0d0;padding:2rem;">Loading chat...</div>
        </div>

        <div id="typing-indicator" class="typing-indicator"></div>

        <div id="reply-preview-wrap" class="reply-container" style="display:none">
          <div class="reply-preview" id="reply-preview"></div>
        </div>

        <div class="input-area">
          <input id="message-input" class="message-input" placeholder="Write your message..." maxlength="1000" autocomplete="off" />
          <button id="send-button" class="send-button" disabled>Send</button>
        </div>
      </main>
    </div>
  </div>

  <!-- Footer: social & address removed completely -->
  <footer class="site-footer" role="contentinfo" aria-label="Site footer">
    <div class="container-inner">
      <div class="footer-content">
        <!-- Left: About only -->
        <div class="footer-left">
          <div>
            <div class="footer-about-title">About TeamGalaxy</div>
            <div class="footer-about-text">
              TeamGalaxy is an innovative gaming and creative community, united by passion and the spirit of collaboration. We host tournaments, share design ideas, and grow talents together â€” join now to explore the Galaxy!
            </div>
          </div>
        </div>

        <!-- Right: only links + rocket -->
        <div class="footer-right">
          <div class="footer-links">
            <a href="#">Privacy Policy</a>
            <a href="#">Terms & Conditions</a>
            <a href="#">About</a>
          </div>

          <div class="rocket-frame" aria-hidden="true" style="margin-top:12px;">
            <div class="rocket-text">ðŸš€ ROCKET ðŸš€</div>
          </div>
        </div>
      </div>
    </div>
  </footer>

  <script>
    // FIREBASE CONFIG (unchanged)
    const firebaseConfig = {
      apiKey: "AIzaSyD0Yv_bQjxi2_kjzPR4XHOlaB7Sb6NRVUc",
      authDomain: "teamgalaxy-77344.firebaseapp.com",
      projectId: "teamgalaxy-77344",
      storageBucket: "teamgalaxy-77344.firebasestorage.app",
      messagingSenderId: "770256225320",
      appId: "1:770256225320:web:5a363ebd757de6cde3a11d",
      measurementId: "G-6C2W9NSNCH"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // DOM refs
    const messagesArea = document.getElementById('messages-area');
    const messageInput = document.getElementById('message-input');
    const sendButton = document.getElementById('send-button');
    const headerAvatar = document.getElementById('header-avatar');
    const typingIndicator = document.getElementById('typing-indicator');
    const replyPreviewWrap = document.getElementById('reply-preview-wrap');
    const replyPreview = document.getElementById('reply-preview');
    const loadingOverlay = document.getElementById('loadingOverlay');

    function showLoadingOverlay(title, sub) {
      if (title) {
        const t = loadingOverlay.querySelector('.overlay-title');
        if (t) t.textContent = title;
      }
      if (sub) {
        const s = loadingOverlay.querySelector('.overlay-sub');
        if (s) s.textContent = sub;
      }
      loadingOverlay.classList.remove('hidden');
    }
    function hideLoadingOverlay() {
      loadingOverlay.classList.add('hidden');
    }

    // show overlay initially
    showLoadingOverlay('Connecting to the chatâ€¦', 'Syncing messages and preparing the community feed');

    // State and functions (kept the same as before)
    let unsubscribeMessages = null;
    let unsubscribeTyping = null;
    let currentProfile = null;
    let typingTimeout = null;
    let localTyping = false;
    let replyTo = null;
    let userHeartsSet = new Set();
    const MAX_SNIPPET = 120;
    let latestSnapshotDocs = {};

    function escapeHtml(s=''){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,"&#039;"); }
    function formatTime(ts){ if(!ts) return 'Just now'; try{ const d = ts.toDate?ts.toDate():new Date(ts); return d.toLocaleString('en-IN',{hour:'2-digit',minute:'2-digit',day:'2-digit',month:'short'}); }catch(e){return 'Just now'} }
    function snippet(s,n=MAX_SNIPPET){ if(!s) return ''; return s.length>n? s.slice(0,n)+'â€¦': s; }

    function buildMessageElement(data, id){
      const card = document.createElement('div'); card.className = 'message-card'; card.dataset.docId = id;
      const header = document.createElement('div'); header.className = 'message-header';
      const avatarWrap = document.createElement('div'); avatarWrap.className = 'avatar';
      const initials = (data.authorName || 'U').charAt(0).toUpperCase();
      if(data.authorPhotoUrl){
        const img = document.createElement('img'); img.src = data.authorPhotoUrl; img.alt = (data.authorName || 'Avatar').slice(0,20);
        img.onerror = ()=>{ if(img.parentElement) img.parentElement.removeChild(img); avatarWrap.textContent = initials; };
        avatarWrap.appendChild(img);
      } else { avatarWrap.textContent = initials; }
      const userInfo = document.createElement('div'); userInfo.className = 'user-info';
      const uname = document.createElement('div'); uname.className = 'username'; uname.innerHTML = escapeHtml(data.authorName || 'Anonymous');
      const ts = document.createElement('div'); ts.className = 'timestamp'; ts.textContent = formatTime(data.timestamp);
      userInfo.appendChild(uname); userInfo.appendChild(ts);
      header.appendChild(avatarWrap); header.appendChild(userInfo);

      if(data.replyToAuthorName || data.replyToSnippet){
        const rp = document.createElement('div'); rp.className = 'reply-preview'; rp.style.fontSize = '.9rem';
        rp.innerHTML = `<strong style="color:#cbe3ff">${escapeHtml(data.replyToAuthorName || '')}</strong>: ${escapeHtml((data.replyToSnippet || '').slice(0,MAX_SNIPPET))}`;
        card.appendChild(header); card.appendChild(rp);
      } else {
        card.appendChild(header);
      }

      const content = document.createElement('div'); content.className = 'message-content'; content.innerHTML = escapeHtml(data.text || '');
      card.appendChild(content);

      const actions = document.createElement('div'); actions.className = 'message-actions';
      const replyBtn = document.createElement('button'); replyBtn.className = 'btn-ghost'; replyBtn.type = 'button'; replyBtn.textContent = 'Reply';
      replyBtn.addEventListener('click', ()=> setReplyTo({ id, authorName: data.authorName || 'Anonymous', snippet: snippet(data.text || '') }));
      const heartBtn = document.createElement('button'); heartBtn.className = 'btn-ghost heart-btn'; heartBtn.type = 'button';
      const heartIcon = document.createElement('span'); heartIcon.innerHTML = userHeartsSet.has(id) ? 'â¤ï¸' : 'ðŸ¤';
      const heartCount = document.createElement('span'); heartCount.className = 'heart-count'; heartCount.textContent = (data.heartsCount || 0);
      heartBtn.appendChild(heartIcon); heartBtn.appendChild(heartCount);
      heartBtn.addEventListener('click', async ()=> toggleHeart(id));
      actions.appendChild(replyBtn); actions.appendChild(heartBtn);
      card.appendChild(actions);
      return card;
    }

    function renderMessagesFromSnapshot(snapshot){
      latestSnapshotDocs = {};
      snapshot.docs.forEach(d => latestSnapshotDocs[d.id] = d.data());
      messagesArea.innerHTML = '';
      if(!snapshot.docs.length){
        messagesArea.innerHTML = '<div style="text-align:center;color:#a0a0d0;padding:2rem;">No messages yet. Say hi ðŸ‘‹</div>';
        hideLoadingOverlay();
        return;
      }
      snapshot.docs.forEach(d => {
        const el = buildMessageElement(d.data(), d.id);
        messagesArea.appendChild(el);
      });
      messagesArea.scrollTop = messagesArea.scrollHeight;
      hideLoadingOverlay();
    }

    async function sendMessage(){
      const text = messageInput.value.trim();
      if(!text) return;
      sendButton.disabled = true;
      try{
        const user = auth.currentUser; if(!user) throw new Error('Not signed in');
        const privateDoc = await db.collection('usersPrivate').doc(user.uid).get();
        if(!privateDoc.exists) throw new Error('Not set up');
        const p = privateDoc.data(); const slug = p.slug; if(!slug) throw new Error('Slug missing');
        const pub = await db.collection('publicProfiles').doc(slug).get();
        if(!pub.exists) throw new Error('Public profile not found');
        const pd = pub.data();
        const msg = {
          text,
          authorSlug: slug,
          authorName: pd.name || user.displayName || 'Anonymous',
          authorPhotoUrl: pd.profilePhotoUrl || '',
          timestamp: firebase.firestore.FieldValue.serverTimestamp(),
          visibility: true,
          likes: 0,
          heartsCount: 0
        };
        if(replyTo && replyTo.id){
          msg.replyToId = replyTo.id;
          msg.replyToAuthorName = replyTo.authorName || (latestSnapshotDocs[replyTo.id] && latestSnapshotDocs[replyTo.id].authorName) || 'Unknown';
          msg.replyToSnippet = replyTo.snippet || (latestSnapshotDocs[replyTo.id] && snippet(latestSnapshotDocs[replyTo.id].text || '')) || '';
        }
        await db.collection('communityMessages').add(msg);
        messageInput.value = '';
        clearReply();
        stopTyping();
      }catch(err){
        console.error('send error',err);
        alert('Send failed: ' + (err.message || 'unknown'));
      }finally{
        sendButton.disabled = false;
      }
    }

    async function toggleHeart(messageId){
      const user = auth.currentUser;
      if(!user){ alert('Sign in to heart'); return; }
      const uid = user.uid;
      const heartDocId = `${messageId}_${uid}`;
      const heartDocRef = db.collection('messageHearts').doc(heartDocId);
      const msgRef = db.collection('communityMessages').doc(messageId);
      try{
        await db.runTransaction(async tx => {
          const heartSnap = await tx.get(heartDocRef);
          const msgSnap = await tx.get(msgRef);
          if(!msgSnap.exists) throw new Error('Message missing');
          let hearts = msgSnap.data().heartsCount || 0;
          if(!heartSnap.exists){
            tx.set(heartDocRef, { messageId, userId: uid, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
            tx.update(msgRef, { heartsCount: hearts + 1 });
            userHeartsSet.add(messageId);
          } else {
            tx.delete(heartDocRef);
            tx.update(msgRef, { heartsCount: Math.max(0, hearts - 1) });
            userHeartsSet.delete(messageId);
          }
        });
      }catch(err){
        console.error('heart tx err',err);
        alert('Heart action failed');
      }
    }

    function startTypingLocal(){
      if(!currentProfile || !currentProfile.slug) return;
      if(localTyping){ clearTimeout(typingTimeout); typingTimeout = setTimeout(stopTyping,1700); return; }
      localTyping = true;
      db.collection('communityTyping').doc(currentProfile.slug).set({
        typing: true,
        name: currentProfile.name || '',
        photoUrl: currentProfile.photoUrl || '',
        lastSeen: firebase.firestore.FieldValue.serverTimestamp()
      }, { merge: true }).catch(e => console.warn('typing set', e));
      typingTimeout = setTimeout(stopTyping, 1700);
    }
    function stopTyping(){
      if(!currentProfile || !currentProfile.slug) return;
      localTyping = false; clearTimeout(typingTimeout);
      db.collection('communityTyping').doc(currentProfile.slug).set({
        typing: false,
        lastSeen: firebase.firestore.FieldValue.serverTimestamp()
      }, { merge: true }).catch(e => console.warn('typing clear', e));
    }
    function setupTypingListener(){
      if(typeof unsubscribeTyping === 'function') unsubscribeTyping();
      unsubscribeTyping = db.collection('communityTyping').where('typing','==',true).onSnapshot(snap => {
        const typingUsers = [];
        snap.forEach(doc => {
          if(currentProfile && doc.id === currentProfile.slug) return;
          const d = doc.data();
          if(d && d.name) typingUsers.push(d.name);
        });
        if(!typingUsers.length) typingIndicator.textContent = '';
        else if(typingUsers.length === 1) typingIndicator.textContent = `${typingUsers[0]} is typingâ€¦`;
        else if(typingUsers.length === 2) typingIndicator.textContent = `${typingUsers[0]} and ${typingUsers[1]} are typingâ€¦`;
        else typingIndicator.textContent = `${typingUsers[0]} and ${typingUsers.length - 1} others are typingâ€¦`;
      }, err => console.warn('typing listener err', err));
    }

    function setReplyTo(obj){
      replyTo = obj;
      replyPreviewWrap.style.display = 'block';
      replyPreview.innerHTML = `<strong style="color:#cbe3ff">${escapeHtml(obj.authorName||'')}</strong>: ${escapeHtml(obj.snippet||'')} &nbsp; <button class="btn-ghost" id="cancel-reply">Cancel</button>`;
      document.getElementById('cancel-reply').addEventListener('click', clearReply);
      messageInput.focus();
    }
    function clearReply(){ replyTo = null; replyPreviewWrap.style.display = 'none'; replyPreview.innerHTML = ''; }

    function setupRealtimeListener(){
      if(typeof unsubscribeMessages === 'function') unsubscribeMessages();
      messagesArea.innerHTML = '<div style="text-align:center;color:#a0a0d0;padding:2rem">Loading chat...</div>';
      const q = db.collection('communityMessages').where('visibility','==',true).orderBy('timestamp','asc').limit(500);
      unsubscribeMessages = q.onSnapshot(snapshot => {
        renderMessagesFromSnapshot(snapshot);
      }, err => {
        console.error('messages listener err', err);
        messagesArea.innerHTML = `<div style="text-align:center;color:#f88;padding:2rem">Failed to load: ${escapeHtml(err.message || 'unknown')}</div>`;
        hideLoadingOverlay();
      });
    }

    async function loadUserHearts(uid){
      userHeartsSet.clear();
      try{
        const snaps = await db.collection('messageHearts').where('userId','==',uid).get();
        snaps.forEach(d=> userHeartsSet.add(d.data().messageId));
      }catch(e){ console.warn('load hearts err',e); }
    }

    auth.onAuthStateChanged(async (user) => {
      if(!user){
        showLoadingOverlay('Redirecting to sign upâ€¦', 'You need an account to use the community chat');
        setTimeout(()=> window.location.href = '/teamgalaxy/legal/sign_up.html', 900);
        return;
      }
      try{
        const privateDoc = await db.collection('usersPrivate').doc(user.uid).get();
        const initial = (user.displayName || user.email || 'U').charAt(0).toUpperCase();
        if(privateDoc.exists){
          const pd = privateDoc.data();
          if(pd && pd.slug){
            const pub = await db.collection('publicProfiles').doc(pd.slug).get();
            if(pub.exists){
              const pubd = pub.data();
              currentProfile = { slug: pd.slug, name: pubd.name || (user.displayName || 'Anonymous'), photoUrl: pubd.profilePhotoUrl || '' };
              headerAvatar.innerHTML = '';
              if(currentProfile.photoUrl){
                const img = document.createElement('img'); img.src = currentProfile.photoUrl; img.alt = currentProfile.name || 'Profile'; img.style.width='100%'; img.style.height='100%'; img.style.objectFit='cover';
                img.onerror = ()=> headerAvatar.textContent = (currentProfile.name || initial).charAt(0);
                headerAvatar.appendChild(img);
              } else headerAvatar.textContent = (currentProfile.name || initial).charAt(0);
            } else {
              currentProfile = { slug: pd.slug, name: user.displayName || 'Anonymous', photoUrl: user.photoURL || '' };
              headerAvatar.textContent = (user.displayName || initial).charAt(0);
            }
          } else {
            currentProfile = { slug: null, name: user.displayName || 'Anonymous', photoUrl: user.photoURL || '' };
            headerAvatar.textContent = (user.displayName || initial).charAt(0);
          }
        } else {
          currentProfile = { slug: null, name: user.displayName || 'Anonymous', photoUrl: user.photoURL || '' };
          headerAvatar.textContent = (user.displayName || initial).charAt(0);
        }
      }catch(e){
        console.warn('profile fetch err', e);
        currentProfile = { slug:null, name:user.displayName||'Anonymous', photoUrl:user.photoURL||'' };
        headerAvatar.textContent = (user.displayName||'U').charAt(0);
      }

      messageInput.disabled = false;
      sendButton.disabled = false;
      await loadUserHearts(user.uid);
      setupRealtimeListener();
      setupTypingListener();
      hideLoadingOverlay();
    });

    messageInput.addEventListener('input', ()=> startTypingLocal());
    messageInput.addEventListener('keydown', (e)=> { if(e.key === 'Enter' && !e.shiftKey){ e.preventDefault(); sendMessage(); }});
    sendButton.addEventListener('click', ()=> sendMessage());

    window.addEventListener('beforeunload', ()=> {
      try{ if(currentProfile && currentProfile.slug) db.collection('communityTyping').doc(currentProfile.slug).set({ typing:false, lastSeen: firebase.firestore.FieldValue.serverTimestamp() }, { merge:true }); }catch(e){}
      if(typeof unsubscribeMessages === 'function') unsubscribeMessages();
      if(typeof unsubscribeTyping === 'function') unsubscribeTyping();
    });
  </script>
</body>
</html>