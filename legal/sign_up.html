<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Sign Up - TeamGalaxy</title>
  <script src="https://www.gstatic.com/firebasejs/11.9.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.9.0/firebase-app-check-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.9.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.9.0/firebase-firestore-compat.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    * { margin:0; padding:0; box-sizing:border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    html,body { height:100%; }
    body {
      background: linear-gradient(135deg,#0f0c29 0%,#302b63 50%,#24243e 100%);
      color:#e0e0e0;
      display:flex;
      align-items:center;
      justify-content:center;
      min-height:100vh;
      padding:24px;
      position:relative;
      overflow:auto;
    }
    #stars { position:fixed; top:0; left:0; width:100%; height:100%; pointer-events:none; z-index:-1; }
    .star { position:absolute; background-color:white; border-radius:50%; animation: twinkle var(--duration,5s) infinite ease-in-out; }
    @keyframes twinkle { 0%,100%{opacity:0.2} 50%{opacity:1} }
    .container { width:100%; max-width:520px; background:rgba(30,30,46,0.92); border-radius:16px; box-shadow:0 18px 40px rgba(0,0,0,0.5); overflow:hidden; position:relative; z-index:1; margin:20px; }
    .header { background:linear-gradient(135deg,#4a00e0 0%,#8e2de2 100%); padding:28px 20px; text-align:center; color:#fff; }
    .logo { width:90px; height:90px; margin:0 auto 12px; background:rgba(255,255,255,0.06); border-radius:50%; display:flex; align-items:center; justify-content:center; box-shadow:0 6px 18px rgba(0,0,0,0.35); }
    .logo img{ width:70px; height:70px; border-radius:50%; object-fit:cover; }
    .header h1{ font-size:26px; margin-bottom:6px; font-weight:700; letter-spacing:0.4px; }
    .header p{ font-size:14px; opacity:0.95; margin-top:4px; }
    .content{ padding:26px; }
    .card{ background:#2d2d44; border-radius:12px; padding:18px; margin-bottom:16px; box-shadow:0 6px 18px rgba(0,0,0,0.25); }
    .card-title{ font-size:18px; color:#8e44ad; margin-bottom:12px; font-weight:600; }
    .terms-group{ display:flex; align-items:flex-start; margin:18px 0; }
    .terms-group input{ margin-top:3px; margin-right:10px; accent-color:#8e44ad; }
    .terms-group label{ color:#d1d6db; line-height:1.45; font-size:14px; }
    .google-btn{ width:100%; display:flex; align-items:center; justify-content:center; background-color:#2d2d44; color:#e0e0e0; font-size:15px; font-weight:700; padding:12px 18px; border:1px solid #48476a; border-radius:8px; cursor:pointer; }
    .google-btn img{ margin-right:10px; width:20px; height:20px; }
    .google-btn:disabled{ opacity:0.55; cursor:not-allowed; }
    .signed-in-view{ display:none; margin-top:16px; animation:fadeIn .35s ease-in-out; }
    .welcome-card{ background:linear-gradient(to right,#3a1c71,#4a00e0); border:1px solid #6a5acd; border-radius:12px; padding:18px; margin-bottom:18px; }
    .user-info{ display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-top:12px; }
    .info-item{ background:#2d2d44; border-radius:8px; padding:12px; box-shadow:0 2px 8px rgba(0,0,0,0.2); }
    .info-label{ font-size:12px; color:#aeb6bd; margin-bottom:6px; }
    .info-value{ font-size:15px; font-weight:700; color:#8e44ad; }
    .actions{ display:flex; gap:12px; margin-top:18px; flex-wrap:wrap; }
    .btn{ flex:1; min-width:140px; background:#8e44ad; color:white; padding:12px; border:none; border-radius:8px; cursor:pointer; font-size:14px; font-weight:700; display:flex; align-items:center; justify-content:center; }
    .btn-outline{ background:transparent; border:2px solid #8e44ad; color:#8e44ad; }
    footer{ margin-top:12px; text-align:center; font-size:13px; color:#b9c0c8; padding:14px 8px 18px; border-top:1px solid rgba(74,68,112,0.18); }
    footer a{ color:#8e44ad; text-decoration:none; margin:0 8px; font-weight:600; transition:opacity .18s; }
    footer a:hover{ text-decoration:underline; opacity:.95; }
    .success-message{ background:#2d2d44; color:#8e44ad; padding:12px; border-radius:8px; margin-bottom:16px; display:flex; align-items:center; animation:fadeIn .3s; border:1px solid rgba(142,68,173,0.25); }
    @keyframes fadeIn{ from{opacity:0} to{opacity:1} }
    @media (max-width:480px){ .content{ padding:18px } .user-info{ grid-template-columns:1fr } .actions{ flex-direction:column } .btn{ width:100% } }
  </style>
</head>
<body>
  <div id="stars" aria-hidden="true"></div>

  <div class="container" role="main" aria-labelledby="site-title">
    <div class="header">
      <div class="logo" aria-hidden="true">
        <img src="https://dl.dropboxusercontent.com/scl/fi/ywpxewaiksobd3rq8gtak/image-3.png?rlkey=11yfipsfrn7km7wjigqzibemj&st=j03fxxcj&dl=0" alt="TeamGalaxy Logo" />
      </div>
      <h1 id="site-title">TeamGalaxy</h1>
      <p>Exploring the Future, Together!</p>
    </div>

    <div class="content">
      <div class="success-message" id="success-message" style="display:none;">
        <i class="fas fa-check-circle"></i>
        <div style="margin-left:8px;"><strong>Account created successfully!</strong> Welcome to TeamGalaxy.</div>
      </div>

      <div id="signup-form">
        <div class="card">
          <h2 class="card-title">Create Your Account</h2>
          <p style="color:#cbd3db; font-size:14px; margin-bottom:12px;">Join thousands of explorers who are building the future with TeamGalaxy.</p>

          <div class="terms-group">
            <input type="checkbox" id="terms-checkbox" />
            <label for="terms-checkbox">
              I accept the <a href="terms_and_conditions.html" target="_blank" rel="noopener">Terms & Conditions</a> &amp; <a href="privacy_policy.html" target="_blank" rel="noopener">Privacy Policy</a>
            </label>
          </div>

          <button id="googleSignInButton" class="google-btn" disabled>
            <img src="https://img.icons8.com/color/24/google-logo.png" alt="Google Icon" />
            Sign Up with Google
          </button>
        </div>
      </div>

      <div class="signed-in-view" id="signed-in-view" style="display:none;">
        <div class="welcome-card">
          <h2>Welcome to TeamGalaxy, <span id="display-name"></span>!</h2>
          <p style="color:#e6e6ff; font-size:13px;">Your account has been successfully created with TeamGalaxy. You are now part of our mission.</p>

          <div class="user-info">
            <div class="info-item">
              <div class="info-label">Join Date</div>
              <div class="info-value" id="info-join-date">-</div>
            </div>
            <div class="info-item">
              <div class="info-label">Posts</div>
              <div class="info-value" id="info-posts">0</div>
            </div>
          </div>
        </div>

        <div class="actions">
          <button class="btn" id="go-profile-btn"><i class="fas fa-tachometer-alt"></i> Go to Dashboard</button>
          <button class="btn btn-outline" id="switch-account-btn"><i class="fas fa-exchange-alt"></i> Switch Account</button>
          <button class="btn btn-outline" id="signout-btn"><i class="fas fa-sign-out-alt"></i> Sign Out</button>
        </div>
      </div>

      <footer>
        <p>© 2025 TeamGalaxy | <a href="terms_and_conditions.html" target="_blank" rel="noopener">Terms</a> | <a href="privacy_policy.html" target="_blank" rel="noopener">Privacy</a> | <a href="#" rel="noopener">Support</a></p>
      </footer>
    </div>
  </div>

  <script>
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyD0Yv_bQjxi2_kjzPR4XHOlaB7Sb6NRVUc",
      authDomain: "teamgalaxy-77344.firebaseapp.com",
      projectId: "teamgalaxy-77344",
      storageBucket: "teamgalaxy-77344.firebasestorage.app",
      messagingSenderId: "770256225320",
      appId: "1:770256225320:web:5a363ebd757de6cde3a11d",
      measurementId: "G-6C2W9NSNCH"
    };

    if (!window.firebase) {
      console.error('Firebase SDK not found.');
    } else {
      if (!firebase.apps || !firebase.apps.length) firebase.initializeApp(firebaseConfig);
      else console.debug('Firebase already initialized.');
    }

    try { firebase.appCheck().activate('6Ld395IrAAAAAIvG4gyf0vUJeI_jKOsI9XVn0jUx', true); } catch(e){ console.debug('AppCheck init', e); }

    const auth = firebase.auth();
    const db = firebase.firestore();
    const provider = new firebase.auth.GoogleAuthProvider();

    // DOM
    const termsCheckbox = document.getElementById('terms-checkbox');
    const googleSignInBtn = document.getElementById('googleSignInButton');
    const signedInView = document.getElementById('signed-in-view');
    const signupForm = document.getElementById('signup-form');
    const displayNameEl = document.getElementById('display-name');
    const successMessage = document.getElementById('success-message');
    const signoutBtn = document.getElementById('signout-btn');
    const switchAccountBtn = document.getElementById('switch-account-btn');
    const goProfileBtn = document.getElementById('go-profile-btn');
    const infoJoinDate = document.getElementById('info-join-date');
    const infoPosts = document.getElementById('info-posts');

    // No UI console (no-op)
    function logToConsole() { /* intentionally empty */ }

    termsCheckbox.addEventListener('change', () => {
      googleSignInBtn.disabled = !termsCheckbox.checked;
    });

    function generateRandomId() {
      return Math.random().toString(36).substring(2,12) + Math.random().toString(36).substring(2,12);
    }

    function createStars() {
      const starsContainer = document.getElementById('stars');
      if (!starsContainer) return;
      const starCount = 110;
      for (let i=0;i<starCount;i++){
        const star = document.createElement('div');
        star.className = 'star';
        const size = Math.random()*1.6 + 0.4;
        star.style.width = `${size}px`;
        star.style.height = `${size}px`;
        star.style.left = `${Math.random()*100}%`;
        star.style.top = `${Math.random()*100}%`;
        star.style.setProperty('--duration', `${Math.random()*5 + 3}s`);
        star.style.animationDelay = `${Math.random()*5}s`;
        starsContainer.appendChild(star);
      }
    }

    // Load private data
    async function loadUserData(uid) {
      if (!uid) return;
      try {
        const snap = await db.collection('usersPrivate').doc(uid).get();
        if (!snap.exists) {
          infoJoinDate.textContent = '-';
          infoPosts.textContent = '0';
          return;
        }
        const data = snap.data();
        if (data.joinDate && data.joinDate.toDate) infoJoinDate.textContent = data.joinDate.toDate().toLocaleDateString();
        else if (data.joinDate) infoJoinDate.textContent = new Date(data.joinDate).toLocaleDateString();
        else infoJoinDate.textContent = '-';
        infoPosts.textContent = String((data.publicPostCount != null) ? data.publicPostCount : 0);
      } catch (err) {
        console.debug('loadUserData error', err);
      }
    }

    // Ensure publicProfiles/{uid} exists — no slug, no migration, only create if missing
    async function ensurePublicProfileByUid(uid, userInfo = {}) {
      if (!uid) return;
      try {
        const uidRef = db.collection('publicProfiles').doc(uid);
        const snap = await uidRef.get();
        if (snap.exists) {
          // ensure uid field present
          const existing = snap.data();
          if (!existing.uid) await uidRef.set({ uid }, { merge: true });
          return;
        }
        const now = firebase.firestore.Timestamp.now();
        await uidRef.set({
          displayName: userInfo.displayName || '',
          bio: '',
          joinDate: now,
          profilePhotoUrl: userInfo.photoURL || '',
          publicPostCount: 0,
          followersCount: 0,
          followingCount: 0,
          visibility: false,
          verified: false,
          uid: uid
        });
      } catch (err) {
        console.debug('ensurePublicProfileByUid error', err);
      }
    }

    // Sign-in
    async function signInWithGoogle() {
      if (!termsCheckbox.checked) { alert('Please accept Terms & Conditions and Privacy Policy first.'); return; }
      try {
        const result = await auth.signInWithPopup(provider);
        const user = result.user;
        if (!user) throw new Error('No user returned from sign-in');
        const userPrivateRef = db.collection('usersPrivate').doc(user.uid);
        const now = firebase.firestore.Timestamp.now();

        const userPrivateSnap = await userPrivateRef.get();
        if (!userPrivateSnap.exists) {
          // create usersPrivate using "displayName" field (name changed to displayName)
          await userPrivateRef.set({
            email: user.email,
            joinDate: now,
            lastLogin: now,
            displayName: user.displayName || '',
            bio: '',
            profilePhotoUrl: user.photoURL || '',
            publicPostCount: 0,
            followersCount: 0,
            followingCount: 0,
            verified: false,
            termsAccepted: true,
            termsTimestamp: now
          });
          await userPrivateRef.collection('settings').doc('default').set({});
          // create publicProfiles/{uid} directly
          await db.collection('publicProfiles').doc(user.uid).set({
            displayName: user.displayName || '',
            bio: '',
            joinDate: now,
            profilePhotoUrl: user.photoURL || '',
            publicPostCount: 0,
            followersCount: 0,
            followingCount: 0,
            visibility: false,
            verified: false,
            uid: user.uid
          });
          displayNameEl.textContent = user.displayName || 'User';
          infoJoinDate.textContent = new Date().toLocaleDateString();
          infoPosts.textContent = '0';
          successMessage.style.display = 'flex';
        } else {
          await userPrivateRef.update({ lastLogin: now }).catch(()=>{});
          await loadUserData(user.uid);
          displayNameEl.textContent = user.displayName || 'User';
          successMessage.style.display = 'none';
        }

        // ensure publicProfiles/{uid} exists (no slug)
        await ensurePublicProfileByUid(user.uid, { displayName: user.displayName, photoURL: user.photoURL });

        // show UI
        signupForm.style.display = 'none';
        signedInView.style.display = 'block';
      } catch (err) {
        console.error('Sign-in error', err);
        alert('Sign-in failed: ' + (err.message || err));
      }
    }

    googleSignInBtn.addEventListener('click', signInWithGoogle);

    // Signout & switch
    signoutBtn.addEventListener('click', () => {
      auth.signOut().then(() => {
        signedInView.style.display = 'none';
        signupForm.style.display = 'block';
        successMessage.style.display = 'none';
        termsCheckbox.checked = false;
        googleSignInBtn.disabled = true;
        displayNameEl.textContent = '';
        infoJoinDate.textContent = '-';
        infoPosts.textContent = '0';
      }).catch(err => { console.error('Sign-out failed', err); alert('Sign-out failed: ' + err.message); });
    });

    switchAccountBtn.addEventListener('click', () => {
      auth.signOut().then(() => {
        signedInView.style.display = 'none';
        signupForm.style.display = 'block';
        successMessage.style.display = 'none';
        termsCheckbox.checked = false;
        googleSignInBtn.disabled = true;
        displayNameEl.textContent = '';
        infoJoinDate.textContent = '-';
        infoPosts.textContent = '0';
      });
    });

    goProfileBtn.addEventListener('click', () => {
      const user = auth.currentUser;
      if (user) window.open('/teamgalaxy/index.html', '_blank', 'noopener,noreferrer');
      else alert('Please sign in first to access your dashboard.');
    });

    // Auth state
    auth.onAuthStateChanged(async (user) => {
      if (user) {
        signupForm.style.display = 'none';
        signedInView.style.display = 'block';
        displayNameEl.textContent = user.displayName || 'User';
        await loadUserData(user.uid);
        await ensurePublicProfileByUid(user.uid, { displayName: user.displayName, photoURL: user.photoURL });
      } else {
        signupForm.style.display = 'block';
        signedInView.style.display = 'none';
      }
    });

    // small hover effects
    const buttons = document.querySelectorAll('.btn, .google-btn');
    buttons.forEach(b => {
      b.addEventListener('mouseenter', () => { b.style.transform = 'translateY(-2px)'; b.style.boxShadow = '0 8px 20px rgba(0,0,0,0.28)'; });
      b.addEventListener('mouseleave', () => { b.style.transform = 'translateY(0)'; b.style.boxShadow = 'none'; });
    });

    // init
    createStars();
  </script>
</body>
</html>