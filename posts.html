<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TeamGalaxy â€” Posts</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    /* Make box-sizing predictable (prevents padding from causing overflow) */
    html { box-sizing: border-box; }
    *, *::before, *::after { box-sizing: inherit; }

    /* Updated theme based on your detailed color palette */
    :root {
      --bg: #0a0e17;
      --card: rgba(24, 31, 43, 0.95);
      --card-end: rgba(32, 40, 57, 0.95);
      --surface: #161b28;
      --surface-alt: #1c2236;
      --muted: #d0d0d0;
      --text: #ffffff;
      --brand: #8a7cff;
      --accent1: #64c2ff; /* Cyan */
      --accent2: #fab84f; /* Gold */
      --danger: #ff5b5b; /* Red */
      --border: rgba(255, 255, 255, 0.1);
      --hover-bg: rgba(100, 194, 255, 0.1);
      --success: #4caf50;
      --icon-color: #afeafd;
    }

    html, body {
      height: 100%;
    }

    body {
      margin: 0;
      font-family: 'Segoe UI', system-ui, Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
      min-height: 100vh;
      position: relative;
      overflow-x: hidden; /* block horizontal scroll */
      display: flex;
      flex-direction: column;
    }

    /* Stars background */
    body::before {
      content: "";
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-image:
        radial-gradient(2px 2px at 10% 20%, #fff, transparent),
        radial-gradient(1px 1px at 30% 40%, #64c2ff, transparent),
        radial-gradient(1.5px 1.5px at 50% 60%, #fab84f, transparent),
        radial-gradient(1px 1px at 70% 80%, #fff, transparent),
        radial-gradient(2px 2px at 90% 10%, #64c2ff, transparent),
        radial-gradient(1px 1px at 20% 80%, #fab84f, transparent),
        radial-gradient(1.5px 1.5px at 80% 30%, #fff, transparent),
        radial-gradient(1px 1px at 60% 70%, #64c2ff, transparent),
        radial-gradient(2px 2px at 40% 10%, #fab84f, transparent),
        radial-gradient(1px 1px at 95% 50%, #fff, transparent);
      background-repeat: repeat;
      background-size: 100% 100%;
      z-index: -1;
      animation: sparkle 20s linear infinite;
    }

  /* ---------------------------------- */
  /* 1. FONT DEFINITION (@font-face Rule) */
  /* ---------------------------------- */
  @font-face {
      font-family: 'Sefa Regular';
      src: url('assets/fonts/Sefa-Regular.woff2') format('woff2'),
           url('assets/fonts/Sefa-Regular.woff') format('woff');
      font-weight: normal;
      font-style: normal;
      font-display: swap;
  }

    @keyframes sparkle {
      0% { transform: translateY(0); }
      100% { transform: translateY(-100vh); }
    }

    /* Header styling */
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1rem 1.5rem;
      background: rgba(16, 23, 36, 0.85);
      border-bottom: 1px solid var(--border);
      box-shadow: 0 2px 4px rgba(0,0,0,0.3);
      position: relative;
      z-index: 10;
    }

    .brand {
      font-weight: 700;
      font-size: 1.5rem;
      background: linear-gradient(90deg, var(--brand) 0%, var(--accent1) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .container {
      max-width: 900px;
      margin: 2rem auto;
      padding: 0 1.5rem;
      position: relative;
      z-index: 1;
      flex: 1; /* existing styles ke saath */
    }

    /* Create Post button styling */
    .create-post-btn {
      background: var(--accent2);
      color: #000;
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 6px;
      font-weight: 600;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 2px 5px rgba(250, 184, 79, 0.3);
    }

    .create-post-btn:hover {
      background: #e9c46a; /* Slightly darker gold on hover */
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(250, 184, 79, 0.4);
    }

    .card {
      background: linear-gradient(145deg, var(--card) 0%, var(--card-end) 100%);
      border-radius: 8px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      border: 1px solid var(--border);
    }

    .meta {
      color: var(--muted);
      font-size: 0.875rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .title {
      font-size: 1.25rem;
      font-weight: 600;
      margin: 0.75rem 0;
      color: var(--text);
    }

    .snippet {
      color: var(--muted);
      margin-top: 0.5rem;
    }

    .row {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }

    button {
      cursor: pointer;
      border: 0;
      padding: 0.5rem 1rem;
      border-radius: 6px;
      font-weight: 500;
      font-size: 0.875rem;
      transition: all 0.2s ease;
    }

    .btn-primary {
      background: var(--brand);
      color: #fff;
    }

    .btn-primary:hover {
      background: var(--accent1);
      color: #000;
    }

    .btn-ghost {
      background: transparent;
      color: var(--muted);
      border: 1px solid var(--border);
    }

    .btn-ghost:hover {
      background: var(--hover-bg);
      color: var(--accent1);
    }

    .small {
      font-size: 0.875rem;
      color: var(--muted);
    }

    .tags {
      display: flex;
      gap: 0.5rem;
      margin-top: 0.75rem;
      flex-wrap: wrap;
    }

    .tag {
      background: rgba(255, 255, 255, 0.05);
      padding: 0.25rem 0.75rem;
      border-radius: 999px;
      font-size: 0.75rem;
      color: var(--accent2);
    }

    .vote {
      display: inline-flex;
      gap: 0.25rem;
      align-items: center;
    }

    .count {
      font-weight: 600;
      min-width: 1.5rem;
      text-align: center;
    }

    .actions {
      margin-top: 1rem;
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }

    .center {
      display: flex;
      justify-content: center;
      margin: 1.5rem 0;
    }

    .link-like {
      background: transparent;
      color: var(--accent1);
      border: 0;
      cursor: pointer;
      padding: 0.25rem;
    }

    .link-like:hover {
      color: var(--accent2);
    }

    .comment-form-container {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 12px;
      padding: 1rem;
      border: 1px solid rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      margin-top: 1rem;
      box-sizing: border-box;
      width: 100%;
      overflow: hidden;
    }

    .comment-input-section {
      width: 100%;
    }

    .comment-label {
      display: block;
      margin-bottom: 0.5rem;
      color: #aaa;
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .comment-input-wrapper {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      width: 100%;
    }

    #commentInput {
      width: 100%;
      min-height: 80px;
      padding: 0.75rem;
      border-radius: 8px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      background: rgba(0, 0, 0, 0.2);
      color: white;
      font-family: inherit;
      font-size: 1rem;
      resize: vertical;
      transition: all 0.3s ease;
      box-sizing: border-box;
    }

    #commentInput:focus {
      outline: none;
      border-color: #00bcd4;
      box-shadow: 0 0 0 2px rgba(0, 188, 212, 0.2);
      background: rgba(0, 0, 0, 0.3);
    }

    .comment-actions {
      display: flex;
      gap: 0.5rem;
      align-items: center;
      width: 100%;
    }

    .comment-submit-btn {
      background: linear-gradient(45deg, #00bcd4, #0097a7);
      border: none;
      color: white;
      padding: 0.5rem 1rem;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    .comment-submit-btn:hover {
      background: linear-gradient(45deg, #0097a7, #007888);
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(0, 188, 212, 0.3);
    }

    .comment-clear-btn {
      background: transparent;
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: #aaa;
      padding: 0.5rem 1rem;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .comment-clear-btn:hover {
      background: rgba(255, 255, 255, 0.1);
      color: white;
      border-color: rgba(255, 255, 255, 0.3);
    }

    .comment-status {
      font-size: 0.85rem;
      color: #00bcd4;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      background: rgba(0, 188, 212, 0.1);
      min-width: 80px;
      text-align: right;
    }

    .comment {
      padding: 1rem;
      border-radius: 6px;
      background: var(--card);
      margin-bottom: 0.75rem;
      border: 1px solid var(--border);
    }

    .muted {
      color: var(--muted);
    }

    /* Skeleton loading */
    .skeleton {
      background-color: #1a2232;
      background-image: linear-gradient(90deg,
        #1a2232 0px,
        #232e44 40px,
        #1a2232 80px);
      background-size: 300%;
      animation: shine 1.6s infinite linear;
      border-radius: 4px;
    }

    @keyframes shine {
      0% { background-position: 100%; }
      100% { background-position: -100%; }
    }

    .skeleton-text {
      height: 0.875rem;
      margin-bottom: 0.5rem;
    }

    .skeleton-title {
      height: 1.25rem;
      margin: 0.75rem 0;
      width: 70%;
    }

    .skeleton-tag {
      height: 1.5rem;
      width: 4rem;
      border-radius: 999px;
      margin-right: 0.5rem;
      display: inline-block;
    }

    .skeleton-circle {
      width: 2.5rem;
      height: 2.5rem;
      border-radius: 50%;
    }

    /* Loading spinner */
    .spinner {
      width: 1rem;
      height: 1rem;
      border: 2px solid transparent;
      border-top: 2px solid var(--accent1);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      display: inline-block;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Vote loading state */
    .vote-loading {
      opacity: 0.7;
      pointer-events: none;
    }

    .vote-loading .spinner {
      margin-right: 0.25rem;
    }

    /* Post skeleton */
    .post-skeleton {
      padding: 1.5rem;
    }

    .post-skeleton .meta {
      margin-bottom: 1rem;
    }

    /* Comment skeleton */
    .comment-skeleton {
      padding: 1rem;
      margin-bottom: 0.75rem;
    }

    /* User info in header */
    .user-info {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      position: relative;
    }

    .avatar {
      width: 2.5rem;
      height: 2.5rem;
      border-radius: 50%;
      border: 2px solid var(--accent1);
      object-fit: cover;
      cursor: pointer;
      display: inline-block;
    }

    /* small avatar used in feed/cards */
    .avatar.small {
      width: 1.5rem;
      height: 1.5rem;
      border-radius: 50%;
      border: 1px solid var(--accent1);
      object-fit: cover;
      display:inline-block;
      vertical-align: middle;
    }

    /* Dropdown menu */
    .dropdown {
      position: absolute;
      top: 100%;
      right: 0;
      background: rgba(29, 35, 54, 0.95);
      border-radius: 6px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.2);
      z-index: 100;
      min-width: 180px;
      display: none;
    }

    .dropdown.show {
      display: block;
    }

    .dropdown-item {
      display: block;
      padding: 0.75rem 1rem;
      color: #e0e0e0;
      text-decoration: none;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }

    .dropdown-item:hover {
      background: var(--hover-bg);
      color: var(--accent1);
    }

    .dropdown-item:last-child {
      border-bottom: none;
      border-radius: 0 0 6px 6px;
    }

    /* Footer */
    .footer {
      background: rgba(10, 10, 35, 0.95);
      padding: 3rem 2rem 2rem;
      margin-top: auto;
      border-top: 1px solid #5a4fcf;
      box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.3);
      width: 100%;
      flex-shrink: 0;
      box-sizing: border-box; /* ensure padding doesn't add to width */
    }

    .footer-content {
      max-width: 1200px;
      margin: 0 auto;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 3rem;
      width: 100%;
      padding: 0 0.5rem; /* small internal padding to avoid edge touching */
    }

    .footer-about-title {
      font-size: 1.1rem;
      color: #8a7cff;
      margin-bottom: 1rem;
      font-weight: 600;
    }

    .footer-about-text {
      color: #a0a0d0;
      line-height: 1.6;
      font-size: 0.90rem;
    }

    .footer-links {
      display: flex;
      flex-direction: column;
      gap: 0.8rem;
    }

    .footer-links a {
      color: #a0a0d0;
      text-decoration: none;
      font-size: 0.95rem;
      transition: color 0.3s ease;
    }

    .footer-links a:hover {
      color: #8a7cff;
      text-decoration: underline;
    }
    .rocket-frame {
      margin-top: 2rem;
      padding: 1.2rem 1rem; /* Reduced horizontal padding */
      border: 2px solid #5a4fcf;
      border-radius: 12px;
      background: rgba(20, 20, 40, 0.5);
      position: relative;
      overflow: hidden;
      max-width: 420px; /* prevent it from growing past viewport */
      width: 100%;       /* be responsive inside footer column */
      display: inline-block;
    }

    .rocket-text {
      font-size: clamp(1.2rem, 4vw, 1.8rem); /* Responsive font size */
      font-weight: bold;
      color: #8a7cff;
      text-align: center;
      text-shadow: 0 0 15px rgba(138, 124, 255, 0.6);
      background: linear-gradient(45deg, #8a7cff, #d66efd, #8a7cff);
      background-size: 200% auto;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      animation: shimmer 3s linear infinite;
      font-family: 'Arial Rounded MT Bold', 'Segoe UI', sans-serif;
      word-break: break-word; /* Break long words if necessary */
      white-space: normal; /* Allow text to wrap */
      line-height: 1.4; /* Better line height for smaller screens */
    }

    @keyframes shimmer {
      0% { background-position: -200% center; }
      100% { background-position: 200% center; }
    }

    /* Responsive improvements */
    @media (max-width: 768px) {
      .footer-content {
        grid-template-columns: 1fr;
        gap: 2rem;
      }

      .footer {
        padding: 2rem 1.5rem 1.5rem;
      }
    }

    @media (max-width: 480px) {
      .rocket-frame {
        padding: 1rem 0.8rem; /* Further reduce padding on very small screens */
      }
    }

    /* Responsive improvements */
    @media (max-width: 768px) {
      .container {
        padding: 0 1rem;
      }

      .comment-actions {
        flex-wrap: wrap;
      }

      .comment-status {
        margin-left: 0;
        margin-top: 0.5rem;
      }
    }
  </style>
</head>
<body>
  <header>
     <div   
        class="brand"   
        onclick="window.location.href='dashboard.html'"   
        style="  
            cursor: pointer;  font-family: 'Sefa Regular', sans-serif;   
        font-size: 2.5em;   
        font-weight: bold;  
        color: #ccf381; /* Neon color */  
        letter-spacing: 3px;  
    "  
>  
    GalaxyWeb  
</div>  
    <div id="authArea">
      <button id="signInBtn" class="btn-primary">Sign in</button>
    </div>
  </header>

  <div class="container">
    <!-- Create Post button added here -->
    <div style="text-align: center; margin-bottom: 1.5rem;">
      <button class="create-post-btn">Create Post</button>
    </div>

    <div id="feedView" style="display:none">
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <h2 style="margin:0">Latest Posts</h2>
            <div class="small muted">Sorted by publish time â€” newest first</div>
          </div>
          <div><button id="refreshBtn" class="btn-ghost"><i class="fas fa-sync-alt"></i> Refresh</button></div>
        </div>
      </div>

      <div id="postsList"></div>
      <div class="center"><button id="loadMoreBtn" class="btn-ghost">Load more</button></div>
    </div>

    <div id="postView" style="display:none">
      <div style="margin-bottom:1rem;"><button id="backToFeed" class="link-like"><i class="fas fa-arrow-left"></i> Back to feed</button></div>
      <div id="postContainer"></div>

      <div class="card" style="margin-top:1rem">
        <h3 style="margin:0 0 0.5rem 0">Comments</h3>
        <div id="commentsList" style="max-height:420px;overflow:auto;margin-bottom:0.5rem"></div>

          <div id="commentFormWrap" class="comment-form-container">
          <div class="comment-input-section">
            <div class="small muted comment-label">Add a comment</div>
            <div class="comment-input-wrapper">
              <textarea id="commentInput" placeholder="Share your thoughts..."></textarea>
              <div class="comment-actions">
                <button id="submitComment" class="btn-primary comment-submit-btn">Post</button>
                <button id="clearComment" class="btn-ghost comment-clear-btn">Clear</button>
                <div id="commentStatus" class="comment-status" style="margin-left:auto"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Dropdown menu (kept in container but positioned dynamically via JS) -->
    <div id="dropdownMenu" class="dropdown" aria-hidden="true">
      <a href="#" class="dropdown-item" id="profileLink">Profile</a>
      <a href="#" class="dropdown-item" id="settingsLink">Settings</a>
      <a href="#" class="dropdown-item" id="signOutLink">Sign Out</a>
    </div>
  </div>

<!-- FOOTER (intentionally OUTSIDE .container and outside #postView/#feedView) -->
<footer class="footer">
  <div class="footer-content">
    <div class="footer-left">
      <div class="footer-about-title">About TeamGalaxy</div>
      <div class="footer-about-text">
        TeamGalaxy is an innovative gaming and creative community, united by passion and the spirit of collaboration. We host tournaments, share design ideas, and grow talents together â€” join now to explore the Galaxy!
      </div>
    </div>
    <div class="footer-right">
      <div class="footer-links">
        <a href="legal/privacy_policy.html">Privacy Policy</a>
        <a href="legal/terms_and_conditions.html">Terms & Conditions</a>
        <a href="about_us.html">About</a>
      </div>
      <div class="rocket-frame">
        <div class="rocket-text">ðŸš€ ROCKET ðŸš€</div>
      </div>
    </div>
  </div>
</footer>

<script type="module">
/*
  Complete replacement script for your page.
  - Removes skeletons entirely.
  - Adds a full-page loading overlay (with nice text + spinner + subtle animated dots).
  - Adds a realistic starfield animation (batched, non-blocking).
  - Restores profile dropdown behavior; removed "Settings" entry from dropdown (DOM-level removal).
  - Profile dropdown "Profile" navigates to /teamgalaxy/user_management/user_profile.html
  - Keeps all other behavior & styles intact.
*/

/* ---------- CONFIG ---------- */
const firebaseConfig = {
  apiKey: "AIzaSyD0Yv_bQjxi2_kjzPR4XHOlaB7Sb6NRVUc",
  authDomain: "teamgalaxy-77344.firebaseapp.com",
  projectId: "teamgalaxy-77344",
  storageBucket: "teamgalaxy-77344.firebasestorage.app",
  messagingSenderId: "770256225320",
  appId: "1:770256225320:web:5a363ebd757de6cde3a11d",
  measurementId: "G-6C2W9NSNCH"
};
const RECAPTCHA_SITE_KEY = "6Ld395IrAAAAAIvG4gyf0vUJeI_jKOsI9XVn0jUx";

/* ---------- FIREBASE IMPORTS (v11.9.0) ---------- */
import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.9.0/firebase-app.js';
import { initializeAppCheck, ReCaptchaV3Provider } from 'https://www.gstatic.com/firebasejs/11.9.0/firebase-app-check.js';
import {
  getFirestore, collection, query, orderBy, limit, startAfter, getDocs,
  doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot,
  where, serverTimestamp, runTransaction, increment
} from 'https://www.gstatic.com/firebasejs/11.9.0/firebase-firestore.js';
import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/11.9.0/firebase-auth.js';

/* ---------- APP INIT ---------- */
const app = initializeApp(firebaseConfig);
try {
  initializeAppCheck(app, {
    provider: new ReCaptchaV3Provider(RECAPTCHA_SITE_KEY),
    isTokenAutoRefreshEnabled: true
  });
  console.log('App Check initialized');
} catch(e) { console.warn('App Check problem', e); }

const db = getFirestore(app);
const auth = getAuth(app);
const provider = new GoogleAuthProvider();

/* ---------- DOM REFS ---------- */
const postsListEl = document.getElementById('postsList');
const feedView = document.getElementById('feedView');
const postView = document.getElementById('postView');
const postContainer = document.getElementById('postContainer');
const loadMoreBtn = document.getElementById('loadMoreBtn');
const refreshBtn = document.getElementById('refreshBtn');
const backToFeed = document.getElementById('backToFeed');
const signInBtn = document.getElementById('signInBtn');
const authArea = document.getElementById('authArea');
const commentInput = document.getElementById('commentInput');
const submitComment = document.getElementById('submitComment');
const commentsList = document.getElementById('commentsList');
const commentStatus = document.getElementById('commentStatus');
const clearComment = document.getElementById('clearComment');
const createPostBtn = document.querySelector('.create-post-btn');
const dropdownMenu = document.getElementById('dropdownMenu');
const profileLink = document.getElementById('profileLink');
const settingsLink = document.getElementById('settingsLink');
const signOutLink = document.getElementById('signOutLink');

let lastVisible = null;
const PAGE_SIZE = 8;
let currentUser = null;
let currentUserProfile = null;
let currentPostId = null;
let commentsUnsub = null;
let isVoting = false;

/* ---------- UTILS ---------- */
function timeAgo(ts) {
  if (!ts) return '';
  const d = ts.toDate ? ts.toDate() : new Date(ts);
  const diff = Math.floor((Date.now() - d.getTime())/1000);
  if (diff < 60) return diff + 's';
  if (diff < 3600) return Math.floor(diff/60) + 'm';
  if (diff < 86400) return Math.floor(diff/3600) + 'h';
  return Math.floor(diff/86400) + 'd';
}
function snippet(text, n=220){ return (text||'').length>n ? text.slice(0,n)+'â€¦' : (text||''); }
function escapeHTML(s){
  return String(s||'')
    .replaceAll('&','&amp;')
    .replaceAll('<','&lt;')
    .replaceAll('>','&gt;')
    .replaceAll('"','&quot;')
    .replaceAll("'",'&#039;');
}
function getInitials(name) {
  return name ? name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2) : 'U';
}

/* ---------- DYNAMIC CSS FOR OVERLAY + STARS ---------- */
(function injectOverlayAndStarStyles(){
  const css = `
    /* Loading overlay */
    #loadingOverlay {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      background: linear-gradient(180deg, rgba(4,10,20,0.85), rgba(8,12,25,0.85));
      backdrop-filter: blur(6px);
      color: #dbeeff;
      flex-direction: column;
      gap: 12px;
      padding: 24px;
    }
    #loadingOverlay .overlay-card {
      display: flex;
      flex-direction: column;
      gap: 12px;
      align-items: center;
      max-width: 680px;
      text-align: center;
    }
    #loadingOverlay .overlay-title {
      font-size: 1.4rem;
      font-weight: 700;
      letter-spacing: 0.3px;
      color: #ffffff;
      text-shadow: 0 4px 18px rgba(100,194,255,0.06);
    }
    #loadingOverlay .overlay-sub {
      font-size: 0.98rem;
      color: #cfeaff;
      opacity: 0.95;
    }
    /* animated dot loader */
    .dots {
      display: inline-flex;
      gap: 8px;
      align-items: center;
      padding-top: 4px;
    }
    .dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: linear-gradient(90deg,#64c2ff,#8a7cff);
      box-shadow: 0 0 8px rgba(100,194,255,0.18);
      transform: translateY(0);
      animation: dotUp 1.1s infinite ease-in-out;
      opacity: 0.95;
    }
    .dot.d2 { animation-delay: 0.15s; }
    .dot.d3 { animation-delay: 0.3s; }
    @keyframes dotUp {
      0% { transform: translateY(0); opacity: 0.5; }
      40% { transform: translateY(-8px); opacity: 1; }
      100% { transform: translateY(0); opacity: 0.5; }
    }

    /* small caption under overlay */
    #loadingOverlay .overlay-caption {
      margin-top: 6px;
      font-size: 0.85rem;
      color: rgba(190,220,255,0.7);
    }

    /* star layer */
    .js-stars-layer {
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: -1;
      overflow: hidden;
    }
    .js-star {
      position: absolute;
      background: #fff;
      border-radius: 50%;
      box-shadow: 0 0 6px rgba(255,255,255,0.8);
      opacity: 0.85;
      transform: translate3d(0,0,0);
      animation: js-twinkle var(--d,4s) ease-in-out infinite;
      will-change: opacity, transform;
    }
    @keyframes js-twinkle {
      0%,100% { opacity: 0.1; transform: scale(1); }
      50% { opacity: 1; transform: scale(1.2); }
    }
    .js-shooting {
      position: absolute;
      width: 2px;
      height: 2px;
      background: linear-gradient(90deg, rgba(255,255,255,1), rgba(255,255,255,0));
      box-shadow: 0 0 10px rgba(255,255,255,0.9);
      transform-origin: 0 50%;
      opacity: 0;
    }
    @keyframes js-shoot {
      0% { opacity: 0; transform: translateX(0) rotate(var(--angle, -30deg)) scaleX(1); }
      10% { opacity: 1; }
      100% { opacity: 0; transform: translateX(var(--travel, 700px)) rotate(var(--angle, -30deg)) scaleX(1); }
    }

    /* ensure overlay isn't visible by default (we'll control via inline style) */
    #loadingOverlay[hidden] { display: none !important; }
  `;
  const s = document.createElement('style');
  s.appendChild(document.createTextNode(css));
  document.head.appendChild(s);
})();

/* ---------- CREATE LOADING OVERLAY ---------- */
const loadingOverlay = document.createElement('div');
loadingOverlay.id = 'loadingOverlay';
loadingOverlay.setAttribute('aria-hidden','true');
loadingOverlay.innerHTML = `
  <div class="overlay-card" role="status" aria-live="polite">
    <div class="overlay-title">Connecting you to the Galaxy...</div>
    <div class="overlay-sub">Fetching freshest posts and preparing the cosmic feed</div>
    <div class="dots" aria-hidden="true">
      <span class="dot d1"></span>
      <span class="dot d2"></span>
      <span class="dot d3"></span>
    </div>
    <div class="overlay-caption">If this takes longer than a few seconds, check your connection or try refreshing.</div>
  </div>
`;
document.body.appendChild(loadingOverlay);
loadingOverlay.hidden = true; // start hidden; controlled by show/hide functions

function showLoadingOverlay(title, sub) {
  if (title) loadingOverlay.querySelector('.overlay-title').textContent = title;
  if (sub) loadingOverlay.querySelector('.overlay-sub').textContent = sub;
  loadingOverlay.hidden = false;
  loadingOverlay.setAttribute('aria-hidden','false');
}
function hideLoadingOverlay() {
  loadingOverlay.hidden = true;
  loadingOverlay.setAttribute('aria-hidden','true');
}

/* ---------- STARFIELD (batched, non-blocking) ---------- */
(function createStarLayer() {
  const layer = document.createElement('div');
  layer.className = 'js-stars-layer';
  document.body.appendChild(layer);

  const TOTAL = 140;
  const BATCH = 20;
  let created = 0;

  function createStar() {
    const el = document.createElement('div');
    el.className = 'js-star';
    const x = Math.random() * 100;
    const y = Math.random() * 100;
    const size = Math.random() * 1.8 + 0.4;
    const dur = (Math.random() * 6 + 3).toFixed(2);
    const driftX = (Math.random() - 0.5) * 20;
    const driftY = (Math.random() - 0.5) * 10;
    el.style.left = x + '%';
    el.style.top = y + '%';
    el.style.width = size + 'px';
    el.style.height = size + 'px';
    el.style.setProperty('--d', dur + 's');
    el.style.setProperty('--driftX', driftX + 'px');
    el.style.setProperty('--driftY', driftY + 'px');
    // small random animation delay so twinkles don't sync
    el.style.animationDelay = (Math.random() * 6) + 's';
    return el;
  }

  function addBatch() {
    const frag = document.createDocumentFragment();
    for (let i = 0; i < BATCH && created < TOTAL; i++, created++) {
      frag.appendChild(createStar());
    }
    layer.appendChild(frag);
    if (created < TOTAL) setTimeout(addBatch, 40);
  }
  addBatch();

  // occasional shooting stars
  setInterval(() => {
    if (Math.random() < 0.28) {
      const s = document.createElement('div');
      s.className = 'js-shooting';
      const startLeft = Math.random() * 80;
      const startTop = Math.random() * 50;
      const angle = -20 - Math.random() * 40;
      const dur = 0.8 + Math.random() * 0.9;
      const travel = 400 + Math.random() * 900;
      s.style.left = startLeft + '%';
      s.style.top = startTop + '%';
      s.style.setProperty('--angle', angle + 'deg');
      s.style.setProperty('--travel', travel + 'px');
      s.style.animation = `js-shoot ${dur}s linear forwards`;
      s.style.transform = `rotate(${angle}deg)`;
      layer.appendChild(s);
      s.addEventListener('animationend', () => s.remove());
    }
  }, 1100);
})();

/* ---------- TIDYUP: remove settings link from dropdown DOM per request ---------- */
if (settingsLink && settingsLink.parentElement) {
  settingsLink.parentElement.removeChild(settingsLink);
}

/* ---------- AUTH UI & PROFILE DROPDOWN ---------- */
function attachAvatarDropdown(avatarEl) {
  // safe single attachment
  if (avatarEl._dropdownAttached) return;
  avatarEl._dropdownAttached = true;

  avatarEl.addEventListener('click', (e) => {
    e.stopPropagation();
    const willShow = !dropdownMenu.classList.contains('show');
    dropdownMenu.classList.remove('show');

    dropdownMenu.style.position = 'fixed';
    dropdownMenu.style.right = 'auto';

    if (willShow) {
      // compute coords
      const rect = avatarEl.getBoundingClientRect();
      const estimatedWidth = dropdownMenu.offsetWidth || 200;
      let left = Math.round(rect.right - estimatedWidth);
      if (left < 8) left = 8;
      const top = Math.round(rect.bottom + 8);
      dropdownMenu.style.left = left + 'px';
      dropdownMenu.style.top = top + 'px';
      dropdownMenu.classList.add('show');
      dropdownMenu.setAttribute('aria-hidden','false');
    } else {
      dropdownMenu.classList.remove('show');
      dropdownMenu.setAttribute('aria-hidden','true');
    }
  });
}

// Update auth area UI on sign-in/out
onAuthStateChanged(auth, async (user) => {
  currentUser = user;
  if (user) {
    // try to read profile doc
    try {
      const uSnap = await getDoc(doc(db,'users', user.uid));
      if (uSnap.exists()) currentUserProfile = uSnap.data();
      else currentUserProfile = { name: user.displayName || null, email: user.email || null, photoURL: user.photoURL || null };
    } catch(e){
      console.warn('users read failed', e);
      currentUserProfile = { name: user.displayName || null, email: user.email || null, photoURL: user.photoURL || null };
    }

    const avatarSrc = user.photoURL || (`https://via.placeholder.com/80/444444/ffffff?text=${encodeURIComponent(getInitials(currentUserProfile?.name || user.email))}`);
    authArea.innerHTML = `<div class="user-info"><img class="avatar" id="headerAvatar" src="${escapeHTML(avatarSrc)}" alt="Profile"></div>`;

    const avatarEl = document.getElementById('headerAvatar');
    attachAvatarDropdown(avatarEl);

    // ensure profileLink goes to requested URL
    profileLink.addEventListener('click', profileNavHandler);
  } else {
    // signed out
    authArea.innerHTML = `<button id="signInBtn" class="btn-primary">Sign in</button>`;
    document.getElementById('signInBtn').addEventListener('click', signInHandler);
    currentUserProfile = null;
  }

  // Refresh feed or post view on auth change (but show overlay)
  if (currentPostId) {
    showLoadingOverlay('Loading post...');
    renderPostView(currentPostId).finally(()=> hideLoadingOverlay());
  } else {
    showLoadingOverlay('Loading feed...');
    refreshFeed(true).finally(()=> hideLoadingOverlay());
  }
});

// Prevent clicks outside from leaving menu open
document.addEventListener('click', (e) => {
  if (!dropdownMenu.contains(e.target) && !e.target.classList.contains('avatar') && e.target.id !== 'headerAvatar') {
    dropdownMenu.classList.remove('show');
    dropdownMenu.setAttribute('aria-hidden','true');
  }
});

// PROFILE nav handler (navigates to correct path)
function profileNavHandler(e) {
  e && e.preventDefault && e.preventDefault();
  dropdownMenu.classList.remove('show');
  dropdownMenu.setAttribute('aria-hidden','true');
  // direct navigation per user's requested path
  window.location.href = '/teamgalaxy/user_management/user_profile.html';
}

// SETTINGS was removed from DOM; ensure no event attached

// SIGN OUT handler
if (signOutLink) {
  signOutLink.addEventListener('click', (e) => {
    e.preventDefault();
    signOut(auth).catch(err => console.warn('signOut failed', err));
    dropdownMenu.classList.remove('show');
  });
}

/* ---------- SIGN IN (popup) ---------- */
async function signInHandler() {
  try { await signInWithPopup(auth, provider); }
  catch(e){ console.error('Signin error', e); alert('Signin failed'); }
}

/* ---------- FEED: fetch posts (overlay-based) ---------- */
async function refreshFeed(reset=false) {
  if (reset) lastVisible = null;

  // show overlay while loading
  showLoadingOverlay('Loading feed...', 'Gathering posts from across the Galaxy');

  const postsRef = collection(db, 'posts');
  let q;
  if (!lastVisible) q = query(postsRef, orderBy('createdAt','desc'), limit(PAGE_SIZE));
  else q = query(postsRef, orderBy('createdAt','desc'), startAfter(lastVisible), limit(PAGE_SIZE));

  try {
    const snaps = await getDocs(q);
    if (snaps.docs.length === 0) {
      if (!lastVisible) postsListEl.innerHTML = '<div class="card small muted">No posts yet â€” be the first.</div>';
      loadMoreBtn.style.display = 'none';
      return;
    }

    postsListEl.innerHTML = ''; // Replace any previous state (no skeletons)
    for (const d of snaps.docs) {
      renderPostCard(d.id, d.data());
    }
    lastVisible = snaps.docs[snaps.docs.length - 1];
    loadMoreBtn.style.display = snaps.docs.length === PAGE_SIZE ? 'inline-block' : 'none';
  } catch(e){
    console.error('feed fetch error', e);
    postsListEl.innerHTML = '<div class="card small muted">Failed to load posts</div>';
  } finally {
    // hide overlay once finished (even if error)
    hideLoadingOverlay();
  }
}

refreshBtn.addEventListener('click', ()=> {
  lastVisible = null;
  refreshFeed(true);
});
loadMoreBtn.addEventListener('click', ()=> refreshFeed(false));

/* ---------- RENDER POST CARD ---------- */
function avatarHtmlFor(author, data) {
  const photo = (data && (data.photoUrl || data.authorPhotoUrl || data.authorPhoto || data.photoURL || data.authorAvatar)) || null;
  const googleDefault = 'https://www.gstatic.com/images/branding/product/2x/avatar_square_64dp.png';
  if (photo) return `<img class="avatar small" src="${escapeHTML(photo)}" alt="${escapeHTML(author)}">`;
  return `<img class="avatar small" src="${googleDefault}" alt="avatar">`;
}

function renderPostCard(postId, data) {
  const el = document.createElement('div');
  el.className = 'card';
  const author = data.authorName || data.authorEmail || 'Unknown';
  const created = data.createdAt ? timeAgo(data.createdAt) : '';

  const avatarHtml = avatarHtmlFor(author, data);

  el.innerHTML = `
    <div class="meta">
      ${avatarHtml}
      <span style="margin-left:8px">${escapeHTML(author)} Â· <span class="muted">${created}</span></span>
    </div>
    <div class="title">${escapeHTML(data.title || 'Untitled')}</div>
    <div class="snippet">${escapeHTML(snippet(data.body || ''))}</div>
    <div class="tags">${(data.tags || []).map(t => `<span class="tag">${escapeHTML(t)}</span>`).join('')}</div>
    <div class="actions">
      <div class="vote">
        <button class="link-like upvote" data-id="${postId}">â–²</button>
        <div class="count" id="up_${postId}">${data.upvotesCount||0}</div>
        <button class="link-like downvote" data-id="${postId}">â–¼</button>
        <div class="count" id="down_${postId}">${data.downvotesCount||0}</div>
      </div>
      <div style="margin-left:auto">
        <button class="btn-ghost commentBtn" data-id="${postId}"><i class="far fa-comment"></i> Comments (${data.commentsCount||0})</button>
        <button class="btn-primary viewBtn" data-id="${postId}">View Post</button>
      </div>
    </div>
  `;
  postsListEl.appendChild(el);

  el.querySelector('.viewBtn').addEventListener('click', ()=> openPostPage(postId));
  el.querySelector('.commentBtn').addEventListener('click', ()=> openPostPage(postId));
  el.querySelector('.upvote').addEventListener('click', ()=> handleVoteClick(postId, 1));
  el.querySelector('.downvote').addEventListener('click', ()=> handleVoteClick(postId, -1));
}

/* ---------- NAV: single post ---------- */
function openPostPage(postId) {
  const base = window.location.href.split('?')[0];
  window.location.href = base + '?postId=' + postId;
}

/* ---------- VOTING (transactional) ---------- */
async function handleVoteClick(postId, delta) {
  if (isVoting) return;
  if (!currentUser) { alert('Sign in to vote'); return; }

  const uid = currentUser.uid;
  const voteDocRef = doc(db, 'votes', `${postId}_${uid}`);
  const postRef = doc(db, 'posts', postId);

  isVoting = true;
  const voteButtons = document.querySelectorAll(`.upvote[data-id="${postId}"], .downvote[data-id="${postId}"]`);
  voteButtons.forEach(btn => {
    btn.classList.add('vote-loading');
    btn.innerHTML = delta === 1 && btn.classList.contains('upvote') ? '<span class="spinner"></span> â–²' : (delta === -1 && btn.classList.contains('downvote') ? '<span class="spinner"></span> â–¼' : btn.innerHTML);
  });

  try {
    await runTransaction(db, async (tx) => {
      const voteSnap = await tx.get(voteDocRef);
      const postSnap = await tx.get(postRef);
      if (!postSnap.exists()) throw 'Post not found';
      let up = postSnap.data().upvotesCount || 0;
      let down = postSnap.data().downvotesCount || 0;

      if (!voteSnap.exists()) {
        tx.set(voteDocRef, { postId, userId: uid, vote: delta, createdAt: serverTimestamp() });
        if (delta === 1) up++; else down++;
      } else {
        const prev = voteSnap.data().vote || 0;
        if (prev === delta) {
          tx.delete(voteDocRef);
          if (delta === 1) up = Math.max(0, up-1); else down = Math.max(0, down-1);
        } else {
          tx.update(voteDocRef, { vote: delta, updatedAt: serverTimestamp() });
          if (delta === 1) { up++; down = Math.max(0, down-1); }
          else { down++; up = Math.max(0, up-1); }
        }
      }
      tx.update(postRef, { upvotesCount: up, downvotesCount: down });
    });
    if (currentPostId === postId) renderPostView(postId);
    else refreshFeed(true);
  } catch(e) {
    console.error('vote failed', e);
    alert('Vote failed');
  } finally {
    isVoting = false;
    voteButtons.forEach(btn => {
      btn.classList.remove('vote-loading');
      btn.innerHTML = btn.classList.contains('upvote') ? 'â–²' : 'â–¼';
    });
  }
}

/* ---------- POST VIEW (overlay-based) ---------- */
backToFeed.addEventListener('click', ()=> {
  const base = window.location.href.split('?')[0];
  window.location.href = base;
});

async function renderPostView(postId) {
  currentPostId = postId;
  showLoadingOverlay('Opening post...', 'Loading content and comments');

  try {
    const postRef = doc(db,'posts',postId);
    const pSnap = await getDoc(postRef);
    if (!pSnap.exists()) {
      postContainer.innerHTML = '<div class="card small muted">Post not found</div>';
      return;
    }

    const data = pSnap.data();
    const author = data.authorName || data.authorEmail || 'Unknown';
    const created = data.createdAt ? timeAgo(data.createdAt) : '';

    const avatarForPost = (data.photoUrl || data.authorPhotoUrl || data.authorPhoto || data.authorAvatar || data.photoURL) || 'https://www.gstatic.com/images/branding/product/2x/avatar_square_64dp.png';

    postContainer.innerHTML = `
      <div class="card">
        <div class="meta">
          <img class="avatar small" src="${escapeHTML(avatarForPost)}" alt="${escapeHTML(author)}">
          ${escapeHTML(author)} Â· <span class="muted">${created}</span>
        </div>
        <div class="title">${escapeHTML(data.title || 'Untitled')}</div>
        <div style="margin-top:0.75rem; line-height: 1.8;">${escapeHTML(data.body || '').replace(/\n/g, '<br>')}</div>
        <div class="tags">${(data.tags||[]).map(t=>`<span class="tag">${escapeHTML(t)}</span>`).join('')}</div>

        <div style="margin-top:1rem" class="actions">
          <div class="vote">
            <button id="pvUp" class="link-like">â–²</button>
            <div id="pvUpCount" class="count">${data.upvotesCount||0}</div>
            <button id="pvDown" class="link-like">â–¼</button>
            <div id="pvDownCount" class="count">${data.downvotesCount||0}</div>
          </div>
        </div>
      </div>
    `;

    document.getElementById('pvUp').addEventListener('click', ()=> handleVoteClick(postId, 1));
    document.getElementById('pvDown').addEventListener('click', ()=> handleVoteClick(postId, -1));

    if (currentUser) {
      try {
        const voteSnap = await getDoc(doc(db,'votes', `${postId}_${currentUser.uid}`));
        const prev = voteSnap.exists() ? (voteSnap.data().vote||0) : 0;
        highlightVoteButtons(prev);
      } catch(e){ console.warn('vote read failed', e); }
    } else highlightVoteButtons(0);

    // subscribe to comments (real-time)
    const commentsRef = collection(db, 'posts', postId, 'comments');
    const commentsQuery = query(commentsRef, orderBy('createdAt','asc'));
    if (commentsUnsub) commentsUnsub();
    commentsUnsub = onSnapshot(commentsQuery, (snap) => {
      commentsList.innerHTML = '';
      if (snap.empty) {
        commentsList.innerHTML = '<div class="small muted" style="padding: 1rem; text-align: center;">No comments yet</div>';
        return;
      }
      snap.forEach(docSnap => {
        const c = docSnap.data();
        const authorC = c.authorName || 'Anonymous';
        const cAvatar = (c.photoUrl || c.authorPhotoUrl || c.authorPhoto || c.photoURL) || 'https://www.gstatic.com/images/branding/product/2x/avatar_square_64dp.png';
        const cEl = document.createElement('div');
        cEl.className = 'comment';
        cEl.innerHTML = `
          <div class="meta">
            <img class="avatar small" src="${escapeHTML(cAvatar)}" alt="${escapeHTML(authorC)}">
            ${escapeHTML(authorC)} Â· <span class="muted">${c.createdAt ? timeAgo(c.createdAt) : ''}</span>
          </div>
          <div style="margin-top:0.5rem">${escapeHTML(c.body||'').replace(/\n/g, '<br>')}</div>`;
        commentsList.appendChild(cEl);
      });
    }, (error) => {
      console.error('Comments subscription error:', error);
      commentsList.innerHTML = '<div class="small muted" style="padding: 1rem;">Failed to load comments</div>';
    });

  } catch(e) {
    console.error('render post error', e);
    postContainer.innerHTML = '<div class="card small muted">Failed to load post</div>';
  } finally {
    hideLoadingOverlay();
  }
}

function highlightVoteButtons(v) {
  const up = document.getElementById('pvUp');
  const down = document.getElementById('pvDown');
  if (!up || !down) return;
  up.style.color = v === 1 ? 'var(--accent1)' : 'var(--muted)';
  down.style.color = v === -1 ? 'var(--accent1)' : 'var(--muted)';
  up.style.fontWeight = v === 1 ? '900' : '600';
  down.style.fontWeight = v === -1 ? '900' : '600';
}

/* ---------- COMMENTS: add ---------- */
clearComment.addEventListener('click', ()=> commentInput.value='');
submitComment.addEventListener('click', async () => {
  if (!currentUser) { alert('Sign in to comment'); return; }
  const text = (commentInput.value || '').trim();
  if (!text) { commentStatus.textContent = 'Type your comment'; return; }

  commentStatus.textContent = 'Posting...';
  submitComment.disabled = true;

  try {
    const commentsRef = collection(db, 'posts', currentPostId, 'comments');
    await addDoc(commentsRef, {
      body: text,
      authorId: currentUser.uid,
      authorName: currentUserProfile?.name || currentUser.email || null,
      photoUrl: currentUserProfile?.photoURL || currentUser.photoURL || null,
      createdAt: serverTimestamp(),
      upvotesCount: 0
    });
    await updateDoc(doc(db,'posts',currentPostId), { commentsCount: increment(1) });
    commentInput.value = '';
    commentStatus.textContent = 'Posted';
  } catch(e) {
    console.error('post comment failed', e);
    commentStatus.textContent = 'Failed';
  } finally {
    submitComment.disabled = false;
    setTimeout(()=>commentStatus.textContent='',1200);
  }
});

/* ---------- CREATE POST BTN ---------- */
createPostBtn.addEventListener('click', () => {
  if (!currentUser) { alert('Sign in to create a post'); return; }
  window.location.href = '/teamgalaxy/tools/create_post.html';
});

/* ---------- INITIAL ROUTING / LAUNCH ---------- */
const urlParams = new URLSearchParams(window.location.search);
const requestedPostId = urlParams.get('postId');

async function initialLaunch(){
  // show overlay
  showLoadingOverlay('Preparing your Galaxy feed...', 'Hang tight â€” connecting to the network of creators');
  if (requestedPostId) {
    feedView.style.display = 'none';
    postView.style.display = 'block';
    currentPostId = requestedPostId;
    await renderPostView(requestedPostId);
  } else {
    feedView.style.display = 'block';
    postView.style.display = 'none';
    await refreshFeed(true);
  }
  hideLoadingOverlay();
}

document.addEventListener('DOMContentLoaded', () => {
  // start initial launch (overlay shown inside function)
  initialLaunch();
});
</script>
</body>
</html>