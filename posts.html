<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TeamGalaxy — Posts</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    /* Updated theme based on your detailed color palette */
    :root {
      --bg: #0a0e17;
      --card: rgba(24, 31, 43, 0.95);
      --card-end: rgba(32, 40, 57, 0.95);
      --surface: #161b28;
      --surface-alt: #1c2236;
      --muted: #d0d0d0;
      --text: #ffffff;
      --accent1: #64c2ff; /* Cyan */
      --accent2: #fab84f; /* Gold */
      --danger: #ff5b5b; /* Red */
      --border: rgba(255, 255, 255, 0.1);
      --hover-bg: rgba(100, 194, 255, 0.1);
      --success: #4caf50;
      --icon-color: #afeafd;
    }

    body {
      margin: 0;
      font-family: 'Segoe UI', system-ui, Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
      min-height: 100vh;
      position: relative;
      overflow-x: hidden;
    }

    /* Stars background */
    body::before {
      content: "";
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-image: 
        radial-gradient(2px 2px at 10% 20%, #fff, transparent),
        radial-gradient(1px 1px at 30% 40%, #64c2ff, transparent),
        radial-gradient(1.5px 1.5px at 50% 60%, #fab84f, transparent),
        radial-gradient(1px 1px at 70% 80%, #fff, transparent),
        radial-gradient(2px 2px at 90% 10%, #64c2ff, transparent),
        radial-gradient(1px 1px at 20% 80%, #fab84f, transparent),
        radial-gradient(1.5px 1.5px at 80% 30%, #fff, transparent),
        radial-gradient(1px 1px at 60% 70%, #64c2ff, transparent),
        radial-gradient(2px 2px at 40% 10%, #fab84f, transparent),
        radial-gradient(1px 1px at 95% 50%, #fff, transparent);
      background-repeat: repeat;
      background-size: 100% 100%;
      z-index: -1;
      animation: sparkle 20s linear infinite;
    }

    @keyframes sparkle {
      0% { transform: translateY(0); }
      100% { transform: translateY(-100vh); }
    }

    /* Header styling */
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1rem 1.5rem;
      background: rgba(16, 23, 36, 0.85);
      border-bottom: 1px solid var(--border);
      box-shadow: 0 2px 4px rgba(0,0,0,0.3);
      position: relative;
      z-index: 10;
    }

    .brand {
      font-weight: 700;
      font-size: 1.5rem;
      background: linear-gradient(90deg, var(--text) 0%, var(--accent1) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .container {
      max-width: 900px;
      margin: 2rem auto;
      padding: 0 1.5rem;
      position: relative;
      z-index: 1;
    }

    /* Create Post button styling */
    .create-post-btn {
      background: var(--accent2);
      color: #000;
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 6px;
      font-weight: 600;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 2px 5px rgba(250, 184, 79, 0.3);
    }

    .create-post-btn:hover {
      background: #e9c46a; /* Slightly darker gold on hover */
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(250, 184, 79, 0.4);
    }

    .card {
      background: linear-gradient(145deg, var(--card) 0%, var(--card-end) 100%);
      border-radius: 8px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      border: 1px solid var(--border);
    }

    .meta {
      color: var(--muted);
      font-size: 0.875rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .title {
      font-size: 1.25rem;
      font-weight: 600;
      margin: 0.75rem 0;
      color: var(--text);
    }

    .snippet {
      color: var(--muted);
      margin-top: 0.5rem;
    }

    .row {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }

    button {
      cursor: pointer;
      border: 0;
      padding: 0.5rem 1rem;
      border-radius: 6px;
      font-weight: 500;
      font-size: 0.875rem;
      transition: all 0.2s ease;
    }

    .btn-primary {
      background: var(--accent1);
      color: #fff;
    }

    .btn-primary:hover {
      background: var(--accent2);
      color: #000;
    }

    .btn-ghost {
      background: transparent;
      color: var(--muted);
      border: 1px solid var(--border);
    }

    .btn-ghost:hover {
      background: var(--hover-bg);
      color: var(--accent1);
    }

    .small {
      font-size: 0.875rem;
      color: var(--muted);
    }

    .tags {
      display: flex;
      gap: 0.5rem;
      margin-top: 0.75rem;
      flex-wrap: wrap;
    }

    .tag {
      background: rgba(255, 255, 255, 0.05);
      padding: 0.25rem 0.75rem;
      border-radius: 999px;
      font-size: 0.75rem;
      color: var(--accent2);
    }

    .vote {
      display: inline-flex;
      gap: 0.25rem;
      align-items: center;
    }

    .count {
      font-weight: 600;
      min-width: 1.5rem;
      text-align: center;
    }

    .actions {
      margin-top: 1rem;
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }

    .center {
      display: flex;
      justify-content: center;
      margin: 1.5rem 0;
    }

    .link-like {
      background: transparent;
      color: var(--accent1);
      border: 0;
      cursor: pointer;
      padding: 0.25rem;
    }

    .link-like:hover {
      color: var(--accent2);
    }

    form textarea, form input {
      width: 100%;
      padding: 0.75rem;
      border-radius: 6px;
      border: 1px solid var(--border);
      background: var(--card);
      color: var(--text);
      font-family: inherit;
      box-sizing: border-box;
    }

    form textarea:focus, form input:focus {
      outline: none;
      border-color: var(--accent1);
      box-shadow: 0 0 0 3px rgba(100, 194, 255, 0.2);
    }

    .comment {
      padding: 1rem;
      border-radius: 6px;
      background: var(--card);
      margin-bottom: 0.75rem;
      border: 1px solid var(--border);
    }

    .muted {
      color: var(--muted);
    }

    /* Skeleton loading */
    .skeleton {
      background-color: #1a2232;
      background-image: linear-gradient(90deg, 
        #1a2232 0px, 
        #232e44 40px, 
        #1a2232 80px);
      background-size: 300%;
      animation: shine 1.6s infinite linear;
      border-radius: 4px;
    }

    @keyframes shine {
      0% { background-position: 100%; }
      100% { background-position: -100%; }
    }

    .skeleton-text {
      height: 0.875rem;
      margin-bottom: 0.5rem;
    }

    .skeleton-title {
      height: 1.25rem;
      margin: 0.75rem 0;
      width: 70%;
    }

    .skeleton-tag {
      height: 1.5rem;
      width: 4rem;
      border-radius: 999px;
      margin-right: 0.5rem;
      display: inline-block;
    }

    .skeleton-circle {
      width: 2.5rem;
      height: 2.5rem;
      border-radius: 50%;
    }

    /* Loading spinner */
    .spinner {
      width: 1rem;
      height: 1rem;
      border: 2px solid transparent;
      border-top: 2px solid var(--accent1);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      display: inline-block;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Vote loading state */
    .vote-loading {
      opacity: 0.7;
      pointer-events: none;
    }

    .vote-loading .spinner {
      margin-right: 0.25rem;
    }

    /* Post skeleton */
    .post-skeleton {
      padding: 1.5rem;
    }

    .post-skeleton .meta {
      margin-bottom: 1rem;
    }

    /* Comment skeleton */
    .comment-skeleton {
      padding: 1rem;
      margin-bottom: 0.75rem;
    }

    /* User info in header */
    .user-info {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      position: relative;
    }

    .avatar {
      width: 2.5rem;
      height: 2.5rem;
      border-radius: 50%;
      border: 2px solid var(--accent1);
      object-fit: cover;
      cursor: pointer;
      display: inline-block;
    }

    /* small avatar used in feed/cards */
    .avatar.small {
      width: 1.5rem;
      height: 1.5rem;
      border-radius: 50%;
      border: 1px solid var(--accent1);
      object-fit: cover;
      display:inline-block;
      vertical-align: middle;
    }

    /* Dropdown menu */
    .dropdown {
      position: absolute;
      top: 100%;
      right: 0;
      background: rgba(29, 35, 54, 0.95);
      border-radius: 6px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.2);
      z-index: 100;
      min-width: 180px;
      display: none;
    }

    .dropdown.show {
      display: block;
    }

    .dropdown-item {
      display: block;
      padding: 0.75rem 1rem;
      color: #e0e0e0;
      text-decoration: none;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }

    .dropdown-item:hover {
      background: var(--hover-bg);
      color: var(--accent1);
    }

    .dropdown-item:last-child {
      border-bottom: none;
      border-radius: 0 0 6px 6px;
    }
  </style>
</head>
<body>
  <header>
    <div class="brand">TeamGalaxy</div>
    <div id="authArea">
      <button id="signInBtn" class="btn-primary">Sign in</button>
    </div>
  </header>

  <div class="container">
    <!-- Create Post button added here -->
    <div style="text-align: center; margin-bottom: 1.5rem;">
      <button class="create-post-btn">Create Post</button>
    </div>

    <div id="feedView" style="display:none">
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <h2 style="margin:0">Latest Posts</h2>
            <div class="small muted">Sorted by publish time — newest first</div>
          </div>
          <div><button id="refreshBtn" class="btn-ghost"><i class="fas fa-sync-alt"></i> Refresh</button></div>
        </div>
      </div>

      <div id="postsList"></div>
      <div class="center"><button id="loadMoreBtn" class="btn-ghost">Load more</button></div>
    </div>

    <div id="postView" style="display:none">
      <div style="margin-bottom:1rem;"><button id="backToFeed" class="link-like"><i class="fas fa-arrow-left"></i> Back to feed</button></div>
      <div id="postContainer"></div>

      <div class="card" style="margin-top:1rem">
        <h3 style="margin:0 0 0.5rem 0">Comments</h3>
        <div id="commentsList" style="max-height:420px;overflow:auto;margin-bottom:0.5rem"></div>

        <div id="commentFormWrap">
          <div class="small muted">Add a comment</div>
          <textarea id="commentInput" placeholder="Say something..."></textarea>
          <div style="margin-top:0.5rem;display:flex;gap:0.5rem">
            <button id="submitComment" class="btn-primary">Post comment</button>
            <button id="clearComment" class="btn-ghost">Clear</button>
            <div id="commentStatus" class="small muted" style="margin-left:auto"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Dropdown menu (kept in container but positioned dynamically via JS) -->
    <div id="dropdownMenu" class="dropdown" aria-hidden="true">
      <a href="#" class="dropdown-item" id="profileLink">Profile</a>
      <a href="#" class="dropdown-item" id="settingsLink">Settings</a>
      <a href="#" class="dropdown-item" id="signOutLink">Sign Out</a>
    </div>
  </div>

  <script type="module">
    // ---------- CONFIG (do not change unless needed) ----------
    const firebaseConfig = {
      apiKey: "AIzaSyD0Yv_bQjxi2_kjzPR4XHOlaB7Sb6NRVUc",
      authDomain: "teamgalaxy-77344.firebaseapp.com",
      projectId: "teamgalaxy-77344",
      storageBucket: "teamgalaxy-77344.firebasestorage.app",
      messagingSenderId: "770256225320",
      appId: "1:770256225320:web:5a363ebd757de6cde3a11d",
      measurementId: "G-6C2W9NSNCH"
    };
    const RECAPTCHA_SITE_KEY = "6Ld395IrAAAAAIvG4gyf0vUJeI_jKOsI9XVn0jUx";

    // ---------- Firebase imports (v11.9.0) ----------
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.9.0/firebase-app.js ';
    import { initializeAppCheck, ReCaptchaV3Provider } from 'https://www.gstatic.com/firebasejs/11.9.0/firebase-app-check.js ';
    import {
      getFirestore, collection, query, orderBy, limit, startAfter, getDocs,
      doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot,
      where, serverTimestamp, runTransaction, increment
    } from 'https://www.gstatic.com/firebasejs/11.9.0/firebase-firestore.js ';
    import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/11.9.0/firebase-auth.js ';

    // ---------- initialize ----------
    const app = initializeApp(firebaseConfig);
    try {
      initializeAppCheck(app, {
        provider: new ReCaptchaV3Provider(RECAPTCHA_SITE_KEY),
        isTokenAutoRefreshEnabled: true
      });
      console.log('App Check initialized');
    } catch(e) { console.warn('App Check problem', e); }

    const db = getFirestore(app);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();

    // ---------- page-state ----------
    const postsListEl = document.getElementById('postsList');
    const feedView = document.getElementById('feedView');
    const postView = document.getElementById('postView');
    const postContainer = document.getElementById('postContainer');
    const loadMoreBtn = document.getElementById('loadMoreBtn');
    const refreshBtn = document.getElementById('refreshBtn');
    const backToFeed = document.getElementById('backToFeed');
    const signInBtn = document.getElementById('signInBtn');
    const authArea = document.getElementById('authArea');
    const commentInput = document.getElementById('commentInput');
    const submitComment = document.getElementById('submitComment');
    const commentsList = document.getElementById('commentsList');
    const commentStatus = document.getElementById('commentStatus');
    const clearComment = document.getElementById('clearComment');
    const createPostBtn = document.querySelector('.create-post-btn');
    const dropdownMenu = document.getElementById('dropdownMenu');
    const profileLink = document.getElementById('profileLink');
    const settingsLink = document.getElementById('settingsLink');
    const signOutLink = document.getElementById('signOutLink');

    let lastVisible = null;
    const PAGE_SIZE = 8;
    let currentUser = null;
    let currentUserProfile = null; // from /users/{uid} if exists
    let currentPostId = null;
    let commentsUnsub = null;
    let isVoting = false; // Track if a vote is in progress

    // ---------- small helpers ----------
    function timeAgo(ts) {
      if (!ts) return '';
      const d = ts.toDate ? ts.toDate() : new Date(ts);
      const diff = Math.floor((Date.now() - d.getTime())/1000);
      if (diff < 60) return diff + 's';
      if (diff < 3600) return Math.floor(diff/60) + 'm';
      if (diff < 86400) return Math.floor(diff/3600) + 'h';
      return Math.floor(diff/86400) + 'd';
    }
    function snippet(text, n=220){ return text.length>n ? text.slice(0,n)+'…' : text; }

    // Escape HTML to prevent XSS
    function escapeHTML(s){
      return String(s)
        .replaceAll('&','&amp;')
        .replaceAll('<','<')
        .replaceAll('>','>')
        .replaceAll('"','&quot;')
        .replaceAll("'",'&#039;');
    }

    // Generate initials from name
    function getInitials(name) {
      return name ? name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2) : 'U';
    }

    // Show skeleton loading for posts
    function renderPostSkeletons(count) {
      let skeletonsHtml = '';
      for (let i = 0; i < count; i++) {
        skeletonsHtml += `
          <div class="card post-skeleton">
            <div class="meta">
              <div class="skeleton skeleton-circle"></div>
              <div class="skeleton skeleton-text" style="width: 120px;"></div>
            </div>
            <div class="skeleton skeleton-title"></div>
            <div class="skeleton skeleton-text"></div>
            <div class="skeleton skeleton-text" style="width: 80%;"></div>
            <div class="tags">
              <span class="skeleton-tag"></span>
              <span class="skeleton-tag"></span>
            </div>
            <div class="actions">
              <div class="skeleton skeleton-text" style="width: 80px; height: 30px;"></div>
              <div style="margin-left: auto;">
                <div class="skeleton skeleton-text" style="width: 120px; height: 30px;"></div>
              </div>
            </div>
          </div>
        `;
      }
      postsListEl.innerHTML = skeletonsHtml;
    }

    // Show skeleton loading for comments
    function renderCommentSkeletons(count) {
      let skeletonsHtml = '';
      for (let i = 0; i < count; i++) {
        skeletonsHtml += `
          <div class="comment-skeleton">
            <div class="skeleton skeleton-text" style="width: 100px; margin-bottom: 0.5rem;"></div>
            <div class="skeleton skeleton-text"></div>
            <div class="skeleton skeleton-text" style="width: 80%;"></div>
          </div>
        `;
      }
      commentsList.innerHTML = skeletonsHtml;
    }

    // Show skeleton for post view
    function renderPostViewSkeleton() {
      postContainer.innerHTML = `
        <div class="card post-skeleton">
          <div class="meta">
            <div class="skeleton skeleton-circle"></div>
            <div class="skeleton skeleton-text" style="width: 120px;"></div>
          </div>
          <div class="skeleton skeleton-title" style="width: 80%;"></div>
          <div class="skeleton skeleton-text"></div>
          <div class="skeleton skeleton-text"></div>
          <div class="skeleton skeleton-text" style="width: 60%;"></div>
          <div class="tags">
            <span class="skeleton-tag"></span>
            <span class="skeleton-tag"></span>
          </div>
          <div class="actions">
            <div class="skeleton skeleton-text" style="width: 80px; height: 30px;"></div>
          </div>
        </div>
      `;

      // Also render comment skeletons
      renderCommentSkeletons(3);
    }

    // ---------- auth ----------
    async function signIn() {
      try { await signInWithPopup(auth, provider); }
      catch(e){ console.error('Signin error', e); alert('Signin failed'); }
    }
    signInBtn.addEventListener('click', signIn);

    onAuthStateChanged(auth, async (user) => {
      currentUser = user;
      if (user) {
        // try read existing users/{uid} doc for name/email
        try {
          const udocRef = doc(db,'users', user.uid);
          const uSnap = await getDoc(udocRef);
          if (uSnap.exists()) {
            currentUserProfile = uSnap.data();
          } else {
            currentUserProfile = { name: user.displayName || null, email: user.email || null, photoURL: user.photoURL || null };
          }
        } catch(e) {
          console.warn('users read failed', e);
          currentUserProfile = { name: user.displayName || null, email: user.email || null, photoURL: user.photoURL || null };
        }

        // place avatar image (use photoURL if available, else placeholder initials image)
        const avatarSrc = user.photoURL || (`https://via.placeholder.com/80/444444/ffffff?text=${encodeURIComponent(getInitials(currentUserProfile?.name || user.email))}`);
        authArea.innerHTML = `
          <div class="user-info">
            <img class="avatar" id="headerAvatar" src="${escapeHTML(avatarSrc)}" alt="Profile">
          </div>
        `;

        // Add event listener to avatar for dropdown, and position dropdown under avatar
        const avatarEl = document.getElementById('headerAvatar');
        avatarEl.addEventListener('click', (e) => {
          e.stopPropagation();

          // toggle
          const willShow = !dropdownMenu.classList.contains('show');
          dropdownMenu.classList.remove('show');
          dropdownMenu.style.position = 'fixed'; // use fixed so it doesn't depend on container positioning
          dropdownMenu.style.right = 'auto';

          if (willShow) {
            // compute coords
            const rect = avatarEl.getBoundingClientRect();
            // estimate menu width (fallback to 200)
            const estimatedWidth = dropdownMenu.offsetWidth || 200;
            // position so right edge of menu aligns with right edge of avatar
            let left = Math.round(rect.right - estimatedWidth);
            if (left < 8) left = 8;
            const top = Math.round(rect.bottom + 8);
            dropdownMenu.style.left = left + 'px';
            dropdownMenu.style.top = top + 'px';
            dropdownMenu.classList.add('show');
            dropdownMenu.setAttribute('aria-hidden','false');
          } else {
            dropdownMenu.classList.remove('show');
            dropdownMenu.setAttribute('aria-hidden','true');
          }
        });
      } else {
        authArea.innerHTML = `<button id="signInBtn" class="btn-primary">Sign in</button>`;
        document.getElementById('signInBtn').addEventListener('click', signIn);
        currentUserProfile = null;
      }
      // re-render vote buttons to reflect current user's votes if viewing feed/post
      if (currentPostId) renderPostView(currentPostId);
      else { refreshFeed(true); }
    });

    // Close dropdown when clicking outside
    document.addEventListener('click', (e) => {
      if (!dropdownMenu.contains(e.target) && !e.target.classList.contains('avatar') && !e.target.id === 'headerAvatar') {
        dropdownMenu.classList.remove('show');
        dropdownMenu.setAttribute('aria-hidden','true');
      }
    });

    // Dropdown item event listeners
    profileLink.addEventListener('click', (e) => {
      e.preventDefault();
      alert('Navigate to profile page');
      dropdownMenu.classList.remove('show');
    });

    settingsLink.addEventListener('click', (e) => {
      e.preventDefault();
      alert('Navigate to settings page');
      dropdownMenu.classList.remove('show');
    });

    signOutLink.addEventListener('click', (e) => {
      e.preventDefault();
      signOut(auth);
      dropdownMenu.classList.remove('show');
    });

    // Create Post button functionality
    createPostBtn.addEventListener('click', () => {
      if (!currentUser) {
        alert('Sign in to create a post');
        return;
      }
      window.location.href = '/teamgalaxy/tools/create_post.html';
    });

    // ---------- routing: if ?postId=... show single post view ----------
    const urlParams = new URLSearchParams(window.location.search);
    const requestedPostId = urlParams.get('postId');

    if (requestedPostId) {
      // show single post page
      feedView.style.display = 'none';
      postView.style.display = 'block';
      currentPostId = requestedPostId;
      renderPostView(requestedPostId);
    } else {
      feedView.style.display = 'block';
      postView.style.display = 'none';
      refreshFeed(true);
    }

    // ---------- FEED: fetch posts (paged) ----------
    async function refreshFeed(reset=false) {
      if (reset) {
        lastVisible = null;
        renderPostSkeletons(4); // Show 4 skeleton loaders
      }

      // query
      const postsRef = collection(db, 'posts');
      let q;
      if (!lastVisible) q = query(postsRef, orderBy('createdAt','desc'), limit(PAGE_SIZE));
      else q = query(postsRef, orderBy('createdAt','desc'), startAfter(lastVisible), limit(PAGE_SIZE));

      try {
        const snaps = await getDocs(q);
        if (snaps.docs.length === 0) {
          if (!lastVisible) postsListEl.innerHTML = '<div class="card small muted">No posts yet — be the first.</div>';
          loadMoreBtn.style.display = 'none';
          return;
        }

        postsListEl.innerHTML = ''; // Clear skeletons
        for (const d of snaps.docs) {
          renderPostCard(d.id, d.data());
        }
        lastVisible = snaps.docs[snaps.docs.length - 1];
        // show load more only if returned PAGE_SIZE items
        loadMoreBtn.style.display = snaps.docs.length === PAGE_SIZE ? 'inline-block' : 'none';
      } catch(e){
        console.error('feed fetch error', e);
        postsListEl.innerHTML = '<div class="card small muted">Failed to load posts</div>';
      }
    }

    refreshBtn.addEventListener('click', ()=> {
      lastVisible=null;
      refreshFeed(true);
    });

    loadMoreBtn.addEventListener('click', ()=> refreshFeed(false));

    // Helper to choose avatar for posts/comments
    function avatarHtmlFor(author, data) {
      // Check for photoUrl first, then other possible fields
      const photo = (data && (data.photoUrl || data.authorPhotoUrl || data.authorPhoto || data.photoURL || data.authorAvatar)) || null;
      // Google default avatar fallback (public-ish)
      const googleDefault = ' https://www.gstatic.com/images/branding/product/2x/avatar_square_64dp.png ';
      if (photo) {
        return `<img class="avatar small" src="${escapeHTML(photo)}" alt="${escapeHTML(author)}">`;
      } else {
        // Use googleDefault if you want a consistent "google-like" fallback
        return `<img class="avatar small" src="${googleDefault}" alt="avatar">`;
      }
    }

    function renderPostCard(postId, data) {
      const el = document.createElement('div');
      el.className = 'card';
      const author = data.authorName || data.authorEmail || 'Unknown';
      const created = data.createdAt ? timeAgo(data.createdAt) : '';

      // build avatar (image if available else google default image)
      const avatarHtml = avatarHtmlFor(author, data);

      el.innerHTML = `
        <div class="meta">
          ${avatarHtml}
          <span style="margin-left:8px">${escapeHTML(author)} · <span class="muted">${created}</span></span>
        </div>
        <div class="title">${escapeHTML(data.title || 'Untitled')}</div>
        <div class="snippet">${escapeHTML(snippet(data.body || ''))}</div>
        <div class="tags">${(data.tags || []).map(t => `<span class="tag">${escapeHTML(t)}</span>`).join('')}</div>
        <div class="actions">
          <div class="vote">
            <button class="link-like upvote" data-id="${postId}">▲</button>
            <div class="count" id="up_${postId}">${data.upvotesCount||0}</div>
            <button class="link-like downvote" data-id="${postId}">▼</button>
            <div class="count" id="down_${postId}">${data.downvotesCount||0}</div>
          </div>
          <div style="margin-left:auto">
            <button class="btn-ghost commentBtn" data-id="${postId}"><i class="far fa-comment"></i> Comments (${data.commentsCount||0})</button>
            <button class="btn-primary viewBtn" data-id="${postId}">View Post</button>
          </div>
        </div>
      `;
      postsListEl.appendChild(el);

      // attach handlers
      el.querySelector('.viewBtn').addEventListener('click', ()=> openPostPage(postId));
      el.querySelector('.commentBtn').addEventListener('click', ()=> openPostPage(postId));
      el.querySelector('.upvote').addEventListener('click', ()=> handleVoteClick(postId, 1));
      el.querySelector('.downvote').addEventListener('click', ()=> handleVoteClick(postId, -1));
    }

    function openPostPage(postId) {
      // navigate to same file with ?postId
      const base = window.location.href.split('?')[0];
      window.location.href = base + '?postId=' + postId;
    }

    // ---------- Voting logic (safe per-user using 'votes' collection) ----------
    async function handleVoteClick(postId, delta) {
      if (isVoting) return; // Prevent multiple simultaneous votes
      if (!currentUser) { alert('Sign in to vote'); return; }

      const uid = currentUser.uid;
      const voteDocRef = doc(db, 'votes', `${postId}_${uid}`);
      const postRef = doc(db, 'posts', postId);

      // Set voting state and update UI
      isVoting = true;
      const voteButtons = document.querySelectorAll(`.upvote[data-id="${postId}"], .downvote[data-id="${postId}"]`);
      voteButtons.forEach(btn => {
        btn.classList.add('vote-loading');
        btn.innerHTML = delta === 1 && btn.classList.contains('upvote') ?
          '<span class="spinner"></span> ▲' :
          (delta === -1 && btn.classList.contains('downvote') ?
          '<span class="spinner"></span> ▼' : btn.innerHTML);
      });

      try {
        await runTransaction(db, async (tx) => {
          const voteSnap = await tx.get(voteDocRef);
          const postSnap = await tx.get(postRef);
          if (!postSnap.exists()) throw 'Post not found';
          let up = postSnap.data().upvotesCount || 0;
          let down = postSnap.data().downvotesCount || 0;

                    if (!voteSnap.exists()) {
            // create vote
            tx.set(voteDocRef, { postId, userId: uid, vote: delta, createdAt: serverTimestamp() });
            if (delta === 1) up++; else down++;
          } else {
            const prev = voteSnap.data().vote || 0;
            if (prev === delta) {
              // undo
              tx.delete(voteDocRef);
              if (delta === 1) up = Math.max(0, up-1); else down = Math.max(0, down-1);
            } else {
              // switch
              tx.update(voteDocRef, { vote: delta, updatedAt: serverTimestamp() });
              if (delta === 1) { up++; down = Math.max(0, down-1); }
              else { down++; up = Math.max(0, up-1); }
            }
          }
          tx.update(postRef, { upvotesCount: up, downvotesCount: down });
        });
        // update UI quickly by refetching either the single post view or the feed counts
        if (currentPostId === postId) renderPostView(postId);
        else refreshFeed(true);
      } catch(e) {
        console.error('vote failed', e);
        alert('Vote failed');
      } finally {
        isVoting = false;
        // Reset UI state
        voteButtons.forEach(btn => {
          btn.classList.remove('vote-loading');
          btn.innerHTML = btn.classList.contains('upvote') ? '▲' : '▼';
        });
      }
    }

    // ---------- POST VIEW (single post + comments) ----------
    backToFeed.addEventListener('click', ()=> {
      const base = window.location.href.split('?')[0];
      window.location.href = base; // go back to feed
    });

    async function renderPostView(postId) {
      currentPostId = postId;
      // Show skeleton while loading
      renderPostViewSkeleton();

      try {
        const postRef = doc(db,'posts',postId);
        const pSnap = await getDoc(postRef);
        if (!pSnap.exists()) {
          postContainer.innerHTML = '<div class="card small muted">Post not found</div>';
          return;
        }

        const data = pSnap.data();
        const author = data.authorName || data.authorEmail || 'Unknown';
        const created = data.createdAt ? timeAgo(data.createdAt) : '';

        // Use image avatar if present in post data; fallback to google default
        const avatarForPost = (data.photoUrl || data.authorPhotoUrl || data.authorPhoto || data.authorAvatar || data.photoURL) || 'https://www.gstatic.com/images/branding/product/2x/avatar_square_64dp.png ';

        postContainer.innerHTML = `
          <div class="card">
            <div class="meta">
              <img class="avatar small" src="${escapeHTML(avatarForPost)}" alt="${escapeHTML(author)}">
              ${escapeHTML(author)} · <span class="muted">${created}</span>
            </div>
            <div class="title">${escapeHTML(data.title || 'Untitled')}</div>
            <div style="margin-top:0.75rem; line-height: 1.8;">${escapeHTML(data.body || '').replace(/\n/g, '<br>')}</div>
            <div class="tags">${(data.tags||[]).map(t=>`<span class="tag">${escapeHTML(t)}</span>`).join('')}</div>

            <div style="margin-top:1rem" class="actions">
              <div class="vote">
                <button id="pvUp" class="link-like">▲</button>
                <div id="pvUpCount" class="count">${data.upvotesCount||0}</div>
                <button id="pvDown" class="link-like">▼</button>
                <div id="pvDownCount" class="count">${data.downvotesCount||0}</div>
              </div>
            </div>
          </div>
        `;

        // bind vote handlers and show user's current vote visually
        document.getElementById('pvUp').addEventListener('click', ()=> handleVoteClick(postId, 1));
        document.getElementById('pvDown').addEventListener('click', ()=> handleVoteClick(postId, -1));

        // fetch and highlight user's vote (if logged in)
        if (currentUser) {
          try {
            const voteSnap = await getDoc(doc(db,'votes', `${postId}_${currentUser.uid}`));
            const prev = voteSnap.exists() ? (voteSnap.data().vote||0) : 0;
            highlightVoteButtons(prev);
          } catch(e){ console.warn('vote read failed', e); }
        } else highlightVoteButtons(0);

        // subscribe to comments in real-time
        const commentsRef = collection(db, 'posts', postId, 'comments');
        const commentsQuery = query(commentsRef, orderBy('createdAt','asc'));
        commentsUnsub = onSnapshot(commentsQuery, (snap) => {
          commentsList.innerHTML = '';
          if (snap.empty) {
            commentsList.innerHTML = '<div class="small muted" style="padding: 1rem; text-align: center;">No comments yet</div>';
            return;
          }

          snap.forEach(docSnap => {
            const c = docSnap.data();
            const authorC = c.authorName || 'Anonymous';
            // choose avatar for comment: check comment data for photo fields, prioritizing photoUrl
            const cAvatar = (c.photoUrl || c.authorPhotoUrl || c.authorPhoto || c.photoURL) || 'https://www.gstatic.com/images/branding/product/2x/avatar_square_64dp.png ';
            const cEl = document.createElement('div');
            cEl.className = 'comment';
            cEl.innerHTML = `
              <div class="meta">
                <img class="avatar small" src="${escapeHTML(cAvatar)}" alt="${escapeHTML(authorC)}">
                ${escapeHTML(authorC)} · <span class="muted">${c.createdAt ? timeAgo(c.createdAt) : ''}</span>
              </div>
              <div style="margin-top:0.5rem">${escapeHTML(c.body||'').replace(/\n/g, '<br>')}</div>`;
            commentsList.appendChild(cEl);
          });
        }, (error) => {
          console.error('Comments subscription error:', error);
          commentsList.innerHTML = '<div class="small muted" style="padding: 1rem;">Failed to load comments</div>';
        });

      } catch(e) {
        console.error('render post error', e);
        postContainer.innerHTML = '<div class="card small muted">Failed to load post</div>';
      }
    }

    function highlightVoteButtons(v) {
      const up = document.getElementById('pvUp');
      const down = document.getElementById('pvDown');
      if (!up || !down) return;

      up.style.color = v === 1 ? 'var(--accent1)' : 'var(--muted)';
      down.style.color = v === -1 ? 'var(--accent1)' : 'var(--muted)';
      up.style.fontWeight = v === 1 ? '900' : '600';
      down.style.fontWeight = v === -1 ? '900' : '600';
    }

    // ---------- comments: add ----------
    clearComment.addEventListener('click', ()=> commentInput.value='');

    submitComment.addEventListener('click', async () => {
      if (!currentUser) { alert('Sign in to comment'); return; }
      const text = (commentInput.value || '').trim();
      if (!text) { commentStatus.textContent = 'Type your comment'; return; }

      commentStatus.textContent = 'Posting...';
      submitComment.disabled = true;

      try {
        const commentsRef = collection(db, 'posts', currentPostId, 'comments');
        await addDoc(commentsRef, {
          body: text,
          authorId: currentUser.uid,
          authorName: currentUserProfile?.name || currentUser.email || null,
          photoUrl: currentUserProfile?.photoURL || currentUser.photoURL || null, // Add photoUrl to comment
          createdAt: serverTimestamp(),
          upvotesCount: 0
        });
        // increment commentsCount on post
        await updateDoc(doc(db,'posts',currentPostId), { commentsCount: increment(1) });
        commentInput.value = '';
        commentStatus.textContent = 'Posted';
      } catch(e) {
        console.error('post comment failed', e);
        commentStatus.textContent = 'Failed';
      } finally {
        submitComment.disabled = false;
        setTimeout(()=>commentStatus.textContent='',1200);
      }
    });

    // ---------- initial render for feed view ----------
    function showFeed() {
      feedView.style.display = 'block';
      postView.style.display = 'none';
    }
    function showPost() {
      feedView.style.display = 'none';
      postView.style.display = 'block';
    }
    // ensure proper view shown depending on currentPostId
    if (currentPostId) { showPost(); } else { showFeed(); }

  </script>
</body>
</html>